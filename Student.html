<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - EdUTEND</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@8.2.3/build/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <!-- Firebase SDK (App + Firestore) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/modules/firebase.js"></script>
    <style>
        .report-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .report-section h5 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        .stat-label {
            font-weight: 500;
            color: #666;
        }
        .stat-value {
            font-weight: 600;
            color: #333;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .report-table th,
        .report-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .report-table th {
            background: #f5f5f5;
            font-weight: 600;
            color: #333;
        }
        .report-table tr:hover {
            background: #f9f9f9;
        }
        .report-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .report-actions .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .report-actions .btn:hover {
            background: #0056b3;
        }
        .report-actions .btn i {
            font-size: 16px;
        }

        /* Mobile-specific styles */
        .mobile-device .scanner-container {
            padding: 10px;
        }

        .mobile-device .scanner-viewport {
            position: relative;
            width: 100%;
            height: 60vh;
            min-height: 300px;
            max-height: 500px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .mobile-device .scanner-viewport video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .mobile-device .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .mobile-device .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 2px solid #00ff00;
            border-radius: 12px;
        }

        .mobile-device .scanner-frame .corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #00ff00;
        }

        .mobile-device .scanner-frame .corner.top-left {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }

        .mobile-device .scanner-frame .corner.top-right {
            top: -3px;
            right: -3px;
            border-left: none;
            border-bottom: none;
        }

        .mobile-device .scanner-frame .corner.bottom-left {
            bottom: -3px;
            left: -3px;
            border-right: none;
            border-top: none;
        }

        .mobile-device .scanner-frame .corner.bottom-right {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }

        .mobile-device .scanning-line {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: scanning 2s linear infinite;
        }

        @keyframes scanning {
            0% { transform: translate(-50%, -50%) translateY(-100px); }
            100% { transform: translate(-50%, -50%) translateY(100px); }
        }

        .mobile-device .scanner-instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-align: center;
            font-size: 14px;
        }

        .mobile-device .scanner-instructions i {
            margin-right: 8px;
        }

        .mobile-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .mobile-device .mobile-controls {
            display: flex;
        }

        .mobile-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            justify-content: center;
        }

        .mobile-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .mobile-btn:active {
            transform: translateY(0);
        }

        .mobile-btn i {
            font-size: 16px;
        }

        /* Orientation lock styles */
        .orientation-locked {
            overflow: hidden;
        }

        .orientation-locked .scanner-viewport {
            height: 100vh;
            max-height: none;
        }

        /* Fullscreen styles */
        .scanner-container:fullscreen {
            background: black;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .scanner-container:fullscreen .scanner-viewport {
            width: 100vw;
            height: 100vh;
            max-height: none;
            border-radius: 0;
        }

        .scanner-container:fullscreen .scanner-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        /* Touch-friendly button sizes */
        .mobile-device .btn {
            min-height: 44px;
            min-width: 44px;
            padding: 12px 20px;
        }

        /* Mobile status indicator */
        .mobile-device .scanner-status {
            text-align: center;
            margin-bottom: 15px;
        }

        .mobile-device .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            font-size: 14px;
        }

        .mobile-device .scanner-info {
            margin-top: 8px;
            text-align: center;
            color: #666;
            font-size: 12px;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .mobile-device .scanner-frame {
                width: 200px;
                height: 200px;
            }
            
            .mobile-device .scanner-instructions {
                font-size: 12px;
                padding: 8px 16px;
            }
            
            .mobile-btn {
                min-width: 100px;
                padding: 10px 14px;
                font-size: 12px;
            }
        }

        @media (max-width: 360px) {
            .mobile-device .scanner-frame {
                width: 180px;
                height: 180px;
            }
            
            .mobile-controls {
                gap: 8px;
            }
            
            .mobile-btn {
                min-width: 80px;
                padding: 8px 12px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body class="admin-dashboard">
    <div class="sidebar nav" id="sidebar">
        <div class="sidebar-header">
            <h2>Student Dashboard - EdUTEND</h2>
        </div>
        <nav class="mt-6">
            <a href="#" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded active" data-target="dashboard">
                <i class="mr-3 fas fa-tachometer-alt"></i>
                <span data-translate="nav-dashboard">Dashboard</span>
            </a>
            <a href="#" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded" data-target="profile">
                <i class="mr-3 fas fa-user"></i>
                <span data-translate="nav-profile">Profile</span>
            </a>
            <a href="#" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded" data-target="calendar">
                <i class="mr-3 fas fa-calendar"></i>
                <span data-translate="nav-calendar">Calendar</span>
            </a>
            <a href="studentc.html" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded" data-target="courses">
                <i class="mr-3 fas fa-book"></i>
                <span data-translate="nav-courses">Courses</span>
            </a>
            <a href="#" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded" data-target="qrcodescanner">
                <i class="mr-3 fas fa-qrcode"></i>
                <span data-translate="nav-qr-scanner">Scanner</span>
            </a>
            <a href="#" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded" data-target="pinenter">
                <i class="mr-3 fas fa-key"></i>
                <span data-translate="nav-pin-entry">Pin</span>
            </a>
            <a href="#" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded" data-target="attendance">
                <i class="mr-3 fas fa-check"></i>
                <span data-translate="nav-attendance">Attendance</span>
            </a>
            <a href="#" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded" data-target="reports">
                <i class="mr-3 fas fa-chart-bar"></i>
                <span data-translate="nav-reports">Reports</span>
            </a>
            <a href="#" class="student-nav-item block px-4 text-gray-700 hover:bg-indigo-50 hover:text-indigo600 rounded" data-target="settings">
                <i class="mr-3 fas fa-cog"></i>
                <span data-translate="nav-settings">Settings</span>
            </a>
        </nav>
    </div>

    <div class="main-content">
        <header class="header">

        <div class="toggle">
          <button id="sidebar-toggle" class="toggle-btn" aria-label="Open Menu">
            <i class="fas fa-bars"></i>
          </button>
        </div>
        

        <div class="sidebar2" id="sidebar2">
          <div class="sidebar-header">
            <div class="sidebar-title">
              <h2 class="h1">Student Dashboard</h2>
              <p class="h2">EdUTEND System</p>
            </div>
            <button id="sidebar-close" class="sidebar-close-btn" aria-label="Close Menu">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <nav class="mobile-nav">
            <a href="#" class="student-nav-item active" data-target="dashboard">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
            <a href="#" class="student-nav-item" data-target="profile">
              <i class="fas fa-user"></i>
              <span>Profile</span>
            </a>
            <a href="#" class="student-nav-item" data-target="calendar">
              <i class="fas fa-calendar"></i>
              <span>Calendar</span>
            </a>
            <a href="studentc.html" class="student-nav-item">
              <i class="fas fa-book"></i>
              <span>Courses</span>
            </a>
            <a href="#" class="student-nav-item" data-target="qrcodescanner">
              <i class="fas fa-qrcode"></i>
              <span>Scanner</span>
            </a>
            <a href="#" class="student-nav-item" data-target="pinenter">
              <i class="fas fa-key"></i>
              <span>Pin</span>
            </a>
            <a href="#" class="student-nav-item" data-target="attendance">
              <i class="fas fa-check"></i>
              <span>Attendance</span>
            </a>
            <a href="#" class="student-nav-item" data-target="reports">
              <i class="fas fa-chart-bar"></i>
              <span>Reports</span>
            </a>
            <a href="#" class="student-nav-item" data-target="settings">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
            <a href="index.html" class="student-nav-item logout-item">
              <i class="fas fa-sign-out-alt"></i>
              <span data-translate="logout">Logout</span>
            </a>
          </nav>
          

          <div class="mobile-user-info">
            <div class="user-avatar">ST</div>
            <div class="user-details">
              <p class="user-name">Student</p>
              <p class="user-role">Student Member</p>
            </div>
          </div>
        </div>
        

        <div class="user-info">
          <span data-translate="welcome-student">Welcome, Student</span>
        </div>
        <div class="header-actions">
            <a href="index.html" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i>
                <span class="logout-text" data-translate="logout">Logout</span>
            </a>
        </div>
        </header>



        <div id="dashboard" class="section">
            <h3 data-translate="dashboard-overview">Dashboard Overview</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <i class="fas fa-chalkboard-teacher stat-icon"></i>
                    <div class="stat-content">
                        <div class="stat-label" data-translate="dashboard-total-lecturers">Total Lecturers</div>
                        <div class="stat-value">3</div>
                    </div>
                </div>
                <div class="stat-box">
                    <i class="fas fa-book stat-icon"></i>
                    <div class="stat-content">
                        <div class="stat-label" data-translate="dashboard-total-courses">Total Courses</div>
                        <div class="stat-value">4</div>
                    </div>
                </div>
                <div class="stat-box">
                    <i class="fas fa-check-circle stat-icon"></i>
                    <div class="stat-content">
                        <div class="stat-label" data-translate="dashboard-total-attendance">Total Attendance</div>
                        <div class="stat-value">2</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="profile" class="section" style="display: none;">
            <h3 id="profile-title" data-translate="profile-title">Student Profile</h3>
            <div class="profile-card">
                <div class="profile-header">
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="identity">
                        <h4 id="student-name">Bukho Skweza</h4>
                        <div class="muted" id="student-id"><span data-translate="profile-student-id">Student ID:</span> 231031149</div>
                    </div>
                </div>
                
                <div class="profile-details">
                    <div class="detail">
                        <span data-translate="profile-email">Email:</span>
                        <strong id="student-email">bukho@example.com</strong>
                    </div>
                    <div class="detail">
                        <span data-translate="profile-year">Year:</span>
                        <strong id="student-year">2nd Year</strong>
                    </div>
                    <div class="detail">
                        <span data-translate="profile-course">Course:</span>
                        <strong id="student-course">Info Tech & App Dev</strong>
                    </div>
                    <div class="detail">
                        <span data-translate="profile-department">Department:</span>
                        <strong id="student-dept">App Dev</strong>
                    </div>
                    <div class="detail">
                        <span data-translate="profile-phone">Phone:</span>
                        <strong id="student-phone">+27 73 303 4777</strong>
                    </div>
                    <div class="detail">
                        <span data-translate="profile-address">Address:</span>
                        <strong id="student-address">Quigney, E.L</strong>
                    </div>
                </div>

                <div class="profile-bio">
                    <h5 data-translate="profile-bio">Bio</h5>
                    <p id="student-bio">A dedicated student pursuing App Dev with a passion for technology and innovation.</p>
                </div>

                <div class="profile-actions">
                    <button class="btn" id="edit-profile-btn" data-translate="profile-edit">Edit Profile</button>
                </div>
            </div>

            <div class="settings-group mt-16" id="edit-profile-form" style="display: none;">
                <h4 data-translate="profile-edit">Edit Profile</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="edit-name" data-translate="profile-full-name">Full Name</label>
                        <input type="text" id="edit-name" placeholder="Enter your full name" data-translate-placeholder="profile-name-placeholder" />
                    </div>
                    <div class="form-field">
                        <label for="edit-email" data-translate="profile-email">Email</label>
                        <input type="email" id="edit-email" placeholder="Enter your email" data-translate-placeholder="profile-email-placeholder" />
                    </div>
                    <div class="form-field">
                        <label for="edit-phone" data-translate="profile-phone">Phone</label>
                        <input type="tel" id="edit-phone" placeholder="Enter your phone number" data-translate-placeholder="profile-phone-placeholder" />
                    </div>
                    <div class="form-field">
                        <label for="edit-address" data-translate="profile-address">Address</label>
                        <input type="text" id="edit-address" placeholder="Enter your address" data-translate-placeholder="profile-address-placeholder" />
                    </div>
                    <div class="form-field full-width">
                        <label for="edit-bio" data-translate="profile-bio">Bio</label>
                        <textarea id="edit-bio" rows="3" placeholder="Tell us about yourself..." data-translate-placeholder="profile-bio-placeholder"></textarea>
                    </div>
                    <div class="form-field">
                        <label for="edit-password" data-translate="profile-new-password">New Password</label>
                        <input type="password" id="edit-password" placeholder="Enter new password (optional)" data-translate-placeholder="profile-password-placeholder" />
                    </div>
                    <div class="form-field">
                        <label for="edit-confirm-password" data-translate="profile-confirm-password">Confirm Password</label>
                        <input type="password" id="edit-confirm-password" placeholder="Confirm new password" data-translate-placeholder="profile-confirm-password-placeholder" />
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="save-profile-btn" data-translate="profile-save">Save Changes</button>
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="cancel-edit-btn" data-translate="cancel">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="calendar" class="section" style="display: none;">
            <h3 id="calendar-title" data-translate="calendar-title">Academic Calendar</h3>
            <div class="calendar">
                <div class="header">
                    <div class="month" id="calendar-month" data-translate="calendar-month-display">January 2025</div>
                    <div class="btns">
                        <button class="btn" id="prev-month">‹</button>
                        <button class="btn" id="next-month">›</button>
                    </div>
                </div>
                <div class="weekdays">
                    <div class="day" data-translate="calendar-sun">Sun</div>
                    <div class="day" data-translate="calendar-mon">Mon</div>
                    <div class="day" data-translate="calendar-tue">Tue</div>
                    <div class="day" data-translate="calendar-wed">Wed</div>
                    <div class="day" data-translate="calendar-thu">Thu</div>
                    <div class="day" data-translate="calendar-fri">Fri</div>
                    <div class="day" data-translate="calendar-sat">Sat</div>
                </div>
                <div class="days" id="calendar-days"></div>
            </div>

            <div class="settings-group mt-16">
                <h4 data-translate="calendar-add-event">Add Event</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="event-title" data-translate="calendar-event-title">Event Title</label>
                        <input type="text" id="event-title" placeholder="Enter event title" data-translate-placeholder="calendar-event-title-placeholder" />
                    </div>
                    <div class="form-field">
                        <label for="event-date" data-translate="calendar-event-date">Date</label>
                        <input type="date" id="event-date" />
                    </div>
                    <div class="form-field">
                        <label for="event-time" data-translate="calendar-event-time">Time</label>
                        <input type="time" id="event-time" />
                    </div>
                    <div class="form-field">
                        <label for="event-type" data-translate="calendar-event-type">Type</label>
                        <select id="event-type">
                            <option value="assignment" data-translate="calendar-assignment">Assignment</option>
                            <option value="exam" data-translate="calendar-exam">Exam</option>
                            <option value="lecture" data-translate="calendar-lecture">Lecture</option>
                            <option value="tutorial" data-translate="calendar-tutorial">Tutorial</option>
                            <option value="personal" data-translate="calendar-personal">Personal</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="event-course" data-translate="calendar-event-course">Course</label>
                        <select id="event-course">
                            <option value="" data-translate="calendar-select-course">Select Course</option>
                        </select>
                    </div>
                    <div class="form-field full-width">
                        <label for="event-notes" data-translate="calendar-event-notes">Notes</label>
                        <textarea id="event-notes" rows="2" placeholder="Additional notes..." data-translate-placeholder="calendar-event-notes-placeholder"></textarea>
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="add-event-btn" data-translate="calendar-add-event-btn">Add Event</button>
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="clear-event-form-btn" data-translate="calendar-clear-btn">Clear</button>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h4 data-translate="calendar-events">My Events</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="event-filter-type" data-translate="calendar-filter-type">Filter by Type</label>
                        <select id="event-filter-type">
                            <option value="all" data-translate="calendar-all-types">All Types</option>
                            <option value="assignment" data-translate="calendar-assignment">Assignment</option>
                            <option value="exam" data-translate="calendar-exam">Exam</option>
                            <option value="lecture" data-translate="calendar-lecture">Lecture</option>
                            <option value="tutorial" data-translate="calendar-tutorial">Tutorial</option>
                            <option value="personal" data-translate="calendar-personal">Personal</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="event-filter-course" data-translate="calendar-filter-course">Filter by Course</label>
                        <select id="event-filter-course">
                            <option value="all" data-translate="calendar-all-courses">All Courses</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="apply-event-filter-btn" data-translate="calendar-apply-filter">Apply Filter</button>
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="export-events-btn" data-translate="reports-download">Export Events</button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th data-translate="calendar-table-date">Date</th>
                                <th data-translate="calendar-table-time">Time</th>
                                <th data-translate="calendar-table-title">Title</th>
                                <th data-translate="calendar-table-type">Type</th>
                                <th data-translate="calendar-table-course">Course</th>
                                <th data-translate="calendar-table-notes">Notes</th>
                                <th data-translate="calendar-table-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="events-tbody">
                            <tr><td colspan="7" class="centered-cell" data-translate="calendar-no-events">No events found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="qrcodescanner" class="section" style="display: none;">
            <h3 id="qr-scanner-title" data-translate="qr-scanner-title">QR Code Scanner</h3>
            

            <div class="settings-group mb-16">
                <h4 data-translate="qr-select-course">Select Course for Attendance</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="scanner-course-select" data-translate="qr-course">Course</label>
                        <select id="scanner-course-select">
                            <option value="" data-translate="qr-select-course-placeholder">Select a course to scan QR code for</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="refresh-courses-btn" data-translate="qr-refresh-courses">
                            <i class="fas fa-sync-alt"></i>
                            <span data-translate="qr-refresh-courses">Refresh Courses</span>
                        </button>
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="check-qr-status-btn" style="background: #17a2b8; margin-left: 10px;" data-translate="qr-check-status">
                            <i class="fas fa-search"></i>
                            <span data-translate="qr-check-status">Check QR Status</span>
                        </button>
                    </div>
                </div>
                

                <div class="course-info" id="course-info" style="display: none;">
                    <div class="info-card">
                        <h5 id="selected-course-name" data-translate="scanner-course-name">Course Name</h5>
                        <p id="selected-course-code" data-translate="scanner-course-code">Course Code</p>
                        <div class="course-stats">
                            <span class="stat">
                                <i class="fas fa-calendar"></i>
                                <span id="course-sessions">0</span> <span data-translate="scanner-sessions">sessions</span>
                            </span>
                            <span class="stat">
                                <i class="fas fa-check-circle"></i>
                                <span id="course-attendance">0%</span> <span data-translate="scanner-attendance">attendance</span>
                            </span>
                            <span class="stat">
                                <i class="fas fa-qrcode"></i>
                                <span id="active-qr-codes">0</span> <span data-translate="scanner-active-qr-codes">active QR codes</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>


            <div class="settings-group mb-16" id="active-qr-status" style="display: none;">
                <h4 data-translate="scanner-active-qr-status">Active QR Codes Status</h4>
                <div class="qr-status-grid" id="qr-status-grid">

                </div>
            </div>

            <div class="scanner-container">
                <div class="scanner-header">
                    <div class="scanner-status">
                        <div class="status-indicator" id="scanner-status" role="status" aria-live="polite">
                            <i class="fas fa-circle" aria-hidden="true"></i>
                            <span id="status-text" data-translate="scanner-ready-to-scan">Ready to Scan</span>
                        </div>
                        <div class="scanner-info" id="scanner-info" style="display: none;">
                            <small id="scanner-details" data-translate="scanner-camera-info">Camera will be activated when you start scanning</small>
                        </div>
                    </div>
                    <div class="scanner-controls">
                        <button class="btn" id="start-scan-btn" aria-label="Start QR Code Scanner">
                            <i class="fas fa-camera"></i>
                            <span data-translate="qr-scan-now">Start Scanner</span>
                        </button>
                        <button class="btn" id="stop-scan-btn" style="display: none;" aria-label="Stop QR Code Scanner">
                            <i class="fas fa-stop"></i>
                            <span data-translate="qr-stop-scanner">Stop Scanner</span>
                        </button>
                    </div>
                </div>

                <div class="scanner-viewport" role="img" aria-label="QR Code Scanner Viewport">
                    <video id="scanner-video" autoplay playsinline muted aria-label="Camera feed for QR code scanning"></video>
                    <canvas id="scanner-canvas" style="display: none;" aria-hidden="true"></canvas>
                    <div class="scanner-overlay">
                        <div class="scanner-frame" aria-label="QR code scanning frame">
                            <div class="corner top-left"></div>
                            <div class="corner top-right"></div>
                            <div class="corner bottom-left"></div>
                            <div class="corner bottom-right"></div>
                        </div>
                        <div class="scanning-line" aria-hidden="true"></div>
                        <div class="scanner-instructions">
                            <p><i class="fas fa-qrcode" aria-hidden="true"></i> <span data-translate="scanner-position-qr">Position QR code within the frame</span></p>
                        </div>
                    </div>
                </div>

                <div class="scanner-results" id="scanner-results" style="display: none;">
                    <div class="result-card">
                        <div class="result-header">
                            <h4 data-translate="scanner-scan-result">Scan Result</h4>
                            <button class="btn btn-small" id="close-result-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="result-content">
                            <div class="result-item">
                                <span class="label" data-translate="scanner-label-pin">PIN:</span>
                                <span class="value" id="scanned-pin">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label" data-translate="scanner-label-course">Course:</span>
                                <span class="value" id="scanned-course">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label" data-translate="scanner-label-lecturer">Lecturer:</span>
                                <span class="value" id="scanned-lecturer">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label" data-translate="scanner-label-session">Session ID:</span>
                                <span class="value" id="scanned-session">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label" data-translate="scanner-label-status">Status:</span>
                                <span class="value" id="scanned-status">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label" data-translate="scanner-label-expires">Expires:</span>
                                <span class="value" id="scanned-expires">-</span>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button class="btn" id="mark-attendance-btn">
                                <i class="fas fa-check"></i>
                                <span data-translate="scanner-mark-attendance">Mark Attendance</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <div class="settings-group mt-16">
                <h4 data-translate="scanner-available-qr-codes">Available QR Codes for Courses</h4>
                <div class="qr-codes-grid" id="qr-codes-grid">
                    <div class="qr-placeholder">
                        <i class="fas fa-qrcode"></i>
                        <p data-translate="scanner-select-course-view-qr">Select a course to view available QR codes</p>
                    </div>
                </div>
            </div>

            <div class="settings-group mt-16">
                <h4 data-translate="pin-manual-entry">Manual PIN Entry</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="manual-pin" data-translate="pin-enter">Enter PIN</label>
                        <input type="text" id="manual-pin" placeholder="Enter the PIN from lecturer" maxlength="6" data-translate-placeholder="pin-enter-placeholder" />
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="submit-pin-btn">
                            <i class="fas fa-key"></i>
                            <span data-translate="pin-submit">Submit PIN</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h4 data-translate="scanner-recent-scans">Recent Scans</h4>
                <div class="table-responsive">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th data-translate="scanner-table-date">Date</th>
                                <th data-translate="scanner-table-time">Time</th>
                                <th data-translate="scanner-table-pin">PIN</th>
                                <th data-translate="scanner-table-course">Course</th>
                                <th data-translate="scanner-table-lecturer">Lecturer</th>
                                <th data-translate="scanner-table-status">Status</th>
                                <th data-translate="scanner-table-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-scans-tbody">
                            <tr><td colspan="7" class="centered-cell" data-translate="scanner-no-recent-scans">No recent scans found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="pinenter" class="section" style="display: none;">
            <h3 id="pin-entry-title" data-translate="pin-entry-title">PIN Entry</h3>
            <div class="pin-entry-container">
                <div class="pin-entry-header">
                    <div class="pin-status">
                        <div class="status-indicator" id="pin-status">
                            <i class="fas fa-circle"></i>
                            <span id="pin-status-text" data-translate="pin-ready">Ready to Enter PIN</span>
                        </div>
                    </div>
                </div>

                <div class="pin-entry-form">
                    <div class="pin-input-section">
                        <h4>Enter Session PIN</h4>
                        <p class="pin-instructions">Enter the 6-digit PIN provided by your lecturer to mark attendance.</p>
                        
                        <div class="pin-input-group">
                            <input type="text" id="pin-input-1" class="pin-digit" maxlength="1" placeholder="0" />
                            <input type="text" id="pin-input-2" class="pin-digit" maxlength="1" placeholder="0" />
                            <input type="text" id="pin-input-3" class="pin-digit" maxlength="1" placeholder="0" />
                            <input type="text" id="pin-input-4" class="pin-digit" maxlength="1" placeholder="0" />
                            <input type="text" id="pin-input-5" class="pin-digit" maxlength="1" placeholder="0" />
                            <input type="text" id="pin-input-6" class="pin-digit" maxlength="1" placeholder="0" />
                        </div>
                        
                        <div class="pin-actions">
                            <button class="btn" id="submit-pin-entry-btn">
                                <i class="fas fa-check"></i>
                                <span data-translate="pin-submit">Submit PIN</span>
                            </button>
                            <button class="btn" id="clear-pin-btn">
                                <i class="fas fa-times"></i>
                                <span data-translate="pin-clear">Clear</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="pin-results" id="pin-results" style="display: none;">
                    <div class="result-card">
                        <div class="result-header">
                            <h4>PIN Verification Result</h4>
                            <button class="btn btn-small" id="close-pin-result-btn">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="result-content">
                            <div class="result-item">
                                <span class="label">PIN:</span>
                                <span class="value" id="verified-pin">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label">Course:</span>
                                <span class="value" id="verified-course">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label">Lecturer:</span>
                                <span class="value" id="verified-lecturer">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label">Session ID:</span>
                                <span class="value" id="verified-session">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label">Status:</span>
                                <span class="value" id="verified-status">-</span>
                            </div>
                            <div class="result-item">
                                <span class="label">Expires:</span>
                                <span class="value" id="verified-expires">-</span>
                            </div>
                        </div>
                        <div class="result-actions">
                            <button class="btn" id="mark-pin-attendance-btn">
                                <i class="fas fa-check"></i>
                                Mark Attendance
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-group mt-16">
                <h4 data-translate="pin-quick-entry">Quick PIN Entry</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="quick-pin" data-translate="pin-enter-full">Enter Full PIN</label>
                        <input type="text" id="quick-pin" placeholder="Enter 6-digit PIN" maxlength="6" pattern="[0-9]{6}" data-translate-placeholder="pin-enter-full-placeholder" />
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="quick-submit-pin-btn">
                            <i class="fas fa-key"></i>
                            Submit
                        </button>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h4 data-translate="pin-history">PIN Entry History</h4>
                <div class="table-responsive">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>PIN</th>
                                <th>Course</th>
                                <th>Lecturer</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pin-history-tbody">
                            <tr><td colspan="7" class="centered-cell">No PIN entries found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="attendance" class="section" style="display: none;">
            <h3 id="attendance-title" data-translate="attendance-title">My Attendance</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <i class="fas fa-calendar-check stat-icon"></i>
                    <div class="stat-content">
                        <div class="stat-label" data-translate="attendance-total">Total Sessions</div>
                        <div class="stat-value" id="total-sessions">0</div>
                    </div>
                </div>
                <div class="stat-box">
                    <i class="fas fa-user-check stat-icon"></i>
                    <div class="stat-content">
                        <div class="stat-label">Present</div>
                        <div class="stat-value" id="present-count">0</div>
                    </div>
                </div>
                <div class="stat-box">
                    <i class="fas fa-user-times stat-icon"></i>
                    <div class="stat-content">
                        <div class="stat-label">Absent</div>
                        <div class="stat-value" id="absent-count">0</div>
                    </div>
                </div>
                <div class="stat-box">
                    <i class="fas fa-percentage stat-icon"></i>
                    <div class="stat-content">
                        <div class="stat-label" data-translate="attendance-rate">Attendance Rate</div>
                        <div class="stat-value" id="attendance-rate">0%</div>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h4>Attendance Records</h4>
                <div class="attendance-toolbar">
                    <div class="form-grid">
                        <div class="form-field">
                            <label for="attendance-course-filter">Course</label>
                            <select id="attendance-course-filter">
                                <option value="">All Courses</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label for="attendance-date-filter" data-translate="attendance-date-range">Date Range</label>
                            <select id="attendance-date-filter">
                                <option value="all" data-translate="attendance-all-time">All Time</option>
                                <option value="week" data-translate="attendance-this-week">This Week</option>
                                <option value="month" data-translate="attendance-this-month">This Month</option>
                                <option value="semester" data-translate="attendance-this-semester">This Semester</option>
                            </select>
                        </div>
                        <div class="form-field">
                            <label>&nbsp;</label>
                            <button class="btn" id="apply-attendance-filters">
                                <i class="fas fa-filter"></i>
                                <span data-translate="attendance-apply-filters">Apply Filters</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Course</th>
                                <th>Lecturer</th>
                                <th>Session ID</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-tbody">
                            <tr><td colspan="8" class="centered-cell">No attendance records found.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="reports" class="section" style="display: none;">
            <h3 id="reports-title" data-translate="reports-title">My Reports</h3>
            <div class="settings-group">
                <h4 data-translate="reports-generate">Generate Reports</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="report-type" data-translate="reports-type">Report Type</label>
                        <select id="report-type">
                            <option value="attendance" data-translate="reports-attendance">Attendance Report</option>
                            <option value="academic" data-translate="reports-academic">Academic Progress</option>
                            <option value="course" data-translate="reports-course">Course Summary</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="report-period" data-translate="reports-period">Period</label>
                        <select id="report-period">
                            <option value="week" data-translate="reports-week">This Week</option>
                            <option value="month" data-translate="reports-month">This Month</option>
                            <option value="semester" data-translate="reports-semester">This Semester</option>
                            <option value="year" data-translate="reports-year">This Year</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="report-format" data-translate="reports-format">Format</label>
                        <select id="report-format">
                            <option value="pdf">PDF</option>
                            <option value="word">Word Document</option>
                            <option value="json">JSON Data</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="generate-report-btn">
                            <i class="fas fa-file-alt"></i>
                            <span data-translate="reports-generate-btn">Generate Report</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h4 data-translate="reports-preview">Report Preview</h4>
                <div class="report-preview">
                    <div class="report-card" id="report-card">
                        <div class="report-header">
                            <h4 id="report-title" data-translate="reports-student-report">Student Report</h4>
                            <div class="report-meta">
                                <span id="report-date" data-translate="reports-generated-on">Generated on: -</span>
                                <span id="report-period-display" data-translate="reports-period-label">Period: -</span>
                            </div>
                        </div>
                        <div class="report-content" id="report-content">
                            <p data-translate="reports-preview-instruction">Select report type and period, then click "Generate Report" to preview.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h4 data-translate="reports-recent">Recent Reports</h4>
                <div class="table-responsive">
                    <table class="attendance-table">
                        <thead>
                            <tr>
                                <th data-translate="reports-table-date">Date</th>
                                <th data-translate="reports-table-type">Type</th>
                                <th data-translate="reports-table-period">Period</th>
                                <th data-translate="reports-table-format">Format</th>
                                <th data-translate="reports-table-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-tbody">
                            <tr><td colspan="5" class="centered-cell" data-translate="reports-no-reports">No reports generated yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="settings" class="section" style="display: none;">
            <h3 id="settings-title" data-translate="settings-title">Student Settings</h3>
            
            <div class="settings-group">
                <h4 data-translate="settings-profile">Profile Settings</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="student-theme" data-translate="settings-theme">Theme</label>
                        <select id="student-theme">
                            <option value="light" data-translate="theme-light">Light</option>
                            <option value="dark" data-translate="theme-dark">Dark</option>
                            <option value="auto" data-translate="theme-auto">Auto</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="student-language" data-translate="settings-language">Language</label>
                        <select id="student-language">
                            <option value="en" data-translate="lang-english">English</option>
                            <option value="xh" data-translate="lang-xhosa">Xhosa</option>
                            <option value="st" data-translate="lang-sesotho">Sesotho</option>
                            <option value="tn" data-translate="lang-setswana">Setswana</option>
                            <option value="zu" data-translate="lang-zulu">Zulu</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="student-timezone" data-translate="settings-timezone">Timezone</label>
                        <select id="student-timezone">
                            <option value="Africa/Johannesburg" data-translate="timezone-sa">South Africa (GMT+2)</option>
                            <option value="UTC" data-translate="timezone-utc">UTC</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="settings-group">
                <h4 data-translate="settings-notifications">Notification Preferences</h4>
                <div class="checkboxes">
                    <label class="checkbox-item">
                        <input type="checkbox" id="notify-attendance" checked>
                        <span class="checkmark"></span>
                        <span data-translate="notify-attendance">Attendance reminders</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="notify-courses" checked>
                        <span class="checkmark"></span>
                        <span data-translate="notify-courses">Course updates</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="notify-deadlines" checked>
                        <span class="checkmark"></span>
                        <span data-translate="notify-deadlines">Assignment deadlines</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="notify-grades">
                        <span class="checkmark"></span>
                        <span data-translate="notify-grades">Grade updates</span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h4 data-translate="settings-scanner">Scanner Settings</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="scanner-camera" data-translate="settings-default-camera">Default Camera</label>
                        <select id="scanner-camera">
                            <option value="auto" data-translate="settings-auto-select">Auto-select</option>
                            <option value="back" data-translate="settings-back-camera">Back Camera</option>
                            <option value="front" data-translate="settings-front-camera">Front Camera</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label for="scanner-quality" data-translate="settings-scan-quality">Scan Quality</label>
                        <select id="scanner-quality">
                            <option value="high" data-translate="settings-quality-high">High</option>
                            <option value="medium" selected data-translate="settings-quality-medium">Medium</option>
                            <option value="low" data-translate="settings-quality-low">Low</option>
                        </select>
                    </div>
                </div>
                <div class="checkboxes">
                    <label class="checkbox-item">
                        <input type="checkbox" id="auto-scan" checked>
                        <span class="checkmark"></span>
                        <span data-translate="settings-auto-scan">Auto-scan QR codes</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="sound-effects" checked>
                        <span class="checkmark"></span>
                        <span data-translate="settings-sound-effects">Sound effects</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="vibrate-on-scan" checked>
                        <span class="checkmark"></span>
                        <span data-translate="settings-vibrate-scan">Vibrate on successful scan</span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h4 data-translate="settings-data-management">Data Management</h4>
                <div class="form-actions">
                    <button class="btn" id="export-student-data">
                        <i class="fas fa-download"></i>
                        <span data-translate="settings-export-data">Export My Data</span>
                    </button>
                    <button class="btn" id="import-student-data">
                        <i class="fas fa-upload"></i>
                        <span data-translate="settings-import-data">Import Data</span>
                    </button>
                    <button class="btn" id="clear-student-data">
                        <i class="fas fa-trash"></i>
                        <span data-translate="settings-clear-data">Clear All Data</span>
                    </button>
                </div>
                <input type="file" id="import-file" accept=".json" style="display: none;">
            </div>

            <div class="settings-group">
                <h4 data-translate="settings-account-security">Account Security</h4>
                <div class="form-grid">
                    <div class="form-field">
                        <label for="current-password" data-translate="settings-current-password">Current Password</label>
                        <input type="password" id="current-password" placeholder="Enter current password" data-translate-placeholder="settings-current-password-placeholder">
                    </div>
                    <div class="form-field">
                        <label for="new-password" data-translate="settings-new-password">New Password</label>
                        <input type="password" id="new-password" placeholder="Enter new password" data-translate-placeholder="settings-new-password-placeholder">
                    </div>
                    <div class="form-field">
                        <label for="confirm-password" data-translate="settings-confirm-password">Confirm Password</label>
                        <input type="password" id="confirm-password" placeholder="Confirm new password" data-translate-placeholder="settings-confirm-password-placeholder">
                    </div>
                    <div class="form-field">
                        <label>&nbsp;</label>
                        <button class="btn" id="change-password-btn">
                            <i class="fas fa-key"></i>
                            <span data-translate="settings-change-password">Change Password</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2025/26 Code Crafters Edu-Tend System. All rights reserved by Kay-M.</p>
        </footer>
    </div>

    <style>
        /* Course Selection Styles */
        .mb-16 { margin-bottom: 1rem; }
        
        .course-info {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .info-card h5 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 1.1rem;
        }
        
        .info-card p {
            margin: 0 0 1rem 0;
            color: #6c757d;
            font-weight: 500;
        }
        
        .course-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .course-stats .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
            color: #495057;
        }
        
        .course-stats .stat i {
            color: #007bff;
        }
        
        /* QR Codes Grid Styles */
        .qr-codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .qr-placeholder {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .qr-placeholder i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #adb5bd;
        }
        
        .qr-placeholder p {
            margin: 0.5rem 0;
            font-size: 1rem;
        }
        
        .qr-placeholder small {
            color: #adb5bd;
            font-size: 0.875rem;
        }
        
        /* Enhanced QR Status Grid */
        .qr-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .qr-status-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .qr-status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .qr-status-card.active {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }
        
        .qr-status-card.expired {
            border-color: #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #ffffff 100%);
        }
        
        .qr-status-card.closed {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fffdf8 0%, #ffffff 100%);
        }
        
        .qr-status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }
        
        .qr-status-header h6 {
            margin: 0;
            color: #495057;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .qr-status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .qr-status-badge.active {
            background: #d4edda;
            color: #155724;
        }
        
        .qr-status-badge.expired {
            background: #f8d7da;
            color: #721c24;
        }
        
        .qr-status-badge.closed {
            background: #fff3cd;
            color: #856404;
        }
        
        .qr-status-content {
            margin-bottom: 0.75rem;
        }
        
        .qr-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .qr-status-item .label {
            color: #6c757d;
            font-weight: 500;
        }
        
        .qr-status-item .value {
            color: #495057;
            font-weight: 600;
        }
        
        .qr-status-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-scan-now {
            background: #007bff;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
            flex: 1;
        }
        
        .btn-scan-now:hover {
            background: #0056b3;
        }
        
        .btn-scan-now:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* Enhanced Course Info */
        .course-info {
            margin-top: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 8px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .info-card h5 {
            margin: 0 0 0.5rem 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .info-card p {
            margin: 0 0 1rem 0;
            color: #6c757d;
            font-weight: 500;
        }
        
        .course-stats {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .course-stats .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
            color: #495057;
            transition: all 0.2s ease;
        }
        
        .course-stats .stat:hover {
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.1);
        }
        
        .course-stats .stat i {
            color: #007bff;
        }
        
        /* Course Selection Enhancement */
        .course-selection-enhanced {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .course-selection-enhanced h5 {
            margin: 0 0 0.75rem 0;
            color: #495057;
            font-size: 1rem;
        }
        
        .course-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .course-option {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .course-option:hover {
            border-color: #007bff;
            background: #f8f9ff;
        }
        
        .course-option.selected {
            border-color: #007bff;
            background: #e7f3ff;
        }
        
        .course-option h6 {
            margin: 0 0 0.25rem 0;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .course-option p {
            margin: 0;
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .course-option .qr-status {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            display: inline-block;
        }
        
        .course-option .qr-status.available {
            background: #d4edda;
            color: #155724;
        }
        
        .course-option .qr-status.none {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Enhanced Scanner Status */
        .scanner-status.error .status-indicator i {
            color: #dc3545;
        }
        
        .scanner-status.scanning .status-indicator i {
            color: #ffc107;
            animation: pulse 1.5s infinite;
        }
        
        .scanner-status.success .status-indicator i {
            color: #28a745;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Notification System Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }
        
        .session-notification {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            margin-bottom: 16px;
            overflow: hidden;
            animation: slideInRight 0.3s ease-out;
            border: 1px solid #e9ecef;
        }
        
        .session-notification.new-session {
            border-left: 4px solid #28a745;
        }
        
        .notification-content {
            display: flex;
            align-items: flex-start;
            padding: 16px;
            gap: 12px;
        }
        
        .notification-icon {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .notification-icon i {
            font-size: 1.2rem;
        }
        
        .notification-text {
            flex: 1;
            min-width: 0;
        }
        
        .notification-text h6 {
            margin: 0 0 4px 0;
            color: #212529;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .notification-text p {
            margin: 0 0 4px 0;
            color: #6c757d;
            font-size: 0.875rem;
            line-height: 1.4;
        }
        
        .notification-text small {
            color: #adb5bd;
            font-size: 0.75rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #adb5bd;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .notification-close:hover {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .notification-actions {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }
        
        .notification-actions button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .notification-actions .btn-scan-now {
            background: #007bff;
            color: white;
        }
        
        .notification-actions .btn-scan-now:hover {
            background: #0056b3;
        }
        
        .notification-actions .btn-view-course {
            background: #6c757d;
            color: white;
        }
        
        .notification-actions .btn-view-course:hover {
            background: #545b62;
        }
        
        /* Animation for notifications */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .session-notification.removing {
            animation: slideOutRight 0.3s ease-in forwards;
        }

        /* Enhanced Scanner Overlay Styles */
        .corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 3px solid #00ff00;
        }

        .corner.top-left {
            top: -3px;
            left: -3px;
            border-right: none;
            border-bottom: none;
        }

        .corner.top-right {
            top: -3px;
            right: -3px;
            border-left: none;
            border-bottom: none;
        }

        .corner.bottom-left {
            bottom: -3px;
            left: -3px;
            border-right: none;
            border-top: none;
        }

        .corner.bottom-right {
            bottom: -3px;
            right: -3px;
            border-left: none;
            border-top: none;
        }

        .scanning-line {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            animation: scanning 2s linear infinite;
        }

        @keyframes scanning {
            0% { transform: translate(-50%, -50%) translateY(-100px); }
            100% { transform: translate(-50%, -50%) translateY(100px); }
        }

        .scanner-instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
        }

        .scanner-instructions i {
            margin-right: 8px;
            color: #00ff00;
        }

        /* Scan History Styles */
        .scan-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .scan-history-item.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .scan-history-item.failed {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .scan-info {
            flex: 1;
        }

        .scan-course {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .scan-details {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
        }

        .scan-status {
            font-weight: 500;
        }

        .scan-result i {
            font-size: 18px;
        }

        .scan-history-item.success .scan-result i {
            color: #28a745;
        }

        .scan-history-item.failed .scan-result i {
            color: #dc3545;
        }

        /* Fix for start scanner button */
        #start-scan-btn {
            cursor: pointer !important;
            pointer-events: auto !important;
            opacity: 1 !important;
            z-index: 10 !important;
        }

        #start-scan-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #start-scan-btn:not(:disabled) {
            opacity: 1;
            cursor: pointer;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated and has student role
            function checkAuthentication() {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const currentUser = users.find(user => user.isLoggedIn === true);
                
                if (!currentUser) {
                    // No user is logged in, redirect to login page
                    alert('Please log in to access the student dashboard.');
                    window.location.href = 'index.html';
                    return false;
                }
                
                if (currentUser.role.toLowerCase() !== 'student') {
                    // User is not a student, redirect to appropriate page
                    alert('Access denied. This dashboard is for students only.');
                    if (currentUser.role.toLowerCase() === 'admin') {
                        window.location.href = 'Admin.html';
                    } else if (currentUser.role.toLowerCase() === 'lecturer') {
                        window.location.href = 'Lecturer.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                    return false;
                }
                
                // User is authenticated and is a student
                return currentUser;
            }
            
            // Check authentication first
            const currentUser = checkAuthentication();
            if (!currentUser) return;
            
            // Initialize courses data from studentc.html
            function initializeCourses() {
                const studentcCourses = [
                    {
                        code: 'HCI',
                        name: 'HUMAN COMPUTER INTERACTION II',
                        description: 'This module focuses on designing intuitive interfaces and understanding user behavior.'
                    },
                    {
                        code: 'DES',
                        name: 'DEVELOPMENT SOFTWARE II',
                        description: 'Covers advanced techniques in software development and agile methodologies.'
                    },
                    {
                        code: 'TEP',
                        name: 'TECNICAL PROGRAMMING I',
                        description: 'Introduces low-level programming, data structures, and debugging strategies.'
                    },
                    {
                        code: 'INF',
                        name: 'INFORMATION SYSTEMS II',
                        description: 'Explores enterprise systems, database integration, and business process modeling.'
                    }
                ];
                
                // Always set the courses from studentc.html to ensure they're available
                localStorage.setItem('courses', JSON.stringify(studentcCourses));
            }
            
            // Initialize courses
            initializeCourses();
            
            // Initialize lecturers data if not already present
            function initializeLecturers() {
                const existingLecturers = JSON.parse(localStorage.getItem('lecturers') || '[]');
                if (existingLecturers.length === 0) {
                    const lecturers = [
                        {
                            id: '230487254',
                            name: 'Dr. Soetsang',
                            email: 'soetsang@example.com',
                            role: 'lecturer',
                            department: 'Application Development'
                        },
                        {
                            id: '230018440', 
                            name: 'Prof. Mathabathe',
                            email: 'mathabathe@example.com',
                            role: 'lecturer',
                            department: 'Information Technology'
                        },
                        {
                            id: '219341249',
                            name: 'Dr. Kaleni',
                            email: 'kaleni@example.com',
                            role: 'lecturer',
                            department: 'Engineering'
                        }
                    ];
                    localStorage.setItem('lecturers', JSON.stringify(lecturers));
                }
            }
            
            // Initialize lecturers
            initializeLecturers();
            
            // Initialize comprehensive sample data
            initializeSampleData();
            
            function initializeSampleData() {
                // Initialize users with all new names
                const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
                if (existingUsers.length === 0) {
                    const users = [
                        {
                            id: '231030231',
                            name: 'Kamva Mchwayi',
                            email: 'kamva@example.com',
                            password: 'admin123',
                            role: 'Admin'
                        },
                        {
                            id: '231054343',
                            name: 'Nyaniso Sikoko',
                            email: 'nyaniso@example.com',
                            password: 'admin123',
                            role: 'Admin'
                        },
                        {
                            id: '231367783',
                            name: 'Siyabonga Sithole',
                            email: 'siyabonga@example.com',
                            password: 'admin123',
                            role: 'Admin'
                        },
                        {
                            id: '230487254',
                            name: 'Dr. Soetsang',
                            email: 'soetsang@example.com',
                            password: 'lecturer123',
                            role: 'Lecturer'
                        },
                        {
                            id: '230018440',
                            name: 'Prof. Mathabathe',
                            email: 'mathabathe@example.com',
                            password: 'lecturer123',
                            role: 'Lecturer'
                        },
                        {
                            id: '219341249',
                            name: 'Dr. Kaleni',
                            email: 'kaleni@example.com',
                            password: 'lecturer123',
                            role: 'Lecturer'
                        },
                        {
                            id: '231031149',
                            name: 'Bukho Skweza',
                            email: 'bukho@example.com',
                            password: 'student1',
                            role: 'Student'
                        },
                        {
                            id: '231066538',
                            name: 'Ramphadi Rebone',
                            email: 'ramphadi@example.com',
                            password: 'student12',
                            role: 'Student'
                        },
                        {
                            id: '230343775',
                            name: 'Zinhle Dlamini',
                            email: 'zinhle@example.com',
                            password: 'student123',
                            role: 'Student'
                        }
                    ];
                    localStorage.setItem('users', JSON.stringify(users));
                }
            }
            
            // Update welcome message with actual user name
            const welcomeSpan = document.querySelector('.user-info span');
            if (welcomeSpan) {
                welcomeSpan.textContent = `Welcome, ${currentUser.name}`;
            }
            
            // Load user profile data
            function loadUserProfile() {
                // Check if user profile exists, if not create default one
                let profile = JSON.parse(localStorage.getItem('studentProfile') || '{}');
                
                if (!profile.name || profile.name === 'Student Name') {
                    // Create default profile from user registration data
                    profile = {
                        name: currentUser.name,
                        studentId: currentUser.studentId || 'STU' + Math.floor(Math.random() * 1000000),
                        email: currentUser.email,
                        year: '1st Year',
                        course: 'Information Technology',
                        department: 'Computer Science',
                        phone: '+27 123 456 789',
                        address: 'Student Address',
                        bio: 'A dedicated student pursuing Information Technology with a passion for technology and innovation.'
                    };
                    
                    // Save the profile
                    localStorage.setItem('studentProfile', JSON.stringify(profile));
                }
                
                return profile;
            }
            
            // Load user profile
            const userProfile = loadUserProfile();
            
            // Initialize profile display
            loadStudentProfile();
            
            // Add logout functionality
            const logoutBtn = document.querySelector('.logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Clear the user's login status
                    const users = JSON.parse(localStorage.getItem('users') || '[]');
                    const userIndex = users.findIndex(user => user.email === currentUser.email);
                    if (userIndex !== -1) {
                        users[userIndex].isLoggedIn = false;
                        localStorage.setItem('users', JSON.stringify(users));
                    }
                    
                    // Redirect to login page
                    window.location.href = 'index.html';
                });
            }
            
            // Navigation functionality
            const navItems = document.querySelectorAll('.student-nav-item');
            const sections = document.querySelectorAll('.section');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    const target = item.getAttribute('data-target');
                    if (!target || target === 'logout' || target === 'courses') return; // external or no-op
                    e.preventDefault();
                    
                    // Update active state
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Show/hide sections
                    sections.forEach(sec => { 
                        sec.style.display = (sec.id === target) ? 'block' : 'none'; 
                    });

                    // Initialize sections when shown
                    if (target === 'profile') loadStudentProfile();
                    if (target === 'calendar') {
                        populateCourseOptions();
                        renderCalendar();
                        renderEvents();
                    }
                    if (target === 'qrcodescanner') {
                        initializeScanner();
                        loadScannerCourses();
                        loadRecentScans();
                    }
                    if (target === 'pinenter') {
                        initializePinEntry();
                        loadPinHistory();
                    }
                    if (target === 'attendance') {
                        loadAttendanceStats();
                        loadAttendanceRecords();
                    }
                    if (target === 'reports') {
                        loadReports();
                        generateReportPreview();
                    }
                    if (target === 'settings') {
                        loadSettings();
                    }
                });
            });

            // ===== Profile Management =====
            const studentNameEl = document.getElementById('student-name');
            const studentIdEl = document.getElementById('student-id');
            const studentEmailEl = document.getElementById('student-email');
            const studentYearEl = document.getElementById('student-year');
            const studentCourseEl = document.getElementById('student-course');
            const studentDeptEl = document.getElementById('student-dept');
            const studentPhoneEl = document.getElementById('student-phone');
            const studentAddressEl = document.getElementById('student-address');
            const studentBioEl = document.getElementById('student-bio');
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const editProfileForm = document.getElementById('edit-profile-form');
            const saveProfileBtn = document.getElementById('save-profile-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            // Form fields
            const editNameInput = document.getElementById('edit-name');
            const editEmailInput = document.getElementById('edit-email');
            const editPhoneInput = document.getElementById('edit-phone');
            const editAddressInput = document.getElementById('edit-address');
            const editBioInput = document.getElementById('edit-bio');
            const editPasswordInput = document.getElementById('edit-password');
            const editConfirmPasswordInput = document.getElementById('edit-confirm-password');

            function loadStudentProfile(){
                try {
                    const profile = JSON.parse(localStorage.getItem('studentProfile') || '{}');
                    
                    // Use authenticated user data as fallback
                    studentNameEl.textContent = profile.name || currentUser.name || 'Student Name';
                    studentIdEl.textContent = `Student ID: ${profile.studentId || currentUser.studentId || 'STU001'}`;
                    studentEmailEl.textContent = profile.email || currentUser.email || 'student@example.com';
                    studentYearEl.textContent = profile.year || '1st Year';
                    studentCourseEl.textContent = profile.course || 'Information Technology';
                    studentDeptEl.textContent = profile.department || 'Computer Science';
                    studentPhoneEl.textContent = profile.phone || '+27 123 456 789';
                    studentAddressEl.textContent = profile.address || 'Student Address';
                    studentBioEl.textContent = profile.bio || 'A dedicated student pursuing Information Technology with a passion for technology and innovation.';
                } catch (e) {
                    console.error('Error loading profile:', e);
                }
            }

            function saveStudentProfile(){
                const profile = {
                    name: editNameInput.value.trim(),
                    studentId: currentUser.studentId || 'STU' + Math.floor(Math.random() * 1000000),
                    email: editEmailInput.value.trim(),
                    year: '1st Year', // This would come from the system
                    course: 'Information Technology', // This would come from the system
                    department: 'Computer Science', // This would come from the system
                    phone: editPhoneInput.value.trim(),
                    address: editAddressInput.value.trim(),
                    bio: editBioInput.value.trim()
                };

                if (!profile.name || !profile.email) {
                    alert('Name and email are required.');
                    return;
                }

                if (editPasswordInput.value && editPasswordInput.value !== editConfirmPasswordInput.value) {
                    alert('Passwords do not match.');
                    return;
                }

                // Update the user's information in the users array as well
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const userIndex = users.findIndex(user => user.email === currentUser.email);
                if (userIndex !== -1) {
                    users[userIndex].name = profile.name;
                    users[userIndex].studentId = profile.studentId;
                    localStorage.setItem('users', JSON.stringify(users));
                }

                localStorage.setItem('studentProfile', JSON.stringify(profile));
                loadStudentProfile();
                editProfileForm.style.display = 'none';
                alert('Profile updated successfully!');
            }

            function populateEditForm(){
                const profile = JSON.parse(localStorage.getItem('studentProfile') || '{}');
                editNameInput.value = profile.name || currentUser.name || '';
                editEmailInput.value = profile.email || currentUser.email || '';
                editPhoneInput.value = profile.phone || '';
                editAddressInput.value = profile.address || '';
                editBioInput.value = profile.bio || '';
                editPasswordInput.value = '';
                editConfirmPasswordInput.value = '';
            }

            // ===== Calendar Management =====
            const calendarMonthEl = document.getElementById('calendar-month');
            const calendarDaysEl = document.getElementById('calendar-days');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const eventTitleInput = document.getElementById('event-title');
            const eventDateInput = document.getElementById('event-date');
            const eventTimeInput = document.getElementById('event-time');
            const eventTypeSelect = document.getElementById('event-type');
            const eventCourseSelect = document.getElementById('event-course');
            const eventNotesInput = document.getElementById('event-notes');
            const addEventBtn = document.getElementById('add-event-btn');
            const clearEventFormBtn = document.getElementById('clear-event-form-btn');
            const eventFilterTypeSelect = document.getElementById('event-filter-type');
            const eventFilterCourseSelect = document.getElementById('event-filter-course');
            const applyEventFilterBtn = document.getElementById('apply-event-filter-btn');
            const exportEventsBtn = document.getElementById('export-events-btn');
            const eventsTbody = document.getElementById('events-tbody');

            let currentDate = new Date();
            let currentMonth = currentDate.getMonth();
            let currentYear = currentDate.getFullYear();

            // Calendar navigation functions
            function goToPreviousMonth() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            }

            function goToNextMonth() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            }

            function goToToday() {
                currentDate = new Date();
                currentMonth = currentDate.getMonth();
                currentYear = currentDate.getFullYear();
                renderCalendar();
            }

            function loadEvents(){
                try { 
                    // Load student's own events
                    const studentEvents = JSON.parse(localStorage.getItem('studentEvents') || '[]');
                    
                    // Load admin events that are relevant for students
                    let adminEvents = [];
                    try {
                        const adminEventsData = localStorage.getItem('adminCalendarEvents');
                        if (adminEventsData) {
                            const parsed = JSON.parse(adminEventsData);
                            Object.entries(parsed).forEach(([date, events]) => {
                                const relevantEvents = events.filter(evt => 
                                    evt.isAdminEvent && 
                                    (evt.type === 'Lecture' || evt.type === 'Tutorial' || evt.type === 'Exam' || evt.type === 'Assignment' || evt.type === 'Meeting')
                                );
                                
                                relevantEvents.forEach(evt => {
                                    adminEvents.push({
                                        ...evt,
                                        id: 'admin_' + evt.id,
                                        date: date, // Use the date from the admin events
                                        isAdminEvent: true,
                                        createdBy: 'admin'
                                    });
                                });
                            });
                        }
                    } catch (e) {
                        console.warn('Failed to load admin events:', e);
                    }
                    
                    return [...studentEvents, ...adminEvents];
                } catch { return []; }
            }
            function saveEvents(events){ localStorage.setItem('studentEvents', JSON.stringify(events)); }

            function populateCourseOptions(){
                try {
                    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                    eventCourseSelect.innerHTML = '<option value="">Select Course</option>';
                    eventFilterCourseSelect.innerHTML = '<option value="all">All Courses</option>';
                    
                    courses.forEach(course => {
                        const opt1 = document.createElement('option');
                        opt1.value = course.code;
                        opt1.textContent = course.name;
                        eventCourseSelect.appendChild(opt1);

                        const opt2 = document.createElement('option');
                        opt2.value = course.code;
                        opt2.textContent = course.name;
                        eventFilterCourseSelect.appendChild(opt2);
                    });
                } catch (e) {
                    console.error('Error loading courses:', e);
                }
            }

            function updateCalendarMonthDisplay(month, year) {
                const monthNames = [
                    'calendar-january', 'calendar-february', 'calendar-march', 'calendar-april',
                    'calendar-may', 'calendar-june', 'calendar-july', 'calendar-august',
                    'calendar-september', 'calendar-october', 'calendar-november', 'calendar-december'
                ];
                
                const language = studentLanguageSelect?.value || 'en';
                const currentTranslations = translations[language] || translations.en;
                const monthKey = monthNames[month];
                const monthName = currentTranslations[monthKey] || monthNames[month];
                
                if (calendarMonthEl) {
                    calendarMonthEl.textContent = `${monthName} ${year}`;
                }
            }

            function renderCalendar(){
                const firstDay = new Date(currentYear, currentMonth, 1);
                const lastDay = new Date(currentYear, currentMonth + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                // Update month display with translation
                updateCalendarMonthDisplay(currentMonth, currentYear);
                calendarDaysEl.innerHTML = '';

                const events = loadEvents();
                
                for (let i = 0; i < 42; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const dayEl = document.createElement('div');
                    dayEl.className = 'day';
                    
                    if (date.getMonth() !== currentMonth) {
                        dayEl.classList.add('next');
                    }
                    
                    if (date.toDateString() === new Date().toDateString()) {
                        dayEl.classList.add('today');
                    }
                    
                    dayEl.textContent = date.getDate();
                    
                    // Check if this date has events
                    const dayEvents = events.filter(e => e.date === date.toISOString().split('T')[0]);
                    if (dayEvents.length > 0) {
                        const hasAdminEvents = dayEvents.some(e => e.isAdminEvent);
                        if (hasAdminEvents) {
                            dayEl.style.backgroundColor = 'rgba(255, 107, 107, 0.2)';
                            dayEl.style.border = '2px solid #ff6b6b';
                        } else {
                            dayEl.style.backgroundColor = 'rgba(102, 126, 234, 0.2)';
                        }
                        dayEl.style.fontWeight = 'bold';
                    }
                    
                    calendarDaysEl.appendChild(dayEl);
                }
            }

            function renderEvents(){
                const events = loadEvents();
                const typeFilter = eventFilterTypeSelect?.value || 'all';
                const courseFilter = eventFilterCourseSelect?.value || 'all';
                
                const filtered = events.filter(e => {
                    if (typeFilter !== 'all' && e.type !== typeFilter) return false;
                    if (courseFilter !== 'all' && e.course !== courseFilter) return false;
                    return true;
                });

                eventsTbody.innerHTML = '';
                if (!filtered.length){
                    const tr = document.createElement('tr');
                    const td = document.createElement('td'); td.colSpan = 7; td.className = 'centered-cell'; td.textContent = 'No events found.';
                    tr.appendChild(td); eventsTbody.appendChild(tr); return;
                }

                filtered.forEach(e => {
                    const tr = document.createElement('tr');
                    tr.className = e.isAdminEvent ? 'admin-event-row' : '';
                    tr.innerHTML = `
                        <td>${e.date || ''}</td>
                        <td>${e.time || ''}</td>
                        <td>${e.title || ''} ${e.isAdminEvent ? '<span class="admin-badge">Admin</span>' : ''}</td>
                        <td>${e.type || ''}</td>
                        <td>${e.course || ''}</td>
                        <td>${e.notes || ''}</td>
                        <td>
                            ${!e.isAdminEvent ? `
                                <button class="btn btn-small" data-edit-event="${e.id}">Edit</button>
                                <button class="btn btn-small" data-del-event="${e.id}">Delete</button>
                            ` : '<span class="read-only">Read Only</span>'}
                        </td>`;
                    eventsTbody.appendChild(tr);
                });

                // Add event listeners for edit/delete buttons
                eventsTbody.querySelectorAll('[data-edit-event]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const eventId = btn.getAttribute('data-edit-event');
                        const events = loadEvents();
                        const event = events.find(e => e.id === eventId);
                        if (event) {
                            eventTitleInput.value = event.title || '';
                            eventDateInput.value = event.date || '';
                            eventTimeInput.value = event.time || '';
                            eventTypeSelect.value = event.type || 'assignment';
                            eventCourseSelect.value = event.course || '';
                            eventNotesInput.value = event.notes || '';
                            addEventBtn.textContent = 'Update Event';
                            addEventBtn.setAttribute('data-edit-id', eventId);
                        }
                    });
                });

                eventsTbody.querySelectorAll('[data-del-event]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const eventId = btn.getAttribute('data-del-event');
                        if (confirm('Delete this event?')) {
                            const events = loadEvents().filter(e => e.id !== eventId);
                            saveEvents(events);
                            renderEvents();
                            renderCalendar();
                        }
                    });
                });
            }

            function refreshAdminEvents(){
                renderEvents();
                renderCalendar();
            }

            function addEvent(){
                const title = eventTitleInput.value.trim();
                const date = eventDateInput.value;
                const time = eventTimeInput.value;
                const type = eventTypeSelect.value;
                const course = eventCourseSelect.value;
                const notes = eventNotesInput.value.trim();

                if (!title || !date) {
                    alert('Title and date are required.');
                    return;
                }

                const events = loadEvents();
                const editId = addEventBtn.getAttribute('data-edit-id');
                
                if (editId) {
                    // Update existing event
                    const index = events.findIndex(e => e.id === editId);
                    if (index !== -1) {
                        events[index] = { ...events[index], title, date, time, type, course, notes };
                    }
                    addEventBtn.removeAttribute('data-edit-id');
                    addEventBtn.textContent = 'Add Event';
                } else {
                    // Add new event
                    const newEvent = {
                        id: Date.now().toString(),
                        title, date, time, type, course, notes,
                        createdAt: new Date().toISOString()
                    };
                    events.push(newEvent);
                }

                saveEvents(events);
                renderEvents();
                renderCalendar();
                clearEventForm();
            }

            function clearEventForm(){
                eventTitleInput.value = '';
                eventDateInput.value = '';
                eventTimeInput.value = '';
                eventTypeSelect.value = 'assignment';
                eventCourseSelect.value = '';
                eventNotesInput.value = '';
                addEventBtn.textContent = 'Add Event';
                addEventBtn.removeAttribute('data-edit-id');
            }

            function exportEvents(){
                const events = loadEvents();
                const data = {
                    exportDate: new Date().toISOString(),
                    events: events
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `student-events-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
            }

            // Event listeners
            editProfileBtn?.addEventListener('click', () => {
                populateEditForm();
                editProfileForm.style.display = 'block';
            });

            saveProfileBtn?.addEventListener('click', saveStudentProfile);
            cancelEditBtn?.addEventListener('click', () => {
                editProfileForm.style.display = 'none';
            });

            prevMonthBtn?.addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            nextMonthBtn?.addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });

            addEventBtn?.addEventListener('click', addEvent);
            clearEventFormBtn?.addEventListener('click', clearEventForm);
            applyEventFilterBtn?.addEventListener('click', renderEvents);
            exportEventsBtn?.addEventListener('click', exportEvents);

            // ===== QR Code Scanner Management =====
            const startScanBtn = document.getElementById('start-scan-btn');
            const stopScanBtn = document.getElementById('stop-scan-btn');
            const scannerVideo = document.getElementById('scanner-video');
            const scannerCanvas = document.getElementById('scanner-canvas');
            const scannerResults = document.getElementById('scanner-results');
            const closeResultBtn = document.getElementById('close-result-btn');
            const markAttendanceBtn = document.getElementById('mark-attendance-btn');
            const manualPinInput = document.getElementById('manual-pin');
            const submitPinBtn = document.getElementById('submit-pin-btn');
            const recentScansTbody = document.getElementById('recent-scans-tbody');
            const statusText = document.getElementById('status-text');
            const scannerStatus = document.getElementById('scanner-status');
            
            // Course selection elements
            const scannerCourseSelect = document.getElementById('scanner-course-select');
            const refreshCoursesBtn = document.getElementById('refresh-courses-btn');
            const courseInfo = document.getElementById('course-info');
            const selectedCourseName = document.getElementById('selected-course-name');
            const selectedCourseCode = document.getElementById('selected-course-code');
            const courseSessions = document.getElementById('course-sessions');
            const courseAttendance = document.getElementById('course-attendance');
            const qrCodesGrid = document.getElementById('qr-codes-grid');

            let stream = null;
            let scanning = false;
            let scanInterval = null;

            function loadStudentScans(){
                try { 
                    const scans = JSON.parse(localStorage.getItem('studentScans') || '[]');
                    // If no scans exist, create some sample data for testing
                    if (scans.length === 0) {
                        createSampleScanData();
                        return JSON.parse(localStorage.getItem('studentScans') || '[]');
                    }
                    return scans;
                } catch { return []; }
            }
            function saveStudentScans(scans){ localStorage.setItem('studentScans', JSON.stringify(scans)); }

            function createSampleScanData() {
                const sampleScans = [
                    {
                        id: 'scan_001',
                        date: '2024-01-15',
                        time: '09:30 AM',
                        pin: '123478',
                        course: 'HCI',
                        courseCode: 'HCI',
                        lecturer: 'Dr. Soetsang',
                        status: 'Present',
                        sessionId: 'session_001'
                    },
                    {
                        id: 'scan_002',
                        date: '2024-01-16',
                        time: '10:15 AM',
                        pin: '567890',
                        course: 'DES',
                        courseCode: 'DES',
                        lecturer: 'Prof. Mathabathe',
                        status: 'Present',
                        sessionId: 'session_002'
                    },
                    {
                        id: 'scan_003',
                        date: '2024-01-17',
                        time: '11:00 AM',
                        pin: '901234',
                        course: 'TEP',
                        courseCode: 'TEP',
                        lecturer: 'Dr. Kaleni',
                        status: 'Late',
                        sessionId: 'session_003'
                    },
                    {
                        id: 'scan_004',
                        date: '2024-01-18',
                        time: '08:45 AM',
                        pin: '345678',
                        course: 'INF',
                        courseCode: 'INF',
                        lecturer: 'Dr. Kaleni',
                        status: 'Present',
                        sessionId: 'session_004'
                    },
                    {
                        id: 'scan_005',
                        date: '2024-01-19',
                        time: '09:20 AM',
                        pin: '789012',
                        course: 'HCI',
                        courseCode: 'HCI',
                        lecturer: 'Dr. Soetsang',
                        status: 'Absent',
                        sessionId: 'session_005'
                    }
                ];
                saveStudentScans(sampleScans);
            }

            // Load available courses for scanner
            function loadScannerCourses() {
                const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                scannerCourseSelect.innerHTML = '<option value="">Select a course to scan QR code for</option>';
                
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.code;
                    option.textContent = `${course.code} - ${course.name}`;
                    scannerCourseSelect.appendChild(option);
                });
                
                // Check if there's a pre-selected course from studentc.html
                checkForPreSelectedCourse();
                
                // Check for active QR codes and update status
                updateQRCodeAvailabilityStatus();
            }

            // Update QR code availability status
            function updateQRCodeAvailabilityStatus() {
                const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                const activeSession = courseSessions.find(s => s.status === 'active');
                
                // Find or create status indicator
                let statusIndicator = document.getElementById('qr-availability-status');
                if (!statusIndicator) {
                    statusIndicator = document.createElement('div');
                    statusIndicator.id = 'qr-availability-status';
                    statusIndicator.style.cssText = `
                        margin: 10px 0;
                        padding: 10px;
                        border-radius: 6px;
                        font-weight: 500;
                        text-align: center;
                    `;
                    
                    // Insert after the course select form
                    const formGrid = document.querySelector('.form-grid');
                    if (formGrid) {
                        formGrid.parentNode.insertBefore(statusIndicator, formGrid.nextSibling);
                    }
                }
                
                if (activeSession) {
                    statusIndicator.innerHTML = `
                        <i class="fas fa-check-circle" style="color: #28a745; margin-right: 8px;"></i>
                        QR Code Available: ${activeSession.courseName} (${activeSession.courseCode}) - Generated by ${activeSession.lecturerName}
                    `;
                    statusIndicator.style.backgroundColor = '#d4edda';
                    statusIndicator.style.color = '#155724';
                    statusIndicator.style.border = '1px solid #c3e6cb';
                } else {
                    statusIndicator.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="color: #ffc107; margin-right: 8px;"></i>
                        No QR codes are currently being displayed. Scanner will show "No QR Code Detected" if you try to scan now.
                    `;
                    statusIndicator.style.backgroundColor = '#fff3cd';
                    statusIndicator.style.color = '#856404';
                    statusIndicator.style.border = '1px solid #ffeaa7';
                }
            }

            // Check for pre-selected course from studentc.html
            function checkForPreSelectedCourse() {
                const selectedCourseData = localStorage.getItem('selectedCourseForScanner');
                if (selectedCourseData) {
                    try {
                        const courseData = JSON.parse(selectedCourseData);
                        const timestamp = new Date(courseData.timestamp);
                        const now = new Date();
                        
                        // Check if the selection is recent (within 5 minutes)
                        if (now - timestamp < 5 * 60 * 1000) {
                            // Set the course in the dropdown
                            scannerCourseSelect.value = courseData.code;
                            
                            // Update the course info and QR codes
                            updateCourseInfo(courseData.code);
                            loadCourseQRCodes(courseData.code);
                            
                            // Clear the localStorage to prevent future auto-selection
                            localStorage.removeItem('selectedCourseForScanner');
                            
                            // Show success message
                            showNotification(`Course "${courseData.name}" selected for QR scanning`, 'success');
                        } else {
                            // Selection is too old, remove it
                            localStorage.removeItem('selectedCourseForScanner');
                        }
                    } catch (error) {
                        console.error('Error parsing selected course data:', error);
                        localStorage.removeItem('selectedCourseForScanner');
                    }
                }
            }

            // Load course-specific QR codes and sessions
            function loadCourseQRCodes(courseCode){
                try {
                    const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                    const courseQRs = courseSessions.filter(s => s.courseCode === courseCode);
                    
                    qrCodesGrid.innerHTML = '';
                    
                    if (!courseQRs.length) {
                        qrCodesGrid.innerHTML = `
                            <div class="qr-placeholder">
                                <i class="fas fa-info-circle"></i>
                                <p>No active QR codes found for this course</p>
                                <small>Ask your lecturer to generate a QR code for attendance</small>
                            </div>
                        `;
                        return;
                    }

                    courseQRs.forEach(session => {
                        const qrCard = document.createElement('div');
                        qrCard.className = 'qr-code-card';
                        qrCard.innerHTML = `
                            <div class="qr-header">
                                <h5>${session.courseName || session.courseCode}</h5>
                                <span class="session-status ${session.status}">${session.status}</span>
                            </div>
                            <div class="qr-content">
                                <div class="qr-info">
                                    <p><strong>Session ID:</strong> ${session.id}</p>
                                    <p><strong>PIN:</strong> ${session.pin}</p>
                                    <p><strong>Lecturer:</strong> ${session.lecturerName || 'Unknown'}</p>
                                    <p><strong>Created:</strong> ${new Date(session.created).toLocaleString()}</p>
                                    ${session.expiresAt ? `<p><strong>Expires:</strong> ${new Date(session.expiresAt).toLocaleString()}</p>` : ''}
                                </div>
                                <div class="qr-actions">
                                    <button class="btn btn-small" onclick="scanSpecificQR('${session.id}')">
                                        <i class="fas fa-qrcode"></i>
                                        Scan This QR
                                    </button>
                                </div>
                            </div>
                        `;
                        qrCodesGrid.appendChild(qrCard);
                    });
                } catch (e) {
                    console.error('Error loading course QR codes:', e);
                }
            }

            // Update course info display
            function updateCourseInfo(courseCode){
                try {
                    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                    const course = courses.find(c => c.code === courseCode);
                    
                    if (course) {
                        selectedCourseName.textContent = course.name;
                        selectedCourseCode.textContent = course.code;
                        
                        // Calculate course statistics based on actual student attendance
                        const scans = loadStudentScans();
                        const courseScans = scans.filter(s => s.courseCode === courseCode);
                        const totalSessionsAttended = courseScans.length;
                        const presentSessions = courseScans.filter(s => s.status === 'Present').length;
                        const absentSessions = courseScans.filter(s => s.status === 'Absent' || s.status === 'Late').length;
                        const attendanceRate = totalSessionsAttended > 0 ? Math.round((presentSessions / totalSessionsAttended) * 100) : 0;
                        
                        courseSessions.textContent = totalSessionsAttended;
                        courseAttendance.textContent = `${attendanceRate}%`;
                        
                        courseInfo.style.display = 'block';
                        startScanBtn.disabled = false;
                    } else {
                        courseInfo.style.display = 'none';
                        startScanBtn.disabled = true;
                    }
                } catch (e) {
                    console.error('Error updating course info:', e);
                }
            }

            // Scan specific QR code by session ID
            window.scanSpecificQR = function(sessionId){
                try {
                    const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                    const session = courseSessions.find(s => s.id === sessionId);
                    
                    if (session) {
                        handleQRCodeDetected(session);
                    } else {
                        alert('Session not found. Please refresh and try again.');
                    }
                } catch (e) {
                    console.error('Error scanning specific QR:', e);
                    alert('Error scanning QR code. Please try again.');
                }
            };

            function initializeScanner(){
                try {
                    // Check if camera is available
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        statusText.textContent = 'Camera not available';
                        scannerStatus.classList.add('error');
                        showCameraError('Camera not supported', 'Your device does not support camera access. Please use a device with a camera.');
                        return;
                    }
                    
                    // Check if jsQR library is loaded
                    if (typeof jsQR === 'undefined') {
                        statusText.textContent = 'QR Library not loaded';
                        scannerStatus.classList.add('error');
                        showCameraError('QR Library Missing', 'The QR code scanning library failed to load. Please refresh the page and try again.');
                        return;
                    }
                    
                    // Check if we're in a secure context (HTTPS or localhost)
                    if (!window.isSecureContext) {
                        statusText.textContent = 'Camera requires secure connection';
                        scannerStatus.classList.add('error');
                        showCameraError('Secure Connection Required', 'Camera access requires a secure connection (HTTPS). Please access this page through a secure connection.');
                        return;
                    }
                    
                    // Detect mobile device and set appropriate settings
                    const isMobile = detectMobileDevice();
                    if (isMobile) {
                        console.log('Mobile device detected, optimizing for mobile');
                        optimizeForMobile();
                    }
                    
                    statusText.textContent = 'Ready to Scan';
                    scannerStatus.classList.remove('error', 'scanning', 'success');
                    
                    // Initialize scanner state
                    scanning = false;
                    stream = null;
                    scanInterval = null;
                    
                    console.log('QR Scanner initialized successfully');
                } catch (error) {
                    console.error('Error initializing scanner:', error);
                    statusText.textContent = 'Scanner initialization failed';
                    scannerStatus.classList.add('error');
                    showCameraError('Initialization Error', 'Failed to initialize the QR scanner. Please refresh the page and try again.');
                }
            }

            // Detect mobile device
            function detectMobileDevice() {
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
                const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                const isSmallScreen = window.innerWidth <= 768;
                
                return isMobile || (isTouchDevice && isSmallScreen);
            }

            // Optimize scanner for mobile devices
            function optimizeForMobile() {
                // Add mobile-specific CSS classes
                document.body.classList.add('mobile-device');
                const scannerContainer = document.querySelector('.scanner-container');
                if (scannerContainer) {
                    scannerContainer.classList.add('mobile-optimized');
                }
                
                // Add mobile-specific instructions
                const instructions = document.querySelector('.scanner-instructions p');
                if (instructions) {
                    instructions.innerHTML = `
                        <i class="fas fa-qrcode" aria-hidden="true"></i> 
                        <span data-translate="scanner-mobile-instructions">Hold your device steady and position the QR code within the frame</span>
                    `;
                }
                
                // Add mobile-specific controls
                addMobileControls();
            }

            // Add mobile-specific controls
            function addMobileControls() {
                const scannerControls = document.querySelector('.scanner-controls');
                if (scannerControls && !document.getElementById('mobile-controls')) {
                    const mobileControls = document.createElement('div');
                    mobileControls.id = 'mobile-controls';
                    mobileControls.className = 'mobile-controls';
                    mobileControls.innerHTML = `
                        <button class="btn mobile-btn" id="flash-toggle-btn" style="display: none;">
                            <i class="fas fa-flashlight"></i>
                            <span data-translate="scanner-flash-on">Flash On</span>
                        </button>
                        <button class="btn mobile-btn" id="orientation-lock-btn">
                            <i class="fas fa-lock"></i>
                            <span data-translate="scanner-lock-orientation">Lock Orientation</span>
                        </button>
                        <button class="btn mobile-btn" id="fullscreen-btn">
                            <i class="fas fa-expand"></i>
                            <span data-translate="scanner-fullscreen">Fullscreen</span>
                        </button>
                    `;
                    scannerControls.appendChild(mobileControls);
                }
            }

            async function startScanner(){
                console.log('Start scanner button clicked');
                
                // Check if already scanning
                if (scanning) {
                    console.log('Scanner already running');
                    return;
                }
                
                try {
                    console.log('Requesting camera access...');
                    
                    // Show loading state
                    statusText.textContent = 'Requesting camera access...';
                    scannerStatus.classList.add('scanning');
                    startScanBtn.disabled = true;
                    
                    // Get mobile-optimized camera constraints
                    const constraints = getMobileOptimizedConstraints();
                    
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    console.log('Camera access granted');
                    
                    // Set up video element with mobile optimizations
                    setupMobileVideo();
                    
                    // Update UI
                    startScanBtn.style.display = 'none';
                    stopScanBtn.style.display = 'inline-block';
                    scanning = true;
                    statusText.textContent = 'Scanning...';
                    scannerStatus.classList.remove('error');
                    scannerStatus.classList.add('scanning');
                    
                    // Initialize mobile features
                    initializeMobileFeatures();
                    
                    // Start scanning for QR codes with mobile-optimized interval
                    const scanIntervalMs = detectMobileDevice() ? 300 : 500; // Faster on mobile
                    scanInterval = setInterval(scanForQRCode, scanIntervalMs);
                    console.log('Scanner started successfully');
                    
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    handleCameraError(error);
                } finally {
                    startScanBtn.disabled = false;
                }
            }

            // Get mobile-optimized camera constraints
            function getMobileOptimizedConstraints() {
                const isMobile = detectMobileDevice();
                
                if (isMobile) {
                    return {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920, min: 640 },
                            height: { ideal: 1080, min: 480 },
                            frameRate: { ideal: 30, max: 60 },
                            aspectRatio: { ideal: 16/9 },
                            // Mobile-specific constraints
                            focusMode: 'continuous',
                            whiteBalanceMode: 'continuous',
                            exposureMode: 'continuous'
                        }
                    };
                } else {
                    return {
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 },
                            frameRate: { ideal: 30, max: 60 }
                        } 
                    };
                }
            }

            // Set up video element with mobile optimizations
            function setupMobileVideo() {
                scannerVideo.srcObject = stream;
                
                // Mobile-specific video attributes
                if (detectMobileDevice()) {
                    scannerVideo.setAttribute('playsinline', 'true');
                    scannerVideo.setAttribute('webkit-playsinline', 'true');
                    scannerVideo.setAttribute('muted', 'true');
                    scannerVideo.style.objectFit = 'cover';
                }
                
                scannerVideo.onloadedmetadata = () => {
                    console.log('Video metadata loaded');
                    
                    // Mobile-specific setup
                    if (detectMobileDevice()) {
                        setupMobileVideoHandlers();
                    }
                    
                    scannerVideo.play().catch(e => console.error('Video play error:', e));
                };
            }

            // Set up mobile-specific video handlers
            function setupMobileVideoHandlers() {
                // Handle orientation changes
                const handleOrientationChange = () => {
                    setTimeout(() => {
                        if (scannerVideo.videoWidth && scannerVideo.videoHeight) {
                            adjustVideoForOrientation();
                        }
                    }, 100);
                };
                
                window.addEventListener('orientationchange', handleOrientationChange);
                window.addEventListener('resize', handleOrientationChange);
                
                // Handle video focus for better QR detection
                scannerVideo.addEventListener('loadeddata', () => {
                    if (stream && stream.getVideoTracks().length > 0) {
                        const track = stream.getVideoTracks()[0];
                        const capabilities = track.getCapabilities();
                        
                        // Enable autofocus if available
                        if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                            track.applyConstraints({ focusMode: 'continuous' });
                        }
                    }
                });
            }

            // Adjust video for device orientation
            function adjustVideoForOrientation() {
                const video = scannerVideo;
                const container = video.parentElement;
                
                if (video.videoWidth && video.videoHeight) {
                    const videoAspect = video.videoWidth / video.videoHeight;
                    const containerAspect = container.clientWidth / container.clientHeight;
                    
                    if (videoAspect > containerAspect) {
                        video.style.width = '100%';
                        video.style.height = 'auto';
                    } else {
                        video.style.width = 'auto';
                        video.style.height = '100%';
                    }
                }
            }

            // Initialize mobile-specific features
            function initializeMobileFeatures() {
                if (detectMobileDevice()) {
                    // Set up mobile control event listeners
                    setupMobileControlListeners();
                    
                    // Enable flash control if available
                    checkFlashAvailability();
                    
                    // Set up orientation lock
                    setupOrientationLock();
                    
                    // Set up fullscreen functionality
                    setupFullscreen();
                }
            }

            // Set up mobile control event listeners
            function setupMobileControlListeners() {
                // Flash toggle
                const flashBtn = document.getElementById('flash-toggle-btn');
                if (flashBtn) {
                    flashBtn.addEventListener('click', toggleFlash);
                }
                
                // Orientation lock
                const orientationBtn = document.getElementById('orientation-lock-btn');
                if (orientationBtn) {
                    orientationBtn.addEventListener('click', toggleOrientationLock);
                }
                
                // Fullscreen
                const fullscreenBtn = document.getElementById('fullscreen-btn');
                if (fullscreenBtn) {
                    fullscreenBtn.addEventListener('click', toggleFullscreen);
                }
            }

            // Check if flash is available
            async function checkFlashAvailability() {
                if (stream && stream.getVideoTracks().length > 0) {
                    const track = stream.getVideoTracks()[0];
                    const capabilities = track.getCapabilities();
                    
                    if (capabilities.torch) {
                        const flashBtn = document.getElementById('flash-toggle-btn');
                        if (flashBtn) {
                            flashBtn.style.display = 'inline-block';
                        }
                    }
                }
            }

            // Toggle flash
            async function toggleFlash() {
                if (stream && stream.getVideoTracks().length > 0) {
                    const track = stream.getVideoTracks()[0];
                    const flashBtn = document.getElementById('flash-toggle-btn');
                    
                    try {
                        const currentConstraints = track.getConstraints();
                        const newTorch = !currentConstraints.torch;
                        
                        await track.applyConstraints({ torch: newTorch });
                        
                        if (flashBtn) {
                            flashBtn.innerHTML = `
                                <i class="fas fa-${newTorch ? 'flashlight' : 'flashlight'}"></i>
                                <span data-translate="scanner-flash-${newTorch ? 'off' : 'on'}">Flash ${newTorch ? 'Off' : 'On'}</span>
                            `;
                        }
                    } catch (error) {
                        console.error('Error toggling flash:', error);
                    }
                }
            }

            // Toggle orientation lock
            function toggleOrientationLock() {
                const orientationBtn = document.getElementById('orientation-lock-btn');
                const isLocked = document.body.classList.contains('orientation-locked');
                
                if (isLocked) {
                    document.body.classList.remove('orientation-locked');
                    if (orientationBtn) {
                        orientationBtn.innerHTML = `
                            <i class="fas fa-lock"></i>
                            <span data-translate="scanner-lock-orientation">Lock Orientation</span>
                        `;
                    }
                } else {
                    document.body.classList.add('orientation-locked');
                    if (orientationBtn) {
                        orientationBtn.innerHTML = `
                            <i class="fas fa-unlock"></i>
                            <span data-translate="scanner-unlock-orientation">Unlock Orientation</span>
                        `;
                    }
                }
            }

            // Toggle fullscreen
            function toggleFullscreen() {
                const scannerContainer = document.querySelector('.scanner-container');
                const fullscreenBtn = document.getElementById('fullscreen-btn');
                
                if (!document.fullscreenElement) {
                    if (scannerContainer.requestFullscreen) {
                        scannerContainer.requestFullscreen();
                        if (fullscreenBtn) {
                            fullscreenBtn.innerHTML = `
                                <i class="fas fa-compress"></i>
                                <span data-translate="scanner-exit-fullscreen">Exit Fullscreen</span>
                            `;
                        }
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        if (fullscreenBtn) {
                            fullscreenBtn.innerHTML = `
                                <i class="fas fa-expand"></i>
                                <span data-translate="scanner-fullscreen">Fullscreen</span>
                            `;
                        }
                    }
                }
            }

            function stopScanner(){
                try {
                    console.log('Stopping scanner...');
                    
                    // Stop camera stream
                    if (stream) {
                        stream.getTracks().forEach(track => {
                            track.stop();
                            console.log('Camera track stopped');
                        });
                        stream = null;
                    }
                    
                    // Clear scanning interval
                    if (scanInterval) {
                        clearInterval(scanInterval);
                        scanInterval = null;
                    }
                    
                    // Reset video element
                    if (scannerVideo) {
                        scannerVideo.srcObject = null;
                    }
                    
                    // Update UI
                    startScanBtn.style.display = 'inline-block';
                    stopScanBtn.style.display = 'none';
                    scanning = false;
                    statusText.textContent = 'Ready to Scan';
                    scannerStatus.classList.remove('scanning', 'error', 'success');
                    
                    console.log('Scanner stopped successfully');
                } catch (error) {
                    console.error('Error stopping scanner:', error);
                    // Force reset even if there's an error
                    scanning = false;
                    startScanBtn.style.display = 'inline-block';
                    stopScanBtn.style.display = 'none';
                    statusText.textContent = 'Ready to Scan';
                    scannerStatus.classList.remove('scanning', 'error', 'success');
                }
            }

            function scanForQRCode(){
                if (!scanning || !scannerVideo.videoWidth) return;
                
                const context = scannerCanvas.getContext('2d');
                scannerCanvas.width = scannerVideo.videoWidth;
                scannerCanvas.height = scannerVideo.videoHeight;
                context.drawImage(scannerVideo, 0, 0);
                
                const imageData = context.getImageData(0, 0, scannerCanvas.width, scannerCanvas.height);
                
                // Use jsQR library for real QR code detection
                if (typeof jsQR !== 'undefined') {
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        console.log('QR Code detected:', code.data);
                        
                        try {
                            // Try to parse the QR code data as JSON (from lecturer)
                            const qrData = JSON.parse(code.data);
                            
                            // Validate the QR code data
                            const validationResult = validateQRCodeData(qrData);
                            if (validationResult.isValid) {
                                handleQRCodeDetected(validationResult.sessionData);
                            } else {
                                showQRValidationError(validationResult.error);
                            }
                        } catch (e) {
                            // If not JSON, treat as simple PIN
                            const pin = code.data;
                            const validationResult = validatePINCode(pin);
                            if (validationResult.isValid) {
                                handleQRCodeDetected(validationResult.sessionData);
                            } else {
                                showQRValidationError(validationResult.error);
                            }
                        }
                    }
                } else {
                    // Fallback to simulation if jsQR is not loaded
                    if (Math.random() < 0.05) { // 5% chance to simulate detection
                        const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                        const activeSession = courseSessions.find(s => s.status === 'active');
                        
                        if (!activeSession) {
                            showNoQRCodeDetected();
                            return;
                        }
                        
                        const validationResult = validateQRCode();
                        if (validationResult.isValid) {
                            handleQRCodeDetected(validationResult.sessionData);
                        } else {
                            showQRValidationError(validationResult.error);
                        }
                    }
                }
            }

            // Enhanced QR code validation with security checks
            function validateQRCodeData(qrData) {
                try {
                    // Check if QR data is valid object
                    if (!qrData || typeof qrData !== 'object') {
                        return {
                            isValid: false,
                            errorType: 'invalid_format',
                            error: 'Invalid QR code format.',
                            details: 'The QR code does not contain valid data.'
                        };
                    }
                    
                    // Check if QR data has required fields
                    if (!qrData.pin || !qrData.courseCode || !qrData.lecturerId) {
                        return {
                            isValid: false,
                            errorType: 'invalid_format',
                            error: 'Invalid QR code format. Missing required information.',
                            details: 'The QR code does not contain all necessary data fields.'
                        };
                    }
                    
                    // Validate PIN format (should be 4-6 digits)
                    if (!/^\d{4,6}$/.test(qrData.pin)) {
                        return {
                            isValid: false,
                            errorType: 'invalid_pin',
                            error: 'Invalid PIN format.',
                            details: 'The PIN should be 4-6 digits only.'
                        };
                    }
                    
                    // Validate course code format
                    if (!/^[A-Z]{2,4}-\d{3}$/.test(qrData.courseCode)) {
                        return {
                            isValid: false,
                            errorType: 'invalid_course',
                            error: 'Invalid course code format.',
                            details: 'The course code should be in format like "HCI-201".'
                        };
                    }
                    
                    // Check for suspicious data patterns
                    if (qrData.pin.length > 10 || qrData.courseCode.length > 20) {
                        return {
                            isValid: false,
                            errorType: 'suspicious_data',
                            error: 'Suspicious QR code data.',
                            details: 'The QR code contains data that appears to be invalid.'
                        };
                    }

                    // Check if the session exists and is active
                    const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                    const activeSession = courseSessions.find(s => 
                        s.pin === qrData.pin && 
                        s.courseCode === qrData.courseCode && 
                        s.status === 'active'
                    );

                    if (!activeSession) {
                        // Check if session exists but is inactive
                        const inactiveSession = courseSessions.find(s => 
                            s.pin === qrData.pin && 
                            s.courseCode === qrData.courseCode
                        );

                        if (inactiveSession) {
                            return {
                                isValid: false,
                                errorType: 'session_expired',
                                error: 'QR code session has expired.',
                                details: 'This QR code was valid but the session has ended. Please ask the lecturer to generate a new QR code.'
                            };
                        } else {
                            return {
                                isValid: false,
                                errorType: 'session_not_found',
                                error: 'QR code session not found.',
                                details: 'This QR code does not match any active session. Please ensure the lecturer has generated a QR code for this class.'
                            };
                        }
                    }

                    // Validate lecturer
                    const lecturers = JSON.parse(localStorage.getItem('lecturers') || '[]');
                    const validLecturer = lecturers.find(l => l.id === qrData.lecturerId);
                    
                    if (!validLecturer) {
                        return {
                            isValid: false,
                            errorType: 'unauthorized_lecturer',
                            error: 'Invalid QR code: Lecturer not authorized.',
                            details: 'This QR code was generated by an unauthorized lecturer.'
                        };
                    }

                    // Check if session has expired
                    let status = 'active';
                    let expiresText = 'No expiration set';
                    
                    if (activeSession.expiresAt && activeSession.expiresAt !== null) {
                        const expiresAt = new Date(activeSession.expiresAt);
                        const now = new Date();
                        if (expiresAt < now) {
                            status = 'Expired';
                            expiresText = 'Expired';
                            return {
                                isValid: false,
                                errorType: 'session_expired',
                                error: 'QR code session has expired.',
                                details: 'This QR code was valid but has expired. Please ask the lecturer to generate a new QR code.'
                            };
                        } else {
                            const diffMs = expiresAt - now;
                            const diffMins = Math.ceil(diffMs / 60000);
                            expiresText = `${diffMins} minutes remaining`;
                        }
                    }

                    return {
                        isValid: true,
                        sessionData: {
                            pin: qrData.pin,
                            courseCode: qrData.courseCode,
                            courseName: qrData.courseName || activeSession.courseName,
                            sessionId: qrData.sessionId || activeSession.id,
                            lecturerId: qrData.lecturerId,
                            lecturerName: qrData.lecturerName || validLecturer.name,
                            status: status,
                            created: activeSession.created,
                            expiresAt: activeSession.expiresAt,
                            expiresText: expiresText
                        }
                    };

                } catch (e) {
                    return {
                        isValid: false,
                        errorType: 'processing_error',
                        error: 'Error processing QR code data.',
                        details: 'An error occurred while processing the QR code. Please try again.'
                    };
                }
            }

            // Validate PIN code (fallback for simple PIN QR codes) - enhanced with detailed feedback
            function validatePINCode(pin) {
                try {
                    const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                    const activeSession = courseSessions.find(s => s.pin === pin && s.status === 'active');

                    if (!activeSession) {
                        // Check if PIN exists but session is inactive
                        const inactiveSession = courseSessions.find(s => s.pin === pin);

                        if (inactiveSession) {
                            return {
                                isValid: false,
                                errorType: 'session_expired',
                                error: 'PIN session has expired.',
                                details: 'This PIN was valid but the session has ended. Please ask the lecturer to generate a new QR code.'
                            };
                        } else {
                            return {
                                isValid: false,
                                errorType: 'pin_not_found',
                                error: 'PIN not found.',
                                details: 'This PIN does not match any active session. Please ensure the lecturer has generated a QR code for this class.'
                            };
                        }
                    }

                    // Check if session has expired
                    let status = 'active';
                    let expiresText = 'No expiration set';
                    
                    if (activeSession.expiresAt && activeSession.expiresAt !== null) {
                        const expiresAt = new Date(activeSession.expiresAt);
                        const now = new Date();
                        if (expiresAt < now) {
                            status = 'Expired';
                            expiresText = 'Expired';
                            return {
                                isValid: false,
                                errorType: 'session_expired',
                                error: 'PIN session has expired.',
                                details: 'This PIN was valid but has expired. Please ask the lecturer to generate a new QR code.'
                            };
                        } else {
                            const diffMs = expiresAt - now;
                            const diffMins = Math.ceil(diffMs / 60000);
                            expiresText = `${diffMins} minutes remaining`;
                        }
                    }

                    return {
                        isValid: true,
                        sessionData: {
                            pin: activeSession.pin,
                            courseCode: activeSession.courseCode,
                            courseName: activeSession.courseName,
                            sessionId: activeSession.id,
                            lecturerId: activeSession.lecturerId,
                            lecturerName: activeSession.lecturerName,
                            status: status,
                            created: activeSession.created,
                            expiresAt: activeSession.expiresAt,
                            expiresText: expiresText
                        }
                    };

                } catch (e) {
                    return {
                        isValid: false,
                        errorType: 'processing_error',
                        error: 'Error validating PIN.',
                        details: 'An error occurred while validating the PIN. Please try again.'
                    };
                }
            }

            // Show "No QR code detected" message (enhanced like PIN section)
            function showNoQRCodeDetected() {
                stopScanner();
                
                statusText.textContent = 'No QR Code Detected';
                scannerStatus.classList.remove('scanning');
                scannerStatus.classList.add('error');
                
                // Show detailed no QR code message
                const noQRDiv = document.createElement('div');
                noQRDiv.className = 'no-qr-detected-message';
                noQRDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #ffc107;
                    color: #856404;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    max-width: 450px;
                    text-align: center;
                `;
                noQRDiv.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <h3 style="margin: 10px 0;">No QR Code Detected</h3>
                    <p style="margin: 10px 0;">No active QR code is currently being displayed by any lecturer.</p>
                    <p style="font-size: 14px; margin: 10px 0; opacity: 0.8;">
                        Please ensure a lecturer has generated and is displaying a QR code before scanning.
                    </p>
                    <div style="margin-top: 15px;">
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: #856404;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">OK</button>
                        <button onclick="this.parentElement.parentElement.remove(); document.getElementById('check-qr-status-btn').click();" style="
                            background: rgba(133, 100, 4, 0.2);
                            color: #856404;
                            border: 1px solid #856404;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                        ">Check Status</button>
                    </div>
                `;
                
                document.body.appendChild(noQRDiv);
                
                // Auto-remove after 7 seconds
                setTimeout(() => {
                    if (noQRDiv.parentElement) {
                        noQRDiv.remove();
                    }
                    // Reset scanner status
                    statusText.textContent = 'Ready to Scan';
                    scannerStatus.classList.remove('error');
                }, 7000);
            }

            // Validate QR code to ensure it's from a legitimate lecturer and currently displayed
            function validateQRCode() {
                try {
                    // Get active course sessions from localStorage
                    const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                    const activeSession = courseSessions.find(s => s.status === 'active');
                    
                    if (!activeSession) {
                        return {
                            isValid: false,
                            error: 'No active QR code session found. Please ensure a lecturer has generated and is displaying a QR code.'
                        };
                    }

                    // Check if the session has proper lecturer data
                    if (!activeSession.lecturerId || !activeSession.lecturerName) {
                        return {
                            isValid: false,
                            error: 'Invalid QR code: Missing lecturer information. This QR code was not generated by a legitimate lecturer.'
                        };
                    }

                    // Check if the session is not expired
                    if (activeSession.expiresAt && activeSession.expiresAt !== null && new Date(activeSession.expiresAt) < new Date()) {
                        return {
                            isValid: false,
                            error: 'QR code has expired. Please ask the lecturer to generate a new QR code.'
                        };
                    }

                    // Check if the session was created recently (within last 2 hours)
                    const sessionCreated = new Date(activeSession.created);
                    const now = new Date();
                    const timeDiff = now - sessionCreated;
                    const maxAge = 2 * 60 * 60 * 1000; // 2 hours in milliseconds

                    if (timeDiff > maxAge) {
                        return {
                            isValid: false,
                            error: 'QR code is too old. Please ask the lecturer to generate a fresh QR code.'
                        };
                    }

                    // Validate lecturer credentials (check if lecturer exists in system)
                    const lecturers = JSON.parse(localStorage.getItem('lecturers') || '[]');
                    const validLecturer = lecturers.find(l => l.id === activeSession.lecturerId || l.email === activeSession.lecturerId);
                    
                    if (!validLecturer) {
                        return {
                            isValid: false,
                            error: 'Invalid QR code: Lecturer not found in system. This QR code was not generated by an authorized lecturer.'
                        };
                    }

                    // Check if the course exists and is valid
                    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                    const validCourse = courses.find(c => c.code === activeSession.courseCode);
                    
                    if (!validCourse) {
                        return {
                            isValid: false,
                            error: 'Invalid QR code: Course not found in system.'
                        };
                    }

                    // All validations passed
                    return {
                        isValid: true,
                        sessionData: {
                            pin: activeSession.pin,
                            courseCode: activeSession.courseCode,
                            courseName: activeSession.courseName,
                            sessionId: activeSession.id,
                            lecturerId: activeSession.lecturerId,
                            lecturerName: activeSession.lecturerName,
                            status: activeSession.status,
                            created: activeSession.created,
                            expiresAt: activeSession.expiresAt
                        }
                    };

                } catch (e) {
                    console.error('Error validating QR code:', e);
                    return {
                        isValid: false,
                        error: 'Error validating QR code. Please try again or ask the lecturer to generate a new QR code.'
                    };
                }
            }

            // Show QR validation error to user (enhanced with detailed feedback like PIN section)
            function showQRValidationError(validationResult) {
                const errorMessage = validationResult.error || 'Unknown error';
                const errorType = validationResult.errorType || 'unknown';
                const details = validationResult.details || '';
                
                // Update scanner status
                statusText.textContent = getErrorStatusText(errorType);
                scannerStatus.classList.remove('scanning');
                scannerStatus.classList.add('error');
                
                // Show detailed error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'qr-validation-error';
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: ${getErrorBackgroundColor(errorType)};
                    color: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 1000;
                    max-width: 450px;
                    text-align: center;
                `;
                
                const icon = getErrorIcon(errorType);
                errorDiv.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 10px;">${icon}</div>
                    <h3 style="margin: 10px 0;">${errorMessage}</h3>
                    ${details ? `<p style="font-size: 14px; opacity: 0.9; margin: 10px 0;">${details}</p>` : ''}
                    <div style="margin-top: 15px;">
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: white;
                            color: ${getErrorBackgroundColor(errorType)};
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            margin-right: 10px;
                        ">OK</button>
                        <button onclick="this.parentElement.parentElement.remove(); document.getElementById('start-scan-btn').click();" style="
                            background: rgba(255,255,255,0.2);
                            color: white;
                            border: 1px solid white;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                        ">Try Again</button>
                    </div>
                `;
                
                document.body.appendChild(errorDiv);
                
                // Auto-remove after 7 seconds
                setTimeout(() => {
                    if (errorDiv.parentElement) {
                        errorDiv.remove();
                    }
                    // Reset scanner status
                    statusText.textContent = 'Ready to Scan';
                    scannerStatus.classList.remove('error');
                }, 7000);
            }

            // Helper functions for error display
            function getErrorStatusText(errorType) {
                switch (errorType) {
                    case 'invalid_format': return 'Invalid QR Format';
                    case 'session_expired': return 'Session Expired';
                    case 'session_not_found': return 'Session Not Found';
                    case 'pin_not_found': return 'PIN Not Found';
                    case 'unauthorized_lecturer': return 'Unauthorized Lecturer';
                    case 'processing_error': return 'Processing Error';
                    default: return 'QR Code Error';
                }
            }

            function getErrorBackgroundColor(errorType) {
                switch (errorType) {
                    case 'session_expired': return '#ffc107';
                    case 'session_not_found': return '#17a2b8';
                    case 'pin_not_found': return '#17a2b8';
                    case 'unauthorized_lecturer': return '#dc3545';
                    case 'processing_error': return '#6c757d';
                    default: return '#ff4444';
                }
            }

            function getErrorIcon(errorType) {
                switch (errorType) {
                    case 'session_expired': return '<i class="fas fa-clock"></i>';
                    case 'session_not_found': return '<i class="fas fa-search"></i>';
                    case 'pin_not_found': return '<i class="fas fa-key"></i>';
                    case 'unauthorized_lecturer': return '<i class="fas fa-user-times"></i>';
                    case 'processing_error': return '<i class="fas fa-exclamation-triangle"></i>';
                    default: return '<i class="fas fa-times-circle"></i>';
                }
            }

            function handleQRCodeDetected(data){
                try {
                    stopScanner();
                    
                    // Check if session is expired
                    if (data.expiresAt && new Date(data.expiresAt) < new Date()) {
                        data.status = 'Expired';
                    }
                    
                    // Display scan result
                    document.getElementById('scanned-pin').textContent = data.pin || 'N/A';
                    document.getElementById('scanned-course').textContent = data.courseName || data.courseCode || 'Unknown Course';
                    document.getElementById('scanned-lecturer').textContent = data.lecturerName || 'Unknown Lecturer';
                    document.getElementById('scanned-session').textContent = data.sessionId || 'N/A';
                    document.getElementById('scanned-status').textContent = data.status || 'Unknown';
                    
                    scannerResults.style.display = 'block';
                    statusText.textContent = 'QR Code Detected';
                    scannerStatus.classList.remove('scanning');
                    scannerStatus.classList.add('success');
                    
                    // Store the scanned data for attendance marking
                    window.lastScannedData = data;
                    
                    console.log('QR Code successfully processed:', data);
                } catch (error) {
                    console.error('Error handling QR code detection:', error);
                    showQRValidationError({
                        error: 'Error processing QR code',
                        details: 'An error occurred while processing the scanned QR code. Please try again.'
                    });
                }
            }

            // Enhanced camera error handling
            function handleCameraError(error) {
                console.error('Camera error:', error);
                
                let errorMessage = 'Camera access failed';
                let errorDetails = 'Please check your camera permissions and try again.';
                
                switch (error.name) {
                    case 'NotAllowedError':
                        errorMessage = 'Camera access denied';
                        errorDetails = 'Please allow camera permissions in your browser settings and try again.';
                        break;
                    case 'NotFoundError':
                        errorMessage = 'No camera found';
                        errorDetails = 'No camera detected on this device. Please use a device with a camera.';
                        break;
                    case 'NotReadableError':
                        errorMessage = 'Camera in use';
                        errorDetails = 'Camera is being used by another application. Please close other apps and try again.';
                        break;
                    case 'OverconstrainedError':
                        errorMessage = 'Camera constraints not met';
                        errorDetails = 'Camera does not support the required settings. Please try again.';
                        break;
                    case 'SecurityError':
                        errorMessage = 'Security error';
                        errorDetails = 'Camera access blocked due to security restrictions. Please use HTTPS.';
                        break;
                    default:
                        errorMessage = 'Camera error';
                        errorDetails = error.message || 'An unknown error occurred while accessing the camera.';
                }
                
                statusText.textContent = errorMessage;
                scannerStatus.classList.add('error');
                showCameraError(errorMessage, errorDetails);
            }

            // Show camera error modal
            function showCameraError(title, message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'camera-error-modal';
                errorDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                errorDiv.innerHTML = `
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 12px;
                        max-width: 500px;
                        margin: 20px;
                        text-align: center;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                    ">
                        <div style="color: #dc3545; font-size: 48px; margin-bottom: 20px;">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 style="color: #333; margin-bottom: 15px;">${title}</h3>
                        <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">${message}</p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button onclick="this.closest('.camera-error-modal').remove()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 6px;
                                cursor: pointer;
                            ">Close</button>
                            <button onclick="location.reload()" style="
                                background: #007bff;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 6px;
                                cursor: pointer;
                            ">Refresh Page</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(errorDiv);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (errorDiv.parentElement) {
                        errorDiv.remove();
                    }
                }, 10000);
            }

            function markAttendance(){
                if (!window.lastScannedData) {
                    alert('No QR code data available. Please scan a QR code first.');
                    return;
                }
                
                const data = window.lastScannedData;
                
                if (data.status === 'Expired' || data.status === 'closed') {
                    alert('This QR code has expired. Please ask the lecturer for a new one.');
                    return;
                }
                
                // Record the scan
                const scan = {
                    id: 'SCAN' + Date.now(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    pin: data.pin,
                    courseCode: data.courseCode,
                    courseName: data.courseName,
                    lecturerId: data.lecturerId,
                    lecturerName: data.lecturerName,
                    sessionId: data.sessionId,
                    status: 'Absent',
                    studentId: currentUser.studentId || '231031149', // This would come from the logged-in student
                    studentName: currentUser.name || 'Bukho Skweza' // This would come from the logged-in student
                };
                
                const scans = loadStudentScans();
                scans.unshift(scan);
                saveStudentScans(scans);
                
                // Update lecturer sessions (for attendance tracking)
                updateLecturerSessions(scan);
                
                // Add to scan history
                addToScanHistory(scan);
                
                alert('Attendance marked successfully!');
                closeScannerResults();
                loadRecentScans();
                
                // Clear the stored data
                window.lastScannedData = null;
            }

            // Add scan to history
            function addToScanHistory(scanRecord) {
                const scanHistory = JSON.parse(localStorage.getItem('scanHistory') || '[]');
                scanHistory.unshift({
                    ...scanRecord,
                    scanTime: new Date().toISOString(),
                    success: true
                });
                
                // Keep only last 50 scans
                if (scanHistory.length > 50) {
                    scanHistory.splice(50);
                }
                
                localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
            }

            // Load and display scan history
            function loadScanHistory() {
                const scanHistory = JSON.parse(localStorage.getItem('scanHistory') || '[]');
                const historyContainer = document.getElementById('scan-history-list');
                
                if (!historyContainer) return;
                
                if (scanHistory.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No scan history available</p>';
                    return;
                }
                
                historyContainer.innerHTML = scanHistory.map(scan => `
                    <div class="scan-history-item ${scan.success ? 'success' : 'failed'}">
                        <div class="scan-info">
                            <div class="scan-course">${scan.courseName} (${scan.courseCode})</div>
                            <div class="scan-details">
                                <span class="scan-time">${new Date(scan.scanTime).toLocaleString()}</span>
                                <span class="scan-status">${scan.status}</span>
                            </div>
                        </div>
                        <div class="scan-result">
                            <i class="fas ${scan.success ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                        </div>
                    </div>
                `).join('');
            }

            function updateLecturerSessions(attendanceRecord){
                try {
                    // Get existing attendance records
                    const attendanceRecords = JSON.parse(localStorage.getItem('courseAttendanceRecords') || '[]');
                    
                    // Add the new attendance record
                    attendanceRecords.push({
                        ...attendanceRecord,
                        timestamp: new Date().toISOString()
                    });
                    
                    // Save back to localStorage
                    localStorage.setItem('courseAttendanceRecords', JSON.stringify(attendanceRecords));
                    
                    console.log('Attendance record saved:', attendanceRecord);
                } catch (e) {
                    console.warn('Failed to save attendance record:', e);
                }
            }

            function submitManualPin(){
                const pin = manualPinInput.value.trim();
                if (!pin) {
                    alert('Please enter a PIN');
                    return;
                }
                
                // Simulate QR code data from PIN
                const mockQRData = {
                    pin: pin,
                    course: 'HCI',
                    lecturer: 'Dr. Soetsang',
                    sessionId: 'SESS' + Date.now(),
                    status: 'Active'
                };
                
                handleQRCodeDetected(mockQRData);
                manualPinInput.value = '';
            }

            function closeScannerResults(){
                scannerResults.style.display = 'none';
                statusText.textContent = 'Ready to Scan';
                scannerStatus.classList.remove('success');
            }

            function loadRecentScans(){
                const scans = loadStudentScans();
                recentScansTbody.innerHTML = '';
                
                if (!scans.length){
                    const tr = document.createElement('tr');
                    const td = document.createElement('td'); td.colSpan = 7; td.className = 'centered-cell'; td.textContent = 'No recent scans found.';
                    tr.appendChild(td); recentScansTbody.appendChild(tr); return;
                }
                
                scans.slice(0, 10).forEach(scan => { // Show last 10 scans
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${scan.date || ''}</td>
                        <td>${scan.time || ''}</td>
                        <td>${scan.pin || ''}</td>
                        <td>${scan.course || ''}</td>
                        <td>${scan.lecturer || ''}</td>
                        <td><span class="status-badge present">${scan.status || ''}</span></td>
                        <td>
                            <button class="btn btn-small" data-view-scan="${scan.id}">View</button>
                        </td>`;
                    recentScansTbody.appendChild(tr);
                });

                // Add event listeners for view scan buttons in recent scans
                recentScansTbody.querySelectorAll('[data-view-scan]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const scanId = btn.getAttribute('data-view-scan');
                        const scan = scans.find(s => s.id === scanId);
                        if (scan) {
                            showScanDetails(scan);
                        }
                    });
                });
            }

            function showScanDetails(scan) {
                // Create a modal or detailed view for scan information
                const modal = document.createElement('div');
                modal.className = 'scan-details-modal';
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    padding: 30px;
                    border-radius: 12px;
                    max-width: 500px;
                    width: 90%;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                `;

                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #333;">Scan Details</h3>
                        <button class="close-modal" style="
                            background: none;
                            border: none;
                            font-size: 24px;
                            cursor: pointer;
                            color: #666;
                            padding: 0;
                            width: 30px;
                            height: 30px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        ">&times;</button>
                    </div>
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <strong>Date:</strong>
                            <span>${scan.date || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <strong>Time:</strong>
                            <span>${scan.time || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <strong>PIN:</strong>
                            <span>${scan.pin || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <strong>Course:</strong>
                            <span>${scan.course || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <strong>Lecturer:</strong>
                            <span>${scan.lecturer || 'N/A'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <strong>Status:</strong>
                            <span class="status-badge ${scan.status === 'Present' ? 'present' : 'absent'}">${scan.status || 'N/A'}</span>
                        </div>
                        ${scan.sessionId ? `
                        <div style="display: flex; justify-content: space-between; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            <strong>Session ID:</strong>
                            <span>${scan.sessionId}</span>
                        </div>
                        ` : ''}
                    </div>
                `;

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                // Close modal functionality
                const closeModal = () => {
                    document.body.removeChild(modal);
                };

                modalContent.querySelector('.close-modal').addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });

                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            }

            // Event listeners for scanner
            console.log('Setting up scanner event listeners...');
            console.log('Start scan button element:', startScanBtn);
            
            if (startScanBtn) {
                // Test if button is clickable
                startScanBtn.style.cursor = 'pointer';
                startScanBtn.title = 'Click to start QR scanner';
                
                startScanBtn.addEventListener('click', function(e) {
                    console.log('Start scanner button clicked via event listener');
                    e.preventDefault();
                    e.stopPropagation();
                    startScanner();
                });
                console.log('Start scanner event listener attached');
                
                // Add a test click handler to verify the button works
                startScanBtn.addEventListener('mousedown', function() {
                    console.log('Start scanner button mousedown detected');
                });
                
            } else {
                console.error('Start scan button not found!');
            }
            
            stopScanBtn?.addEventListener('click', stopScanner);
            closeResultBtn?.addEventListener('click', closeScannerResults);
            markAttendanceBtn?.addEventListener('click', markAttendance);
            submitPinBtn?.addEventListener('click', submitManualPin);

            // Event listeners for course selection
            scannerCourseSelect?.addEventListener('change', (e) => {
                const courseCode = e.target.value;
                if (courseCode) {
                    updateCourseInfo(courseCode);
                    loadCourseQRCodes(courseCode);
                } else {
                    courseInfo.style.display = 'none';
                    startScanBtn.disabled = true;
                    qrCodesGrid.innerHTML = `
                        <div class="qr-placeholder">
                            <i class="fas fa-qrcode"></i>
                            <p>Select a course to view available QR codes</p>
                        </div>
                    `;
                }
            });

            refreshCoursesBtn?.addEventListener('click', () => {
                loadScannerCourses();
                if (scannerCourseSelect.value) {
                    updateCourseInfo(scannerCourseSelect.value);
                    loadCourseQRCodes(scannerCourseSelect.value);
                }
            });

            // Add event listener for Check QR Status button
            const checkQRStatusBtn = document.getElementById('check-qr-status-btn');
            checkQRStatusBtn?.addEventListener('click', () => {
                const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                const activeSession = courseSessions.find(s => s.status === 'active');
                
                if (activeSession) {
                    // Show QR code available message
                    const statusDiv = document.createElement('div');
                    statusDiv.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: #28a745;
                        color: white;
                        padding: 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        z-index: 1000;
                        max-width: 400px;
                        text-align: center;
                    `;
                    statusDiv.innerHTML = `
                        <h3><i class="fas fa-check-circle" style="margin-right: 8px;"></i>QR Code Available</h3>
                        <p><strong>Course:</strong> ${activeSession.courseName} (${activeSession.courseCode})</p>
                        <p><strong>Lecturer:</strong> ${activeSession.lecturerName}</p>
                        <p><strong>PIN:</strong> ${activeSession.pin}</p>
                        <p style="font-size: 14px; margin-top: 10px; opacity: 0.9;">
                            You can now scan this QR code for attendance.
                        </p>
                        <button onclick="this.parentElement.remove()" style="
                            background: white;
                            color: #28a745;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            margin-top: 15px;
                        ">OK</button>
                    `;
                    document.body.appendChild(statusDiv);
                    
                    setTimeout(() => {
                        if (statusDiv.parentElement) {
                            statusDiv.remove();
                        }
                    }, 5000);
                } else {
                    // Show no QR code message
                    showNoQRCodeDetected();
                }
            });

            // ===== PIN Entry Management =====
            const pinInputElements = [
                document.getElementById('pin-input-1'),
                document.getElementById('pin-input-2'),
                document.getElementById('pin-input-3'),
                document.getElementById('pin-input-4'),
                document.getElementById('pin-input-5'),
                document.getElementById('pin-input-6')
            ];
            const submitPinEntryBtn = document.getElementById('submit-pin-entry-btn');
            const clearPinBtn = document.getElementById('clear-pin-btn');
            const pinResults = document.getElementById('pin-results');
            const closePinResultBtn = document.getElementById('close-pin-result-btn');
            const markPinAttendanceBtn = document.getElementById('mark-pin-attendance-btn');
            const quickPinInput = document.getElementById('quick-pin');
            const quickSubmitPinBtn = document.getElementById('quick-submit-pin-btn');
            const pinHistoryTbody = document.getElementById('pin-history-tbody');
            const pinStatusText = document.getElementById('pin-status-text');
            const pinStatus = document.getElementById('pin-status');

            function loadPinEntries(){
                try { return JSON.parse(localStorage.getItem('studentPinEntries') || '[]'); } catch { return []; }
            }
            function savePinEntries(entries){ localStorage.setItem('studentPinEntries', JSON.stringify(entries)); }

            function initializePinEntry(){
                pinStatusText.textContent = 'Ready to Enter PIN';
                pinStatus.classList.remove('error', 'verifying', 'success');
                
                // Set up PIN input navigation
                pinInputElements.forEach((input, index) => {
                    input.addEventListener('input', (e) => {
                        const value = e.target.value;
                        if (value && /^[0-9]$/.test(value)) {
                            if (index < pinInputElements.length - 1) {
                                pinInputElements[index + 1].focus();
                            }
                        }
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && !e.target.value && index > 0) {
                            pinInputElements[index - 1].focus();
                        }
                    });
                });
            }

            function getPinFromInputs(){
                return pinInputElements.map(input => input.value).join('');
            }

            function clearPinInputs(){
                pinInputElements.forEach(input => {
                    input.value = '';
                });
                pinInputElements[0].focus();
            }

            function validatePin(pin){
                if (!pin || pin.length !== 6) {
                    return { valid: false, message: 'PIN must be 6 digits' };
                }
                if (!/^[0-9]{6}$/.test(pin)) {
                    return { valid: false, message: 'PIN must contain only numbers' };
                }
                return { valid: true };
            }

            async function verifyPin(pin){
                // Verify PIN against Firestore first, then localStorage as fallback
                try {
                    let activeSession = null;
                    if (window.FirebaseDB && window.FirebaseDB.init()) {
                        const fbSession = await window.FirebaseDB.findActiveSessionByPin(pin);
                        if (fbSession) {
                            activeSession = {
                                id: fbSession.sessionId || fbSession.id,
                                courseCode: fbSession.courseCode,
                                courseName: fbSession.courseName,
                                lecturerId: fbSession.lecturerId,
                                lecturerName: fbSession.lecturerName,
                                expiresAt: fbSession.expiresAt,
                                created: fbSession.createdAt,
                                pin: fbSession.pin,
                                status: fbSession.status
                            };
                        }
                    }

                    if (!activeSession) {
                        const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                        activeSession = courseSessions.find(s => s.pin === pin && s.status === 'active');
                    }

                    if (activeSession) {
                        // Check expiry
                        let status = 'active';
                        let expiresText = 'No expiration set';
                        if (activeSession.expiresAt) {
                            const expiresAt = new Date(activeSession.expiresAt);
                            const now = new Date();
                            if (expiresAt < now) {
                                status = 'Expired';
                                expiresText = 'Expired';
                            } else {
                                const diffMs = expiresAt - now;
                                const diffMins = Math.ceil(diffMs / 60000);
                                expiresText = `${diffMins} minutes remaining`;
                            }
                        }

                        return {
                            valid: true,
                            data: {
                                pin: pin,
                                courseCode: activeSession.courseCode,
                                courseName: activeSession.courseName,
                                lecturerId: activeSession.lecturerId || 'L001',
                                lecturerName: activeSession.lecturerName || 'Dr. Lecturer',
                                sessionId: activeSession.id,
                                status: status,
                                expires: expiresText,
                                created: activeSession.created
                            }
                        };
                    }

                    return { valid: false, message: 'Invalid or expired PIN' };
                } catch (e) {
                    console.warn('Error verifying PIN:', e);
                    return { valid: false, message: 'Error verifying PIN' };
                }
            }

            function submitPinEntry(){
                const pin = getPinFromInputs();
                const validation = validatePin(pin);
                
                if (!validation.valid) {
                    alert(validation.message);
                    return;
                }

                pinStatusText.textContent = 'Verifying PIN...';
                pinStatus.classList.add('verifying');
                
                // Simulate verification delay
                setTimeout(async () => {
                    const verification = await verifyPin(pin);
                    
                    if (verification.valid) {
                        displayPinResult(verification.data);
                        pinStatusText.textContent = 'PIN Verified';
                        pinStatus.classList.remove('verifying');
                        pinStatus.classList.add('success');
                    } else {
                        alert(verification.message);
                        pinStatusText.textContent = 'PIN Invalid';
                        pinStatus.classList.remove('verifying');
                        pinStatus.classList.add('error');
                        setTimeout(() => {
                            pinStatusText.textContent = 'Ready to Enter PIN';
                            pinStatus.classList.remove('error');
                        }, 2000);
                    }
                }, 1000);
            }

            function displayPinResult(data){
                document.getElementById('verified-pin').textContent = data.pin;
                document.getElementById('verified-course').textContent = data.courseName || data.courseCode;
                document.getElementById('verified-lecturer').textContent = data.lecturerName || 'Unknown';
                document.getElementById('verified-session').textContent = data.sessionId;
                document.getElementById('verified-status').textContent = data.status;
                document.getElementById('verified-expires').textContent = data.expires;
                
                pinResults.style.display = 'block';
                
                // Store the verified data for attendance marking
                window.lastVerifiedData = data;
            }

            function markPinAttendance(){
                if (!window.lastVerifiedData) {
                    alert('No PIN verification data available. Please verify a PIN first.');
                    return;
                }
                
                const data = window.lastVerifiedData;
                
                if (data.status === 'Expired') {
                    alert('This PIN has expired. Please ask the lecturer for a new one.');
                    return;
                }
                
                // Record the PIN entry
                const entry = {
                    id: 'PIN' + Date.now(),
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    pin: data.pin,
                    courseCode: data.courseCode,
                    courseName: data.courseName,
                    lecturerId: data.lecturerId,
                    lecturerName: data.lecturerName,
                    sessionId: data.sessionId,
                    status: 'Present',
                    studentId: currentUser.studentId || '231031149', // This would come from the logged-in student
                    studentName: currentUser.name || 'Bukho Skweza' // This would come from the logged-in student
                };
                
                const entries = loadPinEntries();
                entries.unshift(entry);
                savePinEntries(entries);
                
                // Update lecturer sessions (for attendance tracking)
                updateLecturerSessions(entry);
                
                alert('Attendance marked successfully!');
                closePinResults();
                loadPinHistory();
                clearPinInputs();
                
                // Clear the stored data
                window.lastVerifiedData = null;
            }

            function closePinResults(){
                pinResults.style.display = 'none';
                pinStatusText.textContent = 'Ready to Enter PIN';
                pinStatus.classList.remove('success');
            }

            function quickSubmitPin(){
                const pin = quickPinInput.value.trim();
                const validation = validatePin(pin);
                
                if (!validation.valid) {
                    alert(validation.message);
                    return;
                }

                // Fill the individual PIN inputs
                pinInputElements.forEach((input, index) => {
                    input.value = pin[index] || '';
                });

                submitPinEntry();
                quickPinInput.value = '';
            }

            function loadPinHistory(){
                const entries = loadPinEntries();
                pinHistoryTbody.innerHTML = '';
                
                if (!entries.length){
                    const tr = document.createElement('tr');
                    const td = document.createElement('td'); td.colSpan = 7; td.className = 'centered-cell'; td.textContent = 'No PIN entries found.';
                    tr.appendChild(td); pinHistoryTbody.appendChild(tr); return;
                }
                
                entries.slice(0, 10).forEach(entry => { // Show last 10 entries
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${entry.date || ''}</td>
                        <td>${entry.time || ''}</td>
                        <td>${entry.pin || ''}</td>
                        <td>${entry.course || ''}</td>
                        <td>${entry.lecturer || ''}</td>
                        <td><span class="status-badge present">${entry.status || ''}</span></td>
                        <td>
                            <button class="btn btn-small" data-view-entry="${entry.id}">View</button>
                        </td>`;
                    pinHistoryTbody.appendChild(tr);
                });
            }

            // Event listeners for PIN entry
            submitPinEntryBtn?.addEventListener('click', submitPinEntry);
            clearPinBtn?.addEventListener('click', clearPinInputs);
            closePinResultBtn?.addEventListener('click', closePinResults);
            markPinAttendanceBtn?.addEventListener('click', markPinAttendance);
            quickSubmitPinBtn?.addEventListener('click', quickSubmitPin);

            // ===== Attendance Management =====
            const totalSessionsEl = document.getElementById('total-sessions');
            const presentCountEl = document.getElementById('present-count');
            const absentCountEl = document.getElementById('absent-count');
            const attendanceRateEl = document.getElementById('attendance-rate');
            const attendanceCourseFilterSelect = document.getElementById('attendance-course-filter');
            const attendanceDateFilterSelect = document.getElementById('attendance-date-filter');
            const applyAttendanceFiltersBtn = document.getElementById('apply-attendance-filters');
            const attendanceTbody = document.getElementById('attendance-tbody');

            function loadAttendanceStats(){
                try {
                    // Get student's actual attendance records
                    const studentScans = loadStudentScans();
                    
                    // Calculate total sessions attended by the student
                    const totalSessionsAttended = studentScans.length;
                    
                    // Calculate present sessions (where status is 'Present')
                    const presentSessions = studentScans.filter(scan => scan.status === 'Present').length;
                    
                    // Calculate absent sessions (where status is 'Absent' or 'Late')
                    const absentSessions = studentScans.filter(scan => 
                        scan.status === 'Absent' || scan.status === 'Late'
                    ).length;
                    
                    // Calculate attendance rate based on actual attendance
                    const attendanceRate = totalSessionsAttended > 0 ? 
                        Math.round((presentSessions / totalSessionsAttended) * 100) : 0;
                    
                    // Update the display elements
                    totalSessionsEl.textContent = totalSessionsAttended;
                    presentCountEl.textContent = presentSessions;
                    absentCountEl.textContent = absentSessions;
                    attendanceRateEl.textContent = `${attendanceRate}%`;
                    
                    console.log('Attendance Stats Updated:', {
                        totalSessions: totalSessionsAttended,
                        presentSessions: presentSessions,
                        absentSessions: absentSessions,
                        attendanceRate: attendanceRate + '%'
                    });

                    // Populate course filter options
                    const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                    attendanceCourseFilterSelect.innerHTML = '<option value="">All Courses</option>';
                    courses.forEach(course => {
                        const opt = document.createElement('option');
                        opt.value = course.code;
                        opt.textContent = course.name;
                        attendanceCourseFilterSelect.appendChild(opt);
                    });
                } catch (e) {
                    console.error('Error loading attendance stats:', e);
                }
            }

            // Calculate attendance rate for a specific course
            function calculateCourseAttendanceRate(courseCode) {
                try {
                    const studentScans = loadStudentScans();
                    const courseScans = studentScans.filter(scan => scan.courseCode === courseCode);
                    
                    if (courseScans.length === 0) {
                        return {
                            totalSessions: 0,
                            presentSessions: 0,
                            absentSessions: 0,
                            attendanceRate: 0
                        };
                    }
                    
                    const presentSessions = courseScans.filter(scan => scan.status === 'Present').length;
                    const absentSessions = courseScans.filter(scan => 
                        scan.status === 'Absent' || scan.status === 'Late'
                    ).length;
                    const attendanceRate = Math.round((presentSessions / courseScans.length) * 100);
                    
                    return {
                        totalSessions: courseScans.length,
                        presentSessions: presentSessions,
                        absentSessions: absentSessions,
                        attendanceRate: attendanceRate
                    };
                } catch (e) {
                    console.error('Error calculating course attendance rate:', e);
                    return {
                        totalSessions: 0,
                        presentSessions: 0,
                        absentSessions: 0,
                        attendanceRate: 0
                    };
                }
            }

            // Get overall attendance statistics
            function getOverallAttendanceStats() {
                try {
                    const studentScans = loadStudentScans();
                    
                    const totalSessions = studentScans.length;
                    const presentSessions = studentScans.filter(scan => scan.status === 'Present').length;
                    const absentSessions = studentScans.filter(scan => 
                        scan.status === 'Absent' || scan.status === 'Late'
                    ).length;
                    const attendanceRate = totalSessions > 0 ? Math.round((presentSessions / totalSessions) * 100) : 0;
                    
                    return {
                        totalSessions: totalSessions,
                        presentSessions: presentSessions,
                        absentSessions: absentSessions,
                        attendanceRate: attendanceRate
                    };
                } catch (e) {
                    console.error('Error getting overall attendance stats:', e);
                    return {
                        totalSessions: 0,
                        presentSessions: 0,
                        absentSessions: 0,
                        attendanceRate: 0
                    };
                }
            }

            function loadAttendanceRecords(){
                try {
                    const scans = loadStudentScans();
                    const sessions = JSON.parse(localStorage.getItem('lecturerSessions') || '[]');
                    const courseFilter = attendanceCourseFilterSelect?.value || 'all';
                    const dateFilter = attendanceDateFilterSelect?.value || 'all';

                    let filteredScans = scans;
                    if (courseFilter !== 'all') {
                        filteredScans = filteredScans.filter(s => s.course === courseFilter);
                    }
                    if (dateFilter !== 'all') {
                        const startDate = new Date(dateFilter === 'week' ? new Date().setDate(new Date().getDate() - 7) : new Date().setDate(new Date().getDate() - 30));
                        filteredScans = filteredScans.filter(s => new Date(s.date) >= startDate);
                    }

                    attendanceTbody.innerHTML = '';
                    if (!filteredScans.length){
                        const tr = document.createElement('tr');
                        const td = document.createElement('td'); td.colSpan = 8; td.className = 'centered-cell'; td.textContent = 'No attendance records found.';
                        tr.appendChild(td); attendanceTbody.appendChild(tr); return;
                    }

                    filteredScans.forEach(scan => {
                        const session = sessions.find(s => s.id === scan.sessionId);
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${scan.date || ''}</td>
                            <td>${scan.time || ''}</td>
                            <td>${scan.course || ''}</td>
                            <td>${session?.lecturer || ''}</td>
                            <td>${scan.sessionId || ''}</td>
                            <td>${scan.status === 'Present' ? 'QR Scan' : 'Manual PIN'}</td>
                            <td><span class="status-badge ${scan.status === 'Present' ? 'present' : 'absent'}">${scan.status}</span></td>
                            <td>
                                <button class="btn btn-small" data-view-scan="${scan.id}">View</button>
                            </td>`;
                        attendanceTbody.appendChild(tr);
                    });

                    // Add event listeners for view scan buttons
                    attendanceTbody.querySelectorAll('[data-view-scan]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const scanId = btn.getAttribute('data-view-scan');
                            const scan = scans.find(s => s.id === scanId);
                            if (scan) {
                                alert(`Date: ${scan.date}\nTime: ${scan.time}\nPIN: ${scan.pin}\nCourse: ${scan.course}\nLecturer: ${scan.lecturer}\nSession ID: ${scan.sessionId}\nStatus: ${scan.status}`);
                            }
                        });
                    });
                } catch (e) {
                    console.error('Error loading attendance records:', e);
                }
            }

            applyAttendanceFiltersBtn?.addEventListener('click', loadAttendanceRecords);

            // ===== Reports Management =====
            const reportTypeSelect = document.getElementById('report-type');
            const reportPeriodSelect = document.getElementById('report-period');
            const reportFormatSelect = document.getElementById('report-format');
            const generateReportBtn = document.getElementById('generate-report-btn');
            const reportCard = document.getElementById('report-card');
            const reportContent = document.getElementById('report-content');
            const reportTitle = document.getElementById('report-title');
            const reportDate = document.getElementById('report-date');
            const reportPeriodDisplay = document.getElementById('report-period-display');
            const reportsTbody = document.getElementById('reports-tbody');

            function loadReports(){
                try {
                    const reports = JSON.parse(localStorage.getItem('studentReports') || '[]');
                    reportsTbody.innerHTML = '';
                    if (!reports.length){
                        const tr = document.createElement('tr');
                        const td = document.createElement('td'); td.colSpan = 5; td.className = 'centered-cell'; td.textContent = 'No reports generated yet.';
                        tr.appendChild(td); reportsTbody.appendChild(tr); return;
                    }
                    reports.forEach(report => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${report.date || ''}</td>
                            <td>${report.type || ''}</td>
                            <td>${report.period || ''}</td>
                            <td>${report.format || ''}</td>
                            <td>
                                <button class="btn btn-small" data-view-report="${report.id}" data-translate="reports-view">View</button>
                            </td>`;
                        reportsTbody.appendChild(tr);
                    });

                    // Add event listeners for view report buttons
                    reportsTbody.querySelectorAll('[data-view-report]').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const reportId = btn.getAttribute('data-view-report');
                            const report = reports.find(r => r.id === reportId);
                            if (report) {
                                reportContent.innerHTML = JSON.stringify(report, null, 2);
                                reportTitle.textContent = `Report for ${report.type} (${report.period})`;
                                reportDate.textContent = `Generated on: ${report.date}`;
                                reportPeriodDisplay.textContent = `Period: ${report.period}`;
                                reportCard.style.display = 'block';
                            }
                        });
                    });
                } catch (e) {
                    console.error('Error loading reports:', e);
                }
            }

            function generateReportPreview(){
                const type = reportTypeSelect?.value || 'attendance';
                const period = reportPeriodSelect?.value || 'week';
                const format = reportFormatSelect?.value || 'pdf';

                let reportData = {};
                let reportContent = '';

                if (type === 'attendance') {
                    const overallStats = getOverallAttendanceStats();
                    reportData = {
                        type: 'Attendance Report',
                        period: period,
                        date: new Date().toISOString().slice(0, 10),
                        student: {
                            totalSessions: overallStats.totalSessions,
                            presentSessions: overallStats.presentSessions,
                            absentSessions: overallStats.absentSessions,
                            attendanceRate: `${overallStats.attendanceRate}%`
                        },
                        courseBreakdown: (() => {
                            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                            return courses.map(course => {
                                const stats = calculateCourseAttendanceRate(course.code);
                                return {
                                    courseName: course.name,
                                    courseCode: course.code,
                                    totalSessions: stats.totalSessions,
                                    presentSessions: stats.presentSessions,
                                    absentSessions: stats.absentSessions,
                                    attendanceRate: `${stats.attendanceRate}%`
                                };
                            });
                        })()
                    };
                    
                    // Create formatted HTML content for better display
                    reportContent = `
                        <div class="report-section">
                            <h5>Overall Attendance Summary</h5>
                            <div class="stats-grid">
                                <div class="stat-item">
                                    <span class="stat-label">Total Sessions:</span>
                                    <span class="stat-value">${overallStats.totalSessions}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Present:</span>
                                    <span class="stat-value">${overallStats.presentSessions}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Absent:</span>
                                    <span class="stat-value">${overallStats.absentSessions}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Attendance Rate:</span>
                                    <span class="stat-value">${overallStats.attendanceRate}%</span>
                                </div>
                            </div>
                        </div>
                        <div class="report-section">
                            <h5>Course Breakdown</h5>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Course</th>
                                        <th>Code</th>
                                        <th>Total Sessions</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                        <th>Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reportData.courseBreakdown.map(course => `
                                        <tr>
                                            <td>${course.courseName}</td>
                                            <td>${course.courseCode}</td>
                                            <td>${course.totalSessions}</td>
                                            <td>${course.presentSessions}</td>
                                            <td>${course.absentSessions}</td>
                                            <td>${course.attendanceRate}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (type === 'academic') {
                    reportData = {
                        type: 'Academic Progress Report',
                        period: period,
                        date: new Date().toISOString().slice(0, 10),
                        courses: [
                            { name: 'Human Computer Interaction II', class: 'B', credits: 26, status: 'In Progress' },
                            { name: 'Development Software II', class: 'A', credits: 34, status: 'In Progress' },
                            { name: 'Technical Programming I', class: 'C', credits: 30, status: 'In Progress' },
                            { name: 'Information Systems II', class: 'D', credits: 30, status: 'In Progress' }
                        ]
                    };
                    
                    reportContent = `
                        <div class="report-section">
                            <h5>Academic Progress Summary</h5>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Course</th>
                                        <th>Grade</th>
                                        <th>Credits</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reportData.courses.map(course => `
                                        <tr>
                                            <td>${course.name}</td>
                                            <td>${course.grade}</td>
                                            <td>${course.credits}</td>
                                            <td>${course.status}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (type === 'course') {
                    reportData = {
                        type: 'Course Summary Report',
                        period: period,
                        date: new Date().toISOString().slice(0, 10),
                        courses: (() => {
                            const courses = JSON.parse(localStorage.getItem('courses') || '[]');
                            return courses.map(course => {
                                const stats = calculateCourseAttendanceRate(course.code);
                                return {
                                    name: course.name,
                                    code: course.code,
                                    totalSessions: stats.totalSessions,
                                    present: stats.presentSessions,
                                    absent: stats.absentSessions,
                                    attendanceRate: `${stats.attendanceRate}%`
                                };
                            });
                        })()
                    };
                    
                    reportContent = `
                        <div class="report-section">
                            <h5>Course Summary</h5>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Course Name</th>
                                        <th>Code</th>
                                        <th>Total Sessions</th>
                                        <th>Present</th>
                                        <th>Absent</th>
                                        <th>Attendance Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${reportData.courses.map(course => `
                                        <tr>
                                            <td>${course.name}</td>
                                            <td>${course.code}</td>
                                            <td>${course.totalSessions}</td>
                                            <td>${course.present}</td>
                                            <td>${course.absent}</td>
                                            <td>${course.attendanceRate}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }

                // Update the report content with formatted HTML
                const reportContentElement = document.getElementById('report-content');
                if (reportContentElement) {
                    reportContentElement.innerHTML = reportContent;
                }
                
                // Update report metadata
                if (reportTitle) {
                    reportTitle.textContent = `${reportData.type} (${period})`;
                }
                if (reportDate) {
                    reportDate.textContent = `Generated on: ${new Date().toISOString().slice(0, 10)}`;
                }
                if (reportPeriodDisplay) {
                    reportPeriodDisplay.textContent = `Period: ${period}`;
                }
                if (reportCard) {
                    reportCard.style.display = 'block';
                }
                
                // Save report to localStorage for history
                saveReportToHistory(reportData, type, period, format);
            }

            function saveReportToHistory(reportData, type, period, format) {
                try {
                    const reports = JSON.parse(localStorage.getItem('studentReports') || '[]');
                    const newReport = {
                        id: 'report_' + Date.now(),
                        type: type,
                        period: period,
                        format: format,
                        date: new Date().toISOString().slice(0, 10),
                        data: reportData
                    };
                    reports.unshift(newReport);
                    // Keep only last 20 reports
                    if (reports.length > 20) {
                        reports.splice(20);
                    }
                    localStorage.setItem('studentReports', JSON.stringify(reports));
                } catch (error) {
                    console.error('Error saving report to history:', error);
                }
            }

            generateReportBtn?.addEventListener('click', generateReportPreview);

            // Add export functionality
            window.exportReportPdf = function() {
                const reportCard = document.getElementById('report-card');
                if (!reportCard || reportCard.style.display === 'none') {
                    alert('Please generate a report first.');
                    return;
                }
                
                try {
                    const opt = {
                        margin: 1,
                        filename: `student_report_${new Date().toISOString().slice(0, 10)}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                    };
                    
                    html2pdf().set(opt).from(reportCard).save();
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                }
            };

            window.exportReportWord = function() {
                const reportCard = document.getElementById('report-card');
                if (!reportCard || reportCard.style.display === 'none') {
                    alert('Please generate a report first.');
                    return;
                }
                
                try {
                    const { Document, Packer, Paragraph, TextRun } = docx;
                    
                    const reportTitle = document.getElementById('report-title')?.textContent || 'Student Report';
                    const reportContent = document.getElementById('report-content')?.textContent || 'No content available';
                    const reportDate = document.getElementById('report-date')?.textContent || '';
                    const reportPeriod = document.getElementById('report-period-display')?.textContent || '';
                    
                    const doc = new Document({
                        sections: [{
                            properties: {},
                            children: [
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: reportTitle,
                                            bold: true,
                                            size: 24
                                        })
                                    ]
                                }),
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: reportDate,
                                            size: 12
                                        })
                                    ]
                                }),
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: reportPeriod,
                                            size: 12
                                        })
                                    ]
                                }),
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: '\n',
                                            size: 12
                                        })
                                    ]
                                }),
                                new Paragraph({
                                    children: [
                                        new TextRun({
                                            text: reportContent,
                                            size: 12
                                        })
                                    ]
                                })
                            ]
                        }]
                    });
                    
                    Packer.toBlob(doc).then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `student_report_${new Date().toISOString().slice(0, 10)}.docx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                    }).catch(error => {
                        console.error('Error generating Word document:', error);
                        alert('Error generating Word document. Please try again.');
                    });
                } catch (error) {
                    console.error('Error generating Word document:', error);
                    alert('Error generating Word document. Please try again.');
                }
            };

            // Add export buttons to the report preview
            const reportActions = document.createElement('div');
            reportActions.className = 'report-actions';
            reportActions.innerHTML = `
                <button class="btn" onclick="exportReportPdf()">
                    <i class="fas fa-file-pdf"></i>
                    <span data-translate="reports-download-pdf">Download PDF</span>
                </button>
                <button class="btn" onclick="exportReportWord()">
                    <i class="fas fa-file-word"></i>
                    <span data-translate="reports-download-word">Download Word</span>
                </button>
            `;
            
            // Insert the actions after the report content
            const reportContentElement = document.getElementById('report-content');
            if (reportContentElement && reportContentElement.parentNode) {
                reportContentElement.parentNode.insertBefore(reportActions, reportContentElement.nextSibling);
            }

            // ===== Settings Management =====
            const studentThemeSelect = document.getElementById('student-theme');
            const studentLanguageSelect = document.getElementById('student-language');
            const studentTimezoneSelect = document.getElementById('student-timezone');
            const notifyAttendanceCheckbox = document.getElementById('notify-attendance');
            const notifyCoursesCheckbox = document.getElementById('notify-courses');
            const notifyDeadlinesCheckbox = document.getElementById('notify-deadlines');
            const notifyGradesCheckbox = document.getElementById('notify-grades');
            const scannerCameraSelect = document.getElementById('scanner-camera');
            const scannerQualitySelect = document.getElementById('scanner-quality');
            const autoScanCheckbox = document.getElementById('auto-scan');
            const soundEffectsCheckbox = document.getElementById('sound-effects');
            const vibrateOnScanCheckbox = document.getElementById('vibrate-on-scan');
            const exportStudentDataBtn = document.getElementById('export-student-data');
            const importStudentDataBtn = document.getElementById('import-student-data');
            const clearStudentDataBtn = document.getElementById('clear-student-data');
            const currentPasswordInput = document.getElementById('current-password');
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const changePasswordBtn = document.getElementById('change-password-btn');
            const importFileInput = document.getElementById('import-file');

            // ===== Theme Management =====
            function applyTheme() {
                try {
                    const theme = studentThemeSelect?.value || 'light';
                    const body = document.body;
                    
                    // Remove existing theme classes
                    body.classList.remove('theme-light', 'theme-dark');
                    
                    // Apply theme based on selection
                    if (theme === 'dark') {
                        body.classList.add('theme-dark');
                        body.setAttribute('data-theme', 'dark');
                    } else if (theme === 'auto') {
                        // Auto theme - use system preference
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        if (prefersDark) {
                            body.classList.add('theme-dark');
                            body.setAttribute('data-theme', 'dark');
                        } else {
                            body.classList.add('theme-light');
                            body.setAttribute('data-theme', 'light');
                        }
                    } else {
                        // Light theme (default)
                        body.classList.add('theme-light');
                        body.setAttribute('data-theme', 'light');
                    }
                } catch (error) {
                    console.error('Error applying theme:', error);
                }
            }

            // Listen for system theme changes when auto theme is selected
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
                    if (studentThemeSelect?.value === 'auto') {
                        applyTheme();
                    }
                });
            }

            // ===== Language Management =====
            const translations = {
                en: {
                    // Navigation
                    'nav-dashboard': 'Dashboard',
                    'nav-profile': 'Profile',
                    'nav-calendar': 'Calendar',
                    'nav-courses': 'Courses',
                    'nav-qr-scanner': 'QR Scanner',
                    'nav-pin-entry': 'PIN Entry',
                    'nav-attendance': 'Attendance',
                    'nav-reports': 'Reports',
                    'nav-settings': 'Settings',
                    
                    // Profile
                    'profile-title': 'Student Profile',
                    'profile-name': 'Name',
                    'profile-email': 'Email',
                    'profile-student-id': 'Student ID',
                    'profile-course': 'Course',
                    'profile-year': 'Year',
                    'profile-edit': 'Edit Profile',
                    'profile-save': 'Save Changes',
                    'profile-cancel': 'Cancel',
                    
                    // Calendar
                    'calendar-title': 'Academic Calendar',
                    'calendar-today': 'Today',
                    'calendar-events': 'Upcoming Events',
                    'calendar-no-events': 'No upcoming events',
                    
                    // QR Scanner
                    'qr-scanner-title': 'QR Code Scanner',
                    'qr-select-course': 'Select Course',
                    'qr-scan-now': 'Scan Now',
                    'qr-scanning': 'Scanning...',
                    'qr-success': 'Attendance Marked!',
                    'qr-error': 'Scan Failed',
                    'qr-expired': 'QR Code Expired',
                    
                    // PIN Entry
                    'pin-entry-title': 'PIN Entry',
                    'pin-enter': 'Enter PIN',
                    'pin-submit': 'Submit',
                    'pin-success': 'PIN Accepted',
                    'pin-error': 'Invalid PIN',
                    
                    // Attendance
                    'attendance-title': 'Attendance Records',
                    'attendance-stats': 'Attendance Statistics',
                    'attendance-present': 'Present',
                    'attendance-absent': 'Absent',
                    'attendance-rate': 'Attendance Rate',
                    'attendance-total': 'Total Sessions',
                    
                    // Reports
                    'reports-title': 'Attendance Reports',
                    'reports-generate': 'Generate Report',
                    'reports-download': 'Download',
                    'reports-week': 'Weekly Report',
                    'reports-month': 'Monthly Report',
                    
                    // Settings
                    'settings-title': 'Student Settings',
                    'settings-profile': 'Profile Settings',
                    'settings-theme': 'Theme',
                    'settings-language': 'Language',
                    'settings-timezone': 'Timezone',
                    'settings-notifications': 'Notification Preferences',
                    'settings-save': 'Save Settings',
                    'settings-saved': 'Settings saved successfully!',
                    
                    // Theme options
                    'theme-light': 'Light',
                    'theme-dark': 'Dark',
                    'theme-auto': 'Auto',
                    
                    // Language options
                    'lang-english': 'English',
                    'lang-xhosa': 'Xhosa',
                    'lang-sesotho': 'Sesotho',
                    'lang-setswana': 'Setswana',
                    'lang-zulu': 'Zulu',
                    
                    // Timezone options
                    'timezone-sa': 'South Africa (GMT+2)',
                    'timezone-utc': 'UTC',
                    
                    // Notification options
                    'notify-attendance': 'Attendance reminders',
                    'notify-courses': 'Course updates',
                    'notify-deadlines': 'Assignment deadlines',
                    'notify-grades': 'Grade updates',
                    
                    // Profile additional
                    'profile-student-id': 'Student ID:',
                    'profile-full-name': 'Full Name',
                    'profile-year': 'Year:',
                    'profile-department': 'Department:',
                    'profile-new-password': 'New Password',
                    'profile-confirm-password': 'Confirm Password',
                    'profile-name-placeholder': 'Enter your full name',
                    'profile-email-placeholder': 'Enter your email',
                    'profile-phone-placeholder': 'Enter your phone number',
                    'profile-address-placeholder': 'Enter your address',
                    'profile-bio-placeholder': 'Tell us about yourself...',
                    'profile-password-placeholder': 'Enter new password (optional)',
                    'profile-confirm-password-placeholder': 'Confirm new password',
                    
                    // Calendar additional
                    'calendar-filter-type': 'Filter by Type',
                    'calendar-all-types': 'All Types',
                    'calendar-assignment': 'Assignment',
                    'calendar-exam': 'Exam',
                    'calendar-lecture': 'Lecture',
                    'calendar-tutorial': 'Tutorial',
                    'calendar-personal': 'Personal',
                    'calendar-filter-course': 'Filter by Course',
                    'calendar-all-courses': 'All Courses',
                    'calendar-apply-filter': 'Apply Filter',
                    
                    // QR Scanner additional
                    'qr-select-course': 'Select Course for Attendance',
                    'qr-course': 'Course',
                    'qr-select-course-placeholder': 'Select a course to scan QR code for',
                    'qr-refresh-courses': 'Refresh Courses',
                    'qr-check-status': 'Check QR Status',
                    'qr-stop-scanner': 'Stop Scanner',
                    
                    // PIN Entry additional
                    'pin-manual-entry': 'Manual PIN Entry',
                    'pin-enter': 'Enter PIN',
                    'pin-enter-placeholder': 'Enter the PIN from lecturer',
                    'pin-ready': 'Ready to Enter PIN',
                    'pin-clear': 'Clear',
                    'pin-quick-entry': 'Quick PIN Entry',
                    'pin-enter-full': 'Enter Full PIN',
                    'pin-enter-full-placeholder': 'Enter 6-digit PIN',
                    'pin-history': 'PIN Entry History',
                    
                    // Attendance additional
                    'attendance-date-range': 'Date Range',
                    'attendance-all-time': 'All Time',
                    'attendance-this-week': 'This Week',
                    'attendance-this-month': 'This Month',
                    'attendance-this-semester': 'This Semester',
                    'attendance-apply-filters': 'Apply Filters',
                    
                    // Reports additional
                    'reports-type': 'Report Type',
                    'reports-attendance': 'Attendance Report',
                    'reports-academic': 'Academic Progress',
                    'reports-course': 'Course Summary',
                    'reports-period': 'Period',
                    'reports-semester': 'This Semester',
                    'reports-year': 'This Year',
                    'reports-format': 'Format',
                    'reports-generate-btn': 'Generate Report',
                    
                    // Report Preview and Recent Reports
                    'reports-preview': 'Report Preview',
                    'reports-student-report': 'Student Report',
                    'reports-generated-on': 'Generated on: -',
                    'reports-period-label': 'Period: -',
                    'reports-preview-instruction': 'Select report type and period, then click "Generate Report" to preview.',
                    'reports-recent': 'Recent Reports',
                    'reports-table-date': 'Date',
                    'reports-table-type': 'Type',
                    'reports-table-period': 'Period',
                    'reports-table-format': 'Format',
                    'reports-table-actions': 'Actions',
                    'reports-no-reports': 'No reports generated yet.',
                    'reports-view': 'View',
                    'reports-download-pdf': 'Download PDF',
                    'reports-download-word': 'Download Word',
                    
                    // Scanner additional elements
                    'scanner-course-name': 'Course Name',
                    'scanner-course-code': 'Course Code',
                    'scanner-sessions': 'sessions',
                    'scanner-attendance': 'attendance',
                    'scanner-active-qr-codes': 'active QR codes',
                    'scanner-active-qr-status': 'Active QR Codes Status',
                    'scanner-ready-to-scan': 'Ready to Scan',
                    'scanner-position-qr': 'Position QR code within the frame',
                    'scanner-mobile-instructions': 'Hold your device steady and position the QR code within the frame',
                    'scanner-scan-result': 'Scan Result',
                    'scanner-label-pin': 'PIN:',
                    'scanner-label-course': 'Course:',
                    'scanner-label-lecturer': 'Lecturer:',
                    'scanner-label-session': 'Session ID:',
                    'scanner-label-status': 'Status:',
                    'scanner-label-expires': 'Expires:',
                    'scanner-mark-attendance': 'Mark Attendance',
                    'scanner-flash-on': 'Flash On',
                    'scanner-flash-off': 'Flash Off',
                    'scanner-lock-orientation': 'Lock Orientation',
                    'scanner-unlock-orientation': 'Unlock Orientation',
                    'scanner-fullscreen': 'Fullscreen',
                    'scanner-exit-fullscreen': 'Exit Fullscreen',
                    'scanner-camera-info': 'Camera will be activated when you start scanning',
                    'scanner-available-qr-codes': 'Available QR Codes for Courses',
                    'scanner-select-course-view-qr': 'Select a course to view available QR codes',
                    'scanner-recent-scans': 'Recent Scans',
                    'scanner-table-date': 'Date',
                    'scanner-table-time': 'Time',
                    'scanner-table-pin': 'PIN',
                    'scanner-table-course': 'Course',
                    'scanner-table-lecturer': 'Lecturer',
                    'scanner-table-status': 'Status',
                    'scanner-table-actions': 'Actions',
                    'scanner-no-recent-scans': 'No recent scans found.',
                    
                    // Calendar additional elements
                    'calendar-sun': 'Sun',
                    'calendar-mon': 'Mon',
                    'calendar-tue': 'Tue',
                    'calendar-wed': 'Wed',
                    'calendar-thu': 'Thu',
                    'calendar-fri': 'Fri',
                    'calendar-sat': 'Sat',
                    'calendar-add-event': 'Add Event',
                    'calendar-event-title': 'Event Title',
                    'calendar-event-title-placeholder': 'Enter event title',
                    'calendar-event-date': 'Date',
                    'calendar-event-time': 'Time',
                    'calendar-event-type': 'Type',
                    'calendar-event-course': 'Course',
                    'calendar-select-course': 'Select Course',
                    'calendar-event-notes': 'Notes',
                    'calendar-event-notes-placeholder': 'Additional notes...',
                    'calendar-add-event-btn': 'Add Event',
                    'calendar-clear-btn': 'Clear',
                    'calendar-table-date': 'Date',
                    'calendar-table-time': 'Time',
                    'calendar-table-title': 'Title',
                    'calendar-table-type': 'Type',
                    'calendar-table-course': 'Course',
                    'calendar-table-notes': 'Notes',
                    'calendar-table-actions': 'Actions',
                    'calendar-no-events': 'No events found.',
                    
                    // Calendar months
                    'calendar-january': 'January',
                    'calendar-february': 'February',
                    'calendar-march': 'March',
                    'calendar-april': 'April',
                    'calendar-may': 'May',
                    'calendar-june': 'June',
                    'calendar-july': 'July',
                    'calendar-august': 'August',
                    'calendar-september': 'September',
                    'calendar-october': 'October',
                    'calendar-november': 'November',
                    'calendar-december': 'December',
                    
                    // Dashboard
                    'dashboard-overview': 'Dashboard Overview',
                    'dashboard-total-lecturers': 'Total Lecturers',
                    'dashboard-total-courses': 'Total Courses',
                    'dashboard-total-attendance': 'Total Attendance',
                    
                    // Header
                    'welcome-student': 'Welcome, Student',
                    'logout': 'Logout',
                    
                    // Settings additional
                    'settings-scanner': 'Scanner Settings',
                    'settings-default-camera': 'Default Camera',
                    'settings-auto-select': 'Auto-select',
                    'settings-back-camera': 'Back Camera',
                    'settings-front-camera': 'Front Camera',
                    'settings-scan-quality': 'Scan Quality',
                    'settings-quality-high': 'High',
                    'settings-quality-medium': 'Medium',
                    'settings-quality-low': 'Low',
                    'settings-auto-scan': 'Auto-scan QR codes',
                    'settings-sound-effects': 'Sound effects',
                    'settings-vibrate-scan': 'Vibrate on successful scan',
                    'settings-data-management': 'Data Management',
                    'settings-export-data': 'Export My Data',
                    'settings-import-data': 'Import Data',
                    'settings-clear-data': 'Clear All Data',
                    
                    // Account Security
                    'settings-account-security': 'Account Security',
                    'settings-current-password': 'Current Password',
                    'settings-current-password-placeholder': 'Enter current password',
                    'settings-new-password': 'New Password',
                    'settings-new-password-placeholder': 'Enter new password',
                    'settings-confirm-password': 'Confirm Password',
                    'settings-confirm-password-placeholder': 'Confirm new password',
                    'settings-change-password': 'Change Password',
                    
                    // Common
                    'loading': 'Loading...',
                    'error': 'Error',
                    'success': 'Success',
                    'cancel': 'Cancel',
                    'save': 'Save',
                    'edit': 'Edit',
                    'delete': 'Delete',
                    'confirm': 'Confirm',
                    'yes': 'Yes',
                    'no': 'No'
                },
                xh: {
                    // Navigation
                    'nav-dashboard': 'Ideshibhodi',
                    'nav-profile': 'Iprofayili',
                    'nav-calendar': 'Ikhaleda',
                    'nav-courses': 'Izifundo',
                    'nav-qr-scanner': 'Isikena se-QR',
                    'nav-pin-entry': 'Ukufaka iPIN',
                    'nav-attendance': 'Ukuba khona',
                    'nav-reports': 'Iingxelo',
                    'nav-settings': 'Iisetingi',
                    
                    // Profile
                    'profile-title': 'Iprofayili yoMfundi',
                    'profile-name': 'Igama',
                    'profile-email': 'I-imeyili',
                    'profile-student-id': 'Inombolo yoMfundi',
                    'profile-course': 'Isifundo',
                    'profile-year': 'Unyaka',
                    'profile-edit': 'Hlela Iprofayili',
                    'profile-save': 'Gcina Iinguqulelo',
                    'profile-cancel': 'Rhoxisa',
                    
                    // Calendar
                    'calendar-title': 'Ikhaleda leMfundo',
                    'calendar-today': 'Namhlanje',
                    'calendar-events': 'Iimeko ezizayo',
                    'calendar-no-events': 'Akukho meko ezizayo',
                    
                    // QR Scanner
                    'qr-scanner-title': 'Isikena se-QR Code',
                    'qr-select-course': 'Khetha Isifundo',
                    'qr-scan-now': 'Skena Ngoku',
                    'qr-scanning': 'Iyasikena...',
                    'qr-success': 'Ukuba khona kwabhaliswe!',
                    'qr-error': 'Ukusikena akuphumelelanga',
                    'qr-expired': 'I-QR Code iphelelwe lixesha',
                    
                    // PIN Entry
                    'pin-entry-title': 'Ukufaka iPIN',
                    'pin-enter': 'Faka iPIN',
                    'pin-submit': 'Ngenisa',
                    'pin-success': 'I-PIN yamkelwe',
                    'pin-error': 'I-PIN ayilunganga',
                    
                    // Attendance
                    'attendance-title': 'Iirekhodi zokuba khona',
                    'attendance-stats': 'Iinkcukacha zokuba khona',
                    'attendance-present': 'Ukhona',
                    'attendance-absent': 'Akakho',
                    'attendance-rate': 'Izinga lokuba khona',
                    'attendance-total': 'Iiseshoni ezipheleleyo',
                    
                    // Reports
                    'reports-title': 'Iingxelo zokuba khona',
                    'reports-generate': 'Yenza Ingxelo',
                    'reports-download': 'Khuphela',
                    'reports-week': 'Ingxelo yeveki',
                    'reports-month': 'Ingxelo yenyanga',
                    
                    // Settings
                    'settings-title': 'Iisetingi zoMfundi',
                    'settings-profile': 'Iisetingi zeProfayili',
                    'settings-theme': 'Umbala',
                    'settings-language': 'Ulwimi',
                    'settings-timezone': 'Indawo yexesha',
                    'settings-notifications': 'Iintshiseko zeZaziso',
                    'settings-save': 'Gcina Iisetingi',
                    'settings-saved': 'Iisetingi zigcinwe ngempumelelo!',
                    
                    // Theme options
                    'theme-light': 'Kukhanyayo',
                    'theme-dark': 'Mnyama',
                    'theme-auto': 'Ngokuzenzekelayo',
                    
                    // Language options
                    'lang-english': 'IsiNgesi',
                    'lang-xhosa': 'IsiXhosa',
                    'lang-sesotho': 'SeSotho',
                    'lang-setswana': 'SeTswana',
                    'lang-zulu': 'IsiZulu',
                    
                    // Timezone options
                    'timezone-sa': 'eMzantsi Afrika (GMT+2)',
                    'timezone-utc': 'UTC',
                    
                    // Notification options
                    'notify-attendance': 'Izikhumbuzi zokuba khona',
                    'notify-courses': 'Iinguqulelo zezifundo',
                    'notify-deadlines': 'Ixesha lokuphela komsebenzi',
                    'notify-grades': 'Iinguqulelo zamagrad',
                    
                    // Profile additional
                    'profile-student-id': 'I-ID yoMfundi:',
                    'profile-full-name': 'Igama elipheleleyo',
                    'profile-year': 'Unyaka:',
                    'profile-department': 'ISebe:',
                    'profile-new-password': 'Iphasiwedi entsha',
                    'profile-confirm-password': 'Qinisekisa Iphasiwedi',
                    'profile-name-placeholder': 'Faka igama lakho elipheleleyo',
                    'profile-email-placeholder': 'Faka i-imeyile yakho',
                    'profile-phone-placeholder': 'Faka inombolo yakho yefowuni',
                    'profile-address-placeholder': 'Faka idilesi yakho',
                    'profile-bio-placeholder': 'Sixelele ngaye...',
                    'profile-password-placeholder': 'Faka iphasiwedi entsha (ukhetho)',
                    'profile-confirm-password-placeholder': 'Qinisekisa iphasiwedi entsha',
                    
                    // Calendar additional
                    'calendar-filter-type': 'Hluza ngoHlobo',
                    'calendar-all-types': 'Zonke Iintlobo',
                    'calendar-assignment': 'Umsebenzi',
                    'calendar-exam': 'Uvavanyo',
                    'calendar-lecture': 'Isifundo',
                    'calendar-tutorial': 'Isifundo esincinci',
                    'calendar-personal': 'Sobuqu',
                    'calendar-filter-course': 'Hluza ngeSifundo',
                    'calendar-all-courses': 'Zonke Izifundo',
                    'calendar-apply-filter': 'Faka Isihluzo',
                    
                    // QR Scanner additional
                    'qr-select-course': 'Khetha Isifundo sokuba khona',
                    'qr-course': 'Isifundo',
                    'qr-select-course-placeholder': 'Khetha isifundo sokuskena i-QR code',
                    'qr-refresh-courses': 'Vuselela Izifundo',
                    'qr-check-status': 'Jonga Isimo se-QR',
                    'qr-stop-scanner': 'Misa Isikena',
                    
                    // PIN Entry additional
                    'pin-manual-entry': 'Ukufaka iPIN ngesandla',
                    'pin-enter': 'Faka iPIN',
                    'pin-enter-placeholder': 'Faka iPIN evela kumfundisi',
                    'pin-ready': 'Ilungile ukufaka iPIN',
                    'pin-clear': 'Cima',
                    'pin-quick-entry': 'Ukufaka iPIN ngokukhawuleza',
                    'pin-enter-full': 'Faka iPIN epheleleyo',
                    'pin-enter-full-placeholder': 'Faka iPIN ene-digits ezi-6',
                    'pin-history': 'Imbali yokufaka iPIN',
                    
                    // Attendance additional
                    'attendance-date-range': 'Uluhlu lwexesha',
                    'attendance-all-time': 'Lonke ixesha',
                    'attendance-this-week': 'Le veki',
                    'attendance-this-month': 'Le nyanga',
                    'attendance-this-semester': 'Le semesta',
                    'attendance-apply-filters': 'Faka Izihluzo',
                    
                    // Reports additional
                    'reports-type': 'Uhlobo lweNgxelo',
                    'reports-attendance': 'Ingxelo yokuba khona',
                    'reports-academic': 'Intuthuko yezeMfundo',
                    'reports-course': 'Isishwankathelo seSifundo',
                    'reports-period': 'Ixesha',
                    'reports-semester': 'Le semesta',
                    'reports-year': 'Lo nyaka',
                    'reports-format': 'Ifomethi',
                    'reports-generate-btn': 'Yenza Ingxelo',
                    
                    // Report Preview and Recent Reports
                    'reports-preview': 'Ukubonwa kweNgxelo',
                    'reports-student-report': 'Ingxelo yoMfundi',
                    'reports-generated-on': 'Yenziwe ngo: -',
                    'reports-period-label': 'Ixesha: -',
                    'reports-preview-instruction': 'Khetha uhlobo lwengxelo nexesha, emva koko cofa "Yenza Ingxelo" ukuze ubone.',
                    'reports-recent': 'Iingxelo zakutshanje',
                    'reports-table-date': 'Umhla',
                    'reports-table-type': 'Uhlobo',
                    'reports-table-period': 'Ixesha',
                    'reports-table-format': 'Ifomethi',
                    'reports-table-actions': 'Izenzo',
                    'reports-no-reports': 'Akukho ngingxelo zenzwe okwangoku.',
                    'reports-view': 'Jonga',
                    'reports-download-pdf': 'Khuphela i-PDF',
                    'reports-download-word': 'Khuphela i-Word',
                    
                    // Scanner additional elements
                    'scanner-course-name': 'Igama leSifundo',
                    'scanner-course-code': 'Ikhowudi yeSifundo',
                    'scanner-sessions': 'iiseshoni',
                    'scanner-attendance': 'ukuba khona',
                    'scanner-active-qr-codes': 'iikhowudi ze-QR ezisebenzayo',
                    'scanner-active-qr-status': 'Imeko yeKhowudi ze-QR ezisebenzayo',
                    'scanner-ready-to-scan': 'Ilungile ukuskena',
                    'scanner-position-qr': 'Beka ikhowudi ye-QR ngaphakathi kwesakhiwo',
                    'scanner-scan-result': 'Isiphumo soSkena',
                    'scanner-label-pin': 'I-PIN:',
                    'scanner-label-course': 'Isifundo:',
                    'scanner-label-lecturer': 'Umfundisi:',
                    'scanner-label-session': 'I-ID yeSeshoni:',
                    'scanner-label-status': 'Imeko:',
                    'scanner-label-expires': 'Iphelelwa:',
                    'scanner-mark-attendance': 'Phawula ukuba khona',
                    'scanner-available-qr-codes': 'Iikhowudi ze-QR ezifumanekayo zeSifundo',
                    'scanner-select-course-view-qr': 'Khetha isifundo ukuze ubone iikhowudi ze-QR ezifumanekayo',
                    'scanner-recent-scans': 'Iiskena zakutshanje',
                    'scanner-table-date': 'Umhla',
                    'scanner-table-time': 'Ixesha',
                    'scanner-table-pin': 'I-PIN',
                    'scanner-table-course': 'Isifundo',
                    'scanner-table-lecturer': 'Umfundisi',
                    'scanner-table-status': 'Imeko',
                    'scanner-table-actions': 'Izenzo',
                    'scanner-no-recent-scans': 'Akukho ngingxelo zenzwe okwangoku.',
                    
                    // Calendar additional elements
                    'calendar-sun': 'iCawe',
                    'calendar-mon': 'uMvulo',
                    'calendar-tue': 'uLwesibini',
                    'calendar-wed': 'uLwesithathu',
                    'calendar-thu': 'uLwesine',
                    'calendar-fri': 'uLwesihlanu',
                    'calendar-sat': 'uMgqibelo',
                    'calendar-add-event': 'Yongeza Isiganeko',
                    'calendar-event-title': 'Isihloko seSiganeko',
                    'calendar-event-title-placeholder': 'Faka isihloko sesiganeko',
                    'calendar-event-date': 'Umhla',
                    'calendar-event-time': 'Ixesha',
                    'calendar-event-type': 'Uhlobo',
                    'calendar-event-course': 'Isifundo',
                    'calendar-select-course': 'Khetha Isifundo',
                    'calendar-event-notes': 'Amanqaku',
                    'calendar-event-notes-placeholder': 'Amanqaku angeziweyo...',
                    'calendar-add-event-btn': 'Yongeza Isiganeko',
                    'calendar-clear-btn': 'Cima',
                    'calendar-table-date': 'Umhla',
                    'calendar-table-time': 'Ixesha',
                    'calendar-table-title': 'Isihloko',
                    'calendar-table-type': 'Uhlobo',
                    'calendar-table-course': 'Isifundo',
                    'calendar-table-notes': 'Amanqaku',
                    'calendar-table-actions': 'Izenzo',
                    'calendar-no-events': 'Akukho ngingxelo zenzwe okwangoku.',
                    
                    // Calendar months
                    'calendar-january': 'uJanuwari',
                    'calendar-february': 'uFebruwari',
                    'calendar-march': 'uMatshi',
                    'calendar-april': 'uEpreli',
                    'calendar-may': 'uMeyi',
                    'calendar-june': 'uJuni',
                    'calendar-july': 'uJulayi',
                    'calendar-august': 'uAgasti',
                    'calendar-september': 'uSeptemba',
                    'calendar-october': 'uOktobha',
                    'calendar-november': 'uNovemba',
                    'calendar-december': 'uDisemba',
                    
                    // Dashboard
                    'dashboard-overview': 'Isishwankathelo seDeshibhodi',
                    'dashboard-total-lecturers': 'Abafundisi beZonke',
                    'dashboard-total-courses': 'Izifundo zeZonke',
                    'dashboard-total-attendance': 'Ukuba khona kweZonke',
                    
                    // Header
                    'welcome-student': 'Wamkelekile, Mfundi',
                    'logout': 'Phuma',
                    
                    // Settings additional
                    'settings-scanner': 'Iisetingi zeSikena',
                    'settings-default-camera': 'Ikhamera eYintloko',
                    'settings-auto-select': 'Khetha ngokuzenzekelayo',
                    'settings-back-camera': 'Ikhamera yangasemva',
                    'settings-front-camera': 'Ikhamera yangaphambili',
                    'settings-scan-quality': 'Umgangatho weSkena',
                    'settings-quality-high': 'Okuphakamileyo',
                    'settings-quality-medium': 'Okuphakathi',
                    'settings-quality-low': 'Okuphantsi',
                    'settings-auto-scan': 'Skena i-QR codes ngokuzenzekelayo',
                    'settings-sound-effects': 'Imiphumo yomsindo',
                    'settings-vibrate-scan': 'Ntshukumise xa uskena ngempumelelo',
                    'settings-data-management': 'Ulawulo lweDatha',
                    'settings-export-data': 'Thumela iDatha yam',
                    'settings-import-data': 'Ngenisa iDatha',
                    'settings-clear-data': 'Cima iDatha yonke',
                    
                    // Account Security
                    'settings-account-security': 'Ukhuseleko lweAkhawunti',
                    'settings-current-password': 'Iphasiwedi yangoku',
                    'settings-current-password-placeholder': 'Faka iphasiwedi yangoku',
                    'settings-new-password': 'Iphasiwedi entsha',
                    'settings-new-password-placeholder': 'Faka iphasiwedi entsha',
                    'settings-confirm-password': 'Qinisekisa Iphasiwedi',
                    'settings-confirm-password-placeholder': 'Qinisekisa iphasiwedi entsha',
                    'settings-change-password': 'Tshintsha Iphasiwedi',
                    
                    // Common
                    'loading': 'Iyayilayisha...',
                    'error': 'Impazamo',
                    'success': 'Impumelelo',
                    'cancel': 'Rhoxisa',
                    'save': 'Gcina',
                    'edit': 'Hlela',
                    'delete': 'Cima',
                    'confirm': 'Qinisekisa',
                    'yes': 'Ewe',
                    'no': 'Hayi'
                },
                st: {
                    // Navigation
                    'nav-dashboard': 'Dashboard',
                    'nav-profile': 'Profaele',
                    'nav-calendar': 'Khalenda',
                    'nav-courses': 'Dithuto',
                    'nav-qr-scanner': 'Sekena sa QR',
                    'nav-pin-entry': 'Kenya PIN',
                    'nav-attendance': 'Ho ba teng',
                    'nav-reports': 'Litaba',
                    'nav-settings': 'Litlhophiso',
                    
                    // Profile
                    'profile-title': 'Profaele ya Morutoana',
                    'profile-name': 'Lebitso',
                    'profile-email': 'Imeile',
                    'profile-student-id': 'Nomoro ya Morutoana',
                    'profile-course': 'Thuto',
                    'profile-year': 'Selemo',
                    'profile-edit': 'Fetola Profaele',
                    'profile-save': 'Boloka Litokiso',
                    'profile-cancel': 'Hlakola',
                    
                    // Calendar
                    'calendar-title': 'Khalenda ya Thuto',
                    'calendar-today': 'Kajeno',
                    'calendar-events': 'Lintlha tse tlang',
                    'calendar-no-events': 'Ha ho lintlha tse tlang',
                    
                    // QR Scanner
                    'qr-scanner-title': 'Sekena sa QR Code',
                    'qr-select-course': 'Khetha Thuto',
                    'qr-scan-now': 'Sekena Hona',
                    'qr-scanning': 'E sekena...',
                    'qr-success': 'Ho ba teng ho ngolotsoe!',
                    'qr-error': 'Ho sekena ha hlolehile',
                    'qr-expired': 'QR Code e felile',
                    
                    // PIN Entry
                    'pin-entry-title': 'Kenya PIN',
                    'pin-enter': 'Kenya PIN',
                    'pin-submit': 'Kenya',
                    'pin-success': 'PIN e amohetsoe',
                    'pin-error': 'PIN e fosahetseng',
                    
                    // Attendance
                    'attendance-title': 'Litaba tsa ho ba teng',
                    'attendance-stats': 'Litaba tsa ho ba teng',
                    'attendance-present': 'O teng',
                    'attendance-absent': 'Ha a teng',
                    'attendance-rate': 'Tekanyetso ya ho ba teng',
                    'attendance-total': 'Lihora tsohle',
                    
                    // Reports
                    'reports-title': 'Litaba tsa ho ba teng',
                    'reports-generate': 'Etsa Litaba',
                    'reports-download': 'Download',
                    'reports-week': 'Litaba tsa beke',
                    'reports-month': 'Litaba tsa khoeli',
                    
                    // Settings
                    'settings-title': 'Litlhophiso tsa Morutoana',
                    'settings-profile': 'Litlhophiso tsa Profaele',
                    'settings-theme': 'Mebala',
                    'settings-language': 'Puo',
                    'settings-timezone': 'Sebaka sa nako',
                    'settings-notifications': 'Litlhophiso tsa Litsebiso',
                    'settings-save': 'Boloka Litlhophiso',
                    'settings-saved': 'Litlhophiso li bolokiloe ka katleho!',
                    
                    // Theme options
                    'theme-light': 'Leseli',
                    'theme-dark': 'Leffi',
                    'theme-auto': 'Ka boeena',
                    
                    // Language options
                    'lang-english': 'Senyesemane',
                    'lang-xhosa': 'Sexhosa',
                    'lang-sesotho': 'Sesotho',
                    'lang-setswana': 'Setswana',
                    'lang-zulu': 'Zulu',
                    
                    // Timezone options
                    'timezone-sa': 'Afrika Borwa (GMT+2)',
                    'timezone-utc': 'UTC',
                    
                    // Notification options
                    'notify-attendance': 'Litsebiso tsa ho ba teng',
                    'notify-courses': 'Litokiso tsa dithuto',
                    'notify-deadlines': 'Nako ya ho felisa mosebetsi',
                    'notify-grades': 'Litokiso tsa dithuto',
                    
                    // Profile additional
                    'profile-student-id': 'ID ya Morutoana:',
                    'profile-full-name': 'Leina le Feletseng',
                    'profile-year': 'Selemo:',
                    'profile-department': 'Karo:',
                    'profile-new-password': 'Lephasiwedi le Lesha',
                    'profile-confirm-password': 'Netefatsa Lephasiwedi',
                    'profile-name-placeholder': 'Kenya leina la hao le feletseng',
                    'profile-email-placeholder': 'Kenya imeile ya hao',
                    'profile-phone-placeholder': 'Kenya nomoro ya hao ya mohala',
                    'profile-address-placeholder': 'Kenya aterese ya hao',
                    'profile-bio-placeholder': 'Re bolelle ka wena...',
                    'profile-password-placeholder': 'Kenya lephasiwedi le lesha (khetho)',
                    'profile-confirm-password-placeholder': 'Netefatsa lephasiwedi le lesha',
                    
                    // Calendar additional
                    'calendar-filter-type': 'Hlophisa ka Mofuta',
                    'calendar-all-types': 'Mefuta eohle',
                    'calendar-assignment': 'Mosebetsi',
                    'calendar-exam': 'Tekolo',
                    'calendar-lecture': 'Thuto',
                    'calendar-tutorial': 'Thuto e nyane',
                    'calendar-personal': 'Ka boeena',
                    'calendar-filter-course': 'Hlophisa ka Thuto',
                    'calendar-all-courses': 'Dithuto tsohle',
                    'calendar-apply-filter': 'Kenya Sefefo',
                    
                    // QR Scanner additional
                    'qr-select-course': 'Khetha Thuto ea ho ba teng',
                    'qr-course': 'Thuto',
                    'qr-select-course-placeholder': 'Khetha thuto ea ho skena QR code',
                    'qr-refresh-courses': 'Ntlafatsa Dithuto',
                    'qr-check-status': 'Sheba Boemo ba QR',
                    'qr-stop-scanner': 'Ema Skena',
                    
                    // PIN Entry additional
                    'pin-manual-entry': 'Ho Kenya PIN ka letsoho',
                    'pin-enter': 'Kenya PIN',
                    'pin-enter-placeholder': 'Kenya PIN e tsoang ho moruti',
                    'pin-ready': 'E lokile ho kenya PIN',
                    'pin-clear': 'Hlakola',
                    'pin-quick-entry': 'Ho Kenya PIN ka potlako',
                    'pin-enter-full': 'Kenya PIN e Feletseng',
                    'pin-enter-full-placeholder': 'Kenya PIN e nang le dinomoro tse 6',
                    'pin-history': 'Histori ya ho Kenya PIN',
                    
                    // Attendance additional
                    'attendance-date-range': 'Mokhoa oa nako',
                    'attendance-all-time': 'Nako eohle',
                    'attendance-this-week': 'Beke ena',
                    'attendance-this-month': 'Khoeli ena',
                    'attendance-this-semester': 'Semester ena',
                    'attendance-apply-filters': 'Kenya Lifefo',
                    
                    // Reports additional
                    'reports-type': 'Mofuta oa Litaba',
                    'reports-attendance': 'Litaba tsa ho ba teng',
                    'reports-academic': 'Ntleho ea Thuto',
                    'reports-course': 'Kakaretso ea Thuto',
                    'reports-period': 'Nako',
                    'reports-semester': 'Semester ena',
                    'reports-year': 'Selemo sena',
                    'reports-format': 'Mokhoa',
                    'reports-generate-btn': 'Etsa Litaba',
                    
                    // Report Preview and Recent Reports
                    'reports-preview': 'Ponahalo ea Litaba',
                    'reports-student-report': 'Litaba tsa Morutoana',
                    'reports-generated-on': 'E entsoe ka: -',
                    'reports-period-label': 'Nako: -',
                    'reports-preview-instruction': 'Khetha mofuta oa litaba le nako, ebe tobetsa "Etsa Litaba" ho bona.',
                    'reports-recent': 'Litaba tsa Haufi',
                    'reports-table-date': 'Letsatsi',
                    'reports-table-type': 'Mofuta',
                    'reports-table-period': 'Nako',
                    'reports-table-format': 'Mokhoa',
                    'reports-table-actions': 'Liketsahalo',
                    'reports-no-reports': 'Ha ho na litaba tse entsoeng hajoale.',
                    'reports-view': 'Bona',
                    'reports-download-pdf': 'Download PDF',
                    'reports-download-word': 'Download Word',
                    
                    // Scanner additional elements
                    'scanner-course-name': 'Lebitso la Thuto',
                    'scanner-course-code': 'Khoutu ea Thuto',
                    'scanner-sessions': 'likopano',
                    'scanner-attendance': 'ho ba teng',
                    'scanner-active-qr-codes': 'likhoutu tsa QR tse sebetsang',
                    'scanner-active-qr-status': 'Boemo ba Likhoutu tsa QR tse Sebetsang',
                    'scanner-ready-to-scan': 'E loketse ho skena',
                    'scanner-position-qr': 'Beha khoutu ea QR ka hare ho frame',
                    'scanner-scan-result': 'Sephetho sa ho Skena',
                    'scanner-label-pin': 'PIN:',
                    'scanner-label-course': 'Thuto:',
                    'scanner-label-lecturer': 'Mofuta:',
                    'scanner-label-session': 'ID ea Kopano:',
                    'scanner-label-status': 'Boemo:',
                    'scanner-label-expires': 'E fela:',
                    'scanner-mark-attendance': 'Tšoaea ho ba teng',
                    'scanner-available-qr-codes': 'Likhoutu tsa QR tse Fumanang bakeng sa Dithuto',
                    'scanner-select-course-view-qr': 'Khetha thuto ho bona likhoutu tsa QR tse fumanang',
                    'scanner-recent-scans': 'Lisekena tsa Haufi',
                    'scanner-table-date': 'Letsatsi',
                    'scanner-table-time': 'Nako',
                    'scanner-table-pin': 'PIN',
                    'scanner-table-course': 'Thuto',
                    'scanner-table-lecturer': 'Mofuta',
                    'scanner-table-status': 'Boemo',
                    'scanner-table-actions': 'Liketsahalo',
                    'scanner-no-recent-scans': 'Ha ho na lisekena tsa haufi tse fumaneng.',
                    
                    // Calendar additional elements
                    'calendar-sun': 'Sontaha',
                    'calendar-mon': 'Mantaha',
                    'calendar-tue': 'Labobeli',
                    'calendar-wed': 'Laboraro',
                    'calendar-thu': 'Labone',
                    'calendar-fri': 'Labohlano',
                    'calendar-sat': 'Moqebelo',
                    'calendar-add-event': 'Kenya Ketsahalo',
                    'calendar-event-title': 'Sehlooho sa Ketsahalo',
                    'calendar-event-title-placeholder': 'Kenya sehlooho sa ketsahalo',
                    'calendar-event-date': 'Letsatsi',
                    'calendar-event-time': 'Nako',
                    'calendar-event-type': 'Mofuta',
                    'calendar-event-course': 'Thuto',
                    'calendar-select-course': 'Khetha Thuto',
                    'calendar-event-notes': 'Lintlha',
                    'calendar-event-notes-placeholder': 'Lintlha tse eketsehileng...',
                    'calendar-add-event-btn': 'Kenya Ketsahalo',
                    'calendar-clear-btn': 'Hlakola',
                    'calendar-table-date': 'Letsatsi',
                    'calendar-table-time': 'Nako',
                    'calendar-table-title': 'Sehlooho',
                    'calendar-table-type': 'Mofuta',
                    'calendar-table-course': 'Thuto',
                    'calendar-table-notes': 'Lintlha',
                    'calendar-table-actions': 'Liketsahalo',
                    'calendar-no-events': 'Ha ho na liketsahalo tse fumaneng.',
                    
                    // Calendar months
                    'calendar-january': 'Pherekgong',
                    'calendar-february': 'Hlakola',
                    'calendar-march': 'Hlakubele',
                    'calendar-april': 'Mmese',
                    'calendar-may': 'Motsheanong',
                    'calendar-june': 'Phupjane',
                    'calendar-july': 'Phupu',
                    'calendar-august': 'Phata',
                    'calendar-september': 'Leotshe',
                    'calendar-october': 'Mphalane',
                    'calendar-november': 'Pudungwana',
                    'calendar-december': 'Tshitwe',
                    
                    // Dashboard
                    'dashboard-overview': 'Kakaretso ea Dashboard',
                    'dashboard-total-lecturers': 'Baruti bohle',
                    'dashboard-total-courses': 'Dithuto tsohle',
                    'dashboard-total-attendance': 'Ho ba teng ha bohle',
                    
                    // Header
                    'welcome-student': 'Rea u amohela, Morutoana',
                    'logout': 'Tsoa',
                    
                    // Settings additional
                    'settings-scanner': 'Litlhophiso tsa Skena',
                    'settings-default-camera': 'Khamera ea Kamehla',
                    'settings-auto-select': 'Khetha ka boeena',
                    'settings-back-camera': 'Khamera ea Morao',
                    'settings-front-camera': 'Khamera ea Pele',
                    'settings-scan-quality': 'Boleng ba Skena',
                    'settings-quality-high': 'E Phahameng',
                    'settings-quality-medium': 'E Pakeng',
                    'settings-quality-low': 'E Tlase',
                    'settings-auto-scan': 'Skena QR codes ka boeena',
                    'settings-sound-effects': 'Litlamorao tsa Modumo',
                    'settings-vibrate-scan': 'Hlakola ha u skena ka katleho',
                    'settings-data-management': 'Tsamaiso ea Data',
                    'settings-export-data': 'Romela Data ea ka',
                    'settings-import-data': 'Kenya Data',
                    'settings-clear-data': 'Hlakola Data eohle',
                    
                    // Account Security
                    'settings-account-security': 'Tšireletso ea Akhaonto',
                    'settings-current-password': 'Lephasiwedi la Hona Joale',
                    'settings-current-password-placeholder': 'Kenya lephasiwedi la hona joale',
                    'settings-new-password': 'Lephasiwedi le Lesha',
                    'settings-new-password-placeholder': 'Kenya lephasiwedi le lesha',
                    'settings-confirm-password': 'Netefatsa Lephasiwedi',
                    'settings-confirm-password-placeholder': 'Netefatsa lephasiwedi le lesha',
                    'settings-change-password': 'Fetola Lephasiwedi',
                    
                    // Common
                    'loading': 'E tsamaisa...',
                    'error': 'Phoso',
                    'success': 'Katleho',
                    'cancel': 'Hlakola',
                    'save': 'Boloka',
                    'edit': 'Fetola',
                    'delete': 'Hlakola',
                    'confirm': 'Netefatsa',
                    'yes': 'E',
                    'no': 'Che'
                },
                tn: {
                    // Navigation
                    'nav-dashboard': 'Dashboard',
                    'nav-profile': 'Profaele',
                    'nav-calendar': 'Khalenda',
                    'nav-courses': 'Dithuto',
                    'nav-qr-scanner': 'Sekena sa QR',
                    'nav-pin-entry': 'Tsenya PIN',
                    'nav-attendance': 'Go ba teng',
                    'nav-reports': 'Ditlaleho',
                    'nav-settings': 'Ditlhophiso',
                    
                    // Profile
                    'profile-title': 'Profaele ya Morutwana',
                    'profile-name': 'Leina',
                    'profile-email': 'Imeile',
                    'profile-student-id': 'Nomoro ya Morutwana',
                    'profile-course': 'Thuto',
                    'profile-year': 'Ngwaga',
                    'profile-edit': 'Fetola Profaele',
                    'profile-save': 'Boloka Diphetogo',
                    'profile-cancel': 'Tlosa',
                    
                    // Calendar
                    'calendar-title': 'Khalenda ya Thuto',
                    'calendar-today': 'Gompieno',
                    'calendar-events': 'Ditiragalo tse di tlang',
                    'calendar-no-events': 'Ga go na ditiragalo tse di tlang',
                    
                    // QR Scanner
                    'qr-scanner-title': 'Sekena sa QR Code',
                    'qr-select-course': 'Tlhopha Thuto',
                    'qr-scan-now': 'Sekena Jaanong',
                    'qr-scanning': 'E sekena...',
                    'qr-success': 'Go ba teng go ngwadilwe!',
                    'qr-error': 'Go sekena ga ga atlege',
                    'qr-expired': 'QR Code e fedile',
                    
                    // PIN Entry
                    'pin-entry-title': 'Tsenya PIN',
                    'pin-enter': 'Tsenya PIN',
                    'pin-submit': 'Tsenya',
                    'pin-success': 'PIN e amogetswe',
                    'pin-error': 'PIN e e fosahetseng',
                    
                    // Attendance
                    'attendance-title': 'Ditlaleho tsa go ba teng',
                    'attendance-stats': 'Ditlaleho tsa go ba teng',
                    'attendance-present': 'O teng',
                    'attendance-absent': 'Ga a teng',
                    'attendance-rate': 'Tekanyetso ya go ba teng',
                    'attendance-total': 'Dihora tsotlhe',
                    
                    // Reports
                    'reports-title': 'Ditlaleho tsa go ba teng',
                    'reports-generate': 'Tlhamela Tlaleho',
                    'reports-download': 'Download',
                    'reports-week': 'Tlaleho ya beke',
                    'reports-month': 'Tlaleho ya kgwedi',
                    
                    // Settings
                    'settings-title': 'Ditlhophiso tsa Morutwana',
                    'settings-profile': 'Ditlhophiso tsa Profaele',
                    'settings-theme': 'Mebala',
                    'settings-language': 'Puo',
                    'settings-timezone': 'Lefelo la nako',
                    'settings-notifications': 'Ditlhophiso tsa Ditsebiso',
                    'settings-save': 'Boloka Ditlhophiso',
                    'settings-saved': 'Ditlhophiso di bolokilwe ka katleho!',
                    
                    // Theme options
                    'theme-light': 'Lesedi',
                    'theme-dark': 'Leffi',
                    'theme-auto': 'Ka boeena',
                    
                    // Language options
                    'lang-english': 'Sekgowa',
                    'lang-xhosa': 'Sexhosa',
                    'lang-sesotho': 'Sesotho',
                    'lang-setswana': 'Setswana',
                    'lang-zulu': 'Zulu',
                    
                    // Timezone options
                    'timezone-sa': 'Aforika Borwa (GMT+2)',
                    'timezone-utc': 'UTC',
                    
                    // Notification options
                    'notify-attendance': 'Ditsebiso tsa go ba teng',
                    'notify-courses': 'Ditokiso tsa dithuto',
                    'notify-deadlines': 'Nako ya go fetsa tiriso',
                    'notify-grades': 'Ditokiso tsa dithuto',
                    
                    // Profile additional
                    'profile-student-id': 'ID ya Morutwana:',
                    'profile-full-name': 'Leina le Feletseng',
                    'profile-year': 'Ngwaga:',
                    'profile-department': 'Kgaolo:',
                    'profile-new-password': 'Lephasiwedi le Lesha',
                    'profile-confirm-password': 'Netefatsa Lephasiwedi',
                    'profile-name-placeholder': 'Kenya leina la gago le feletseng',
                    'profile-email-placeholder': 'Kenya imeile ya gago',
                    'profile-phone-placeholder': 'Kenya nomoro ya gago ya mogala',
                    'profile-address-placeholder': 'Kenya aterese ya gago',
                    'profile-bio-placeholder': 'Re bolelele ka wena...',
                    'profile-password-placeholder': 'Kenya lephasiwedi le lesha (kgethego)',
                    'profile-confirm-password-placeholder': 'Netefatsa lephasiwedi le lesha',
                    
                    // Calendar additional
                    'calendar-filter-type': 'Hlophisa ka Mofuta',
                    'calendar-all-types': 'Mefuta yotlhe',
                    'calendar-assignment': 'Tiriso',
                    'calendar-exam': 'Tekolo',
                    'calendar-lecture': 'Thuto',
                    'calendar-tutorial': 'Thuto e nnye',
                    'calendar-personal': 'Ka boeena',
                    'calendar-filter-course': 'Hlophisa ka Thuto',
                    'calendar-all-courses': 'Dithuto tsotlhe',
                    'calendar-apply-filter': 'Kenya Sefefo',
                    
                    // QR Scanner additional
                    'qr-select-course': 'Kgethe Thuto ya go ba teng',
                    'qr-course': 'Thuto',
                    'qr-select-course-placeholder': 'Kgethe thuto ya go skena QR code',
                    'qr-refresh-courses': 'Ntlafatsa Dithuto',
                    'qr-check-status': 'Lebelela Boemo ba QR',
                    'qr-stop-scanner': 'Ema Skena',
                    
                    // PIN Entry additional
                    'pin-manual-entry': 'Go Kenya PIN ka seatla',
                    'pin-enter': 'Kenya PIN',
                    'pin-enter-placeholder': 'Kenya PIN e tswang mo moruti',
                    'pin-ready': 'E siame go kenya PIN',
                    'pin-clear': 'Hlakola',
                    'pin-quick-entry': 'Go Kenya PIN ka potlako',
                    'pin-enter-full': 'Kenya PIN e Feletseng',
                    'pin-enter-full-placeholder': 'Kenya PIN e nang le dinomoro tse 6',
                    'pin-history': 'Histori ya go Kenya PIN',
                    
                    // Attendance additional
                    'attendance-date-range': 'Mokgwa wa nako',
                    'attendance-all-time': 'Nako yotlhe',
                    'attendance-this-week': 'Beke eno',
                    'attendance-this-month': 'Kgwedi eno',
                    'attendance-this-semester': 'Semester eno',
                    'attendance-apply-filters': 'Kenya Difefo',
                    
                    // Reports additional
                    'reports-type': 'Mofuta wa Ditlaleho',
                    'reports-attendance': 'Ditlaleho tsa go ba teng',
                    'reports-academic': 'Ntleho ya Thuto',
                    'reports-course': 'Kakaretso ya Thuto',
                    'reports-period': 'Nako',
                    'reports-semester': 'Semester eno',
                    'reports-year': 'Ngwaga ono',
                    'reports-format': 'Mokgwa',
                    'reports-generate-btn': 'Tlhamela Tlaleho',
                    
                    // Report Preview and Recent Reports
                    'reports-preview': 'Ponagalo ya Ditlaleho',
                    'reports-student-report': 'Tlaleho ya Morutwana',
                    'reports-generated-on': 'E tlhamilwe ka: -',
                    'reports-period-label': 'Nako: -',
                    'reports-preview-instruction': 'Kgethe mofuta wa tlaleho le nako, ebe tobetsa "Tlhamela Tlaleho" go bona.',
                    'reports-recent': 'Ditlaleho tsa Bosheng',
                    'reports-table-date': 'Letsatsi',
                    'reports-table-type': 'Mofuta',
                    'reports-table-period': 'Nako',
                    'reports-table-format': 'Mokgwa',
                    'reports-table-actions': 'Ditiro',
                    'reports-no-reports': 'Ga go na ditlaleho tse di tlhamilweng go fitlha jaanong.',
                    'reports-view': 'Bona',
                    'reports-download-pdf': 'Download PDF',
                    'reports-download-word': 'Download Word',
                    
                    // Scanner additional elements
                    'scanner-course-name': 'Leina la Thuto',
                    'scanner-course-code': 'Khoutu ya Thuto',
                    'scanner-sessions': 'dikopano',
                    'scanner-attendance': 'go ba teng',
                    'scanner-active-qr-codes': 'dikhoutu tsa QR tse di dirang',
                    'scanner-active-qr-status': 'Maemo a Dikhoutu tsa QR tse di Dirang',
                    'scanner-ready-to-scan': 'E siame go skena',
                    'scanner-position-qr': 'Bea khoutu ya QR ka gare ga frame',
                    'scanner-scan-result': 'Phetho ya go Skena',
                    'scanner-label-pin': 'PIN:',
                    'scanner-label-course': 'Thuto:',
                    'scanner-label-lecturer': 'Moruti:',
                    'scanner-label-session': 'ID ya Kopano:',
                    'scanner-label-status': 'Maemo:',
                    'scanner-label-expires': 'E fela:',
                    'scanner-mark-attendance': 'Tshwaisa go ba teng',
                    'scanner-available-qr-codes': 'Dikhoutu tsa QR tse di Fumanang bakeng sa Dithuto',
                    'scanner-select-course-view-qr': 'Kgethe thuto go bona dikhoutu tsa QR tse di fumanang',
                    'scanner-recent-scans': 'Disekena tsa Bosheng',
                    'scanner-table-date': 'Letsatsi',
                    'scanner-table-time': 'Nako',
                    'scanner-table-pin': 'PIN',
                    'scanner-table-course': 'Thuto',
                    'scanner-table-lecturer': 'Moruti',
                    'scanner-table-status': 'Maemo',
                    'scanner-table-actions': 'Ditiro',
                    'scanner-no-recent-scans': 'Ga go na disekena tsa bosheng tse di fumaneng.',
                    
                    // Calendar additional elements
                    'calendar-sun': 'Tshipi',
                    'calendar-mon': 'Mosupologo',
                    'calendar-tue': 'Labobedi',
                    'calendar-wed': 'Laboraro',
                    'calendar-thu': 'Labone',
                    'calendar-fri': 'Labotlhano',
                    'calendar-sat': 'Matlhatso',
                    'calendar-add-event': 'Tsenya Ketsahalo',
                    'calendar-event-title': 'Thitlhaletso ya Ketsahalo',
                    'calendar-event-title-placeholder': 'Tsenya thitlhaletso ya ketsahalo',
                    'calendar-event-date': 'Letsatsi',
                    'calendar-event-time': 'Nako',
                    'calendar-event-type': 'Mofuta',
                    'calendar-event-course': 'Thuto',
                    'calendar-select-course': 'Kgethe Thuto',
                    'calendar-event-notes': 'Dintlha',
                    'calendar-event-notes-placeholder': 'Dintlha tse di eketsehileng...',
                    'calendar-add-event-btn': 'Tsenya Ketsahalo',
                    'calendar-clear-btn': 'Hlakola',
                    'calendar-table-date': 'Letsatsi',
                    'calendar-table-time': 'Nako',
                    'calendar-table-title': 'Thitlhaletso',
                    'calendar-table-type': 'Mofuta',
                    'calendar-table-course': 'Thuto',
                    'calendar-table-notes': 'Dintlha',
                    'calendar-table-actions': 'Ditiro',
                    'calendar-no-events': 'Ga go na diketsahalo tse di fumaneng.',
                    
                    // Calendar months
                    'calendar-january': 'Ferikgong',
                    'calendar-february': 'Tlhakole',
                    'calendar-march': 'Tlhakubele',
                    'calendar-april': 'Mmese',
                    'calendar-may': 'Motsheanong',
                    'calendar-june': 'Phupjane',
                    'calendar-july': 'Phupu',
                    'calendar-august': 'Phata',
                    'calendar-september': 'Lwetse',
                    'calendar-october': 'Diphalane',
                    'calendar-november': 'Ngwanatsele',
                    'calendar-december': 'Sedimonthole',
                    
                    // Dashboard
                    'dashboard-overview': 'Kakaretso ya Dashboard',
                    'dashboard-total-lecturers': 'Baruti botlhe',
                    'dashboard-total-courses': 'Dithuto tsotlhe',
                    'dashboard-total-attendance': 'Go ba teng ga botlhe',
                    
                    // Header
                    'welcome-student': 'Re a go amogela, Morutwana',
                    'logout': 'Tswa',
                    
                    // Settings additional
                    'settings-scanner': 'Ditlhophiso tsa Skena',
                    'settings-default-camera': 'Khamera ya Kamehla',
                    'settings-auto-select': 'Kgethe ka boeena',
                    'settings-back-camera': 'Khamera ya Morago',
                    'settings-front-camera': 'Khamera ya Pele',
                    'settings-scan-quality': 'Boleng jwa Skena',
                    'settings-quality-high': 'E Kgodimo',
                    'settings-quality-medium': 'E Gare',
                    'settings-quality-low': 'E Tlase',
                    'settings-auto-scan': 'Skena QR codes ka boeena',
                    'settings-sound-effects': 'Ditlamorao tsa Modumo',
                    'settings-vibrate-scan': 'Hlakola fa o skena ka katlego',
                    'settings-data-management': 'Tsamaiso ya Data',
                    'settings-export-data': 'Romela Data ya me',
                    'settings-import-data': 'Kenya Data',
                    'settings-clear-data': 'Hlakola Data yotlhe',
                    
                    // Account Security
                    'settings-account-security': 'Tšhireletso ya Akhaonto',
                    'settings-current-password': 'Lephasiwedi la Gompieno',
                    'settings-current-password-placeholder': 'Kenya lephasiwedi la gompieno',
                    'settings-new-password': 'Lephasiwedi le Lesha',
                    'settings-new-password-placeholder': 'Kenya lephasiwedi le lesha',
                    'settings-confirm-password': 'Netefatsa Lephasiwedi',
                    'settings-confirm-password-placeholder': 'Netefatsa lephasiwedi le lesha',
                    'settings-change-password': 'Fetola Lephasiwedi',
                    
                    // Common
                    'loading': 'E tsamaisa...',
                    'error': 'Phoso',
                    'success': 'Katleho',
                    'cancel': 'Tlosa',
                    'save': 'Boloka',
                    'edit': 'Fetola',
                    'delete': 'Tlosa',
                    'confirm': 'Netefatsa',
                    'yes': 'Ee',
                    'no': 'Nnyaa'
                },
                zu: {
                    // Navigation
                    'nav-dashboard': 'Ideshibhodi',
                    'nav-profile': 'Iphrofayili',
                    'nav-calendar': 'Ikhalenda',
                    'nav-courses': 'Izifundo',
                    'nav-qr-scanner': 'Isikena se-QR',
                    'nav-pin-entry': 'Ukufaka i-PIN',
                    'nav-attendance': 'Ukuba Khona',
                    'nav-reports': 'Imibiko',
                    'nav-settings': 'Izilungiselelo',
                    
                    // Profile
                    'profile-title': 'Iphrofayili Yomfundi',
                    'profile-name': 'Igama',
                    'profile-email': 'I-imeyili',
                    'profile-student-id': 'I-ID Yomfundi',
                    'profile-course': 'Isifundo',
                    'profile-year': 'Unyaka',
                    'profile-edit': 'Hlela Iphrofayili',
                    'profile-save': 'Gcina Izinguquko',
                    'profile-cancel': 'Khansela',
                    
                    // Calendar
                    'calendar-title': 'Ikhalenda Yezifundo',
                    'calendar-today': 'Namuhla',
                    'calendar-events': 'Imicimbi Ezizayo',
                    'calendar-no-events': 'Awukho imicimbi ezizayo',
                    
                    // QR Scanner
                    'qr-scanner-title': 'Isikena Sekhodi ye-QR',
                    'qr-select-course': 'Khetha Isifundo',
                    'qr-scan-now': 'Skena Manje',
                    'qr-scanning': 'Iyasikena...',
                    'qr-success': 'Ukuba Khona Kukhonjisiwe!',
                    'qr-error': 'Ukusikena Kuhlulekile',
                    'qr-expired': 'Ikhodi ye-QR Iphelelwe',
                    
                    // PIN Entry
                    'pin-entry-title': 'Ukufaka i-PIN',
                    'pin-enter': 'Faka i-PIN',
                    'pin-submit': 'Thumela',
                    'pin-success': 'I-PIN Yamukelwe',
                    'pin-error': 'I-PIN Engavumelekile',
                    
                    // Attendance
                    'attendance-title': 'Amarekhodi Wokuba Khona',
                    'attendance-stats': 'Izibalo Zokuba Khona',
                    'attendance-present': 'Ukhona',
                    'attendance-absent': 'Akekho',
                    'attendance-rate': 'Isilinganiso Sokuba Khona',
                    'attendance-total': 'Isamba',
                    'attendance-present-count': 'Abakhona',
                    'attendance-absent-count': 'Abangekho',
                    
                    // Reports
                    'reports-title': 'Imibiko',
                    'reports-attendance': 'Umbiko Wokuba Khona',
                    'reports-course': 'Umbiko Wesifundo',
                    'reports-download': 'Thoba',
                    'reports-generate': 'Dala Umbiko',
                    
                    // Settings
                    'settings-title': 'Izilungiselelo',
                    'settings-profile': 'Iphrofayili',
                    'settings-preferences': 'Okukhethwayo',
                    'settings-notifications': 'Izaziso',
                    'settings-theme': 'Isihloko',
                    'settings-language': 'Ulimi',
                    'settings-timezone': 'Isikhathi Sendawo',
                    'settings-save': 'Gcina',
                    'settings-cancel': 'Khansela',
                    
                    // Theme options
                    'theme-light': 'Ukukhanya',
                    'theme-dark': 'Ubumnyama',
                    'theme-auto': 'Ngokuzenzekelayo',
                    
                    // Language options
                    'lang-english': 'IsiNgesi',
                    'lang-xhosa': 'IsiXhosa',
                    'lang-sesotho': 'Sesotho',
                    'lang-setswana': 'Setswana',
                    'lang-zulu': 'IsiZulu',
                    
                    // Timezone options
                    'timezone-sa': 'eNingizimu Afrika (GMT+2)',
                    'timezone-utc': 'UTC',
                    
                    // Notifications
                    'notify-attendance': 'Izaziso Zokuba Khona',
                    'notify-courses': 'Izaziso Zezifundo',
                    'notify-deadlines': 'Izaziso Zomhla Wokuphela',
                    'notify-announcements': 'Izaziso Zokumenyezelwa',
                    
                    // Calendar Months
                    'calendar-january': 'uJanuwari',
                    'calendar-february': 'uFebruwari',
                    'calendar-march': 'uMatshi',
                    'calendar-april': 'u-Apreli',
                    'calendar-may': 'uMeyi',
                    'calendar-june': 'uJuni',
                    'calendar-july': 'uJulayi',
                    'calendar-august': 'u-Agasti',
                    'calendar-september': 'uSepthemba',
                    'calendar-october': 'u-Okthoba',
                    'calendar-november': 'uNovemba',
                    'calendar-december': 'uDisemba',
                    
                    // Calendar Days
                    'day-sunday': 'ISonto',
                    'day-monday': 'UMsombuluko',
                    'day-tuesday': 'ULwesibili',
                    'day-wednesday': 'ULwesithathu',
                    'day-thursday': 'ULwesine',
                    'day-friday': 'ULwesihlanu',
                    'day-saturday': 'UMgqibelo',
                    
                    // Calendar Controls
                    'calendar-prev-month': 'Inyanga Edlule',
                    'calendar-next-month': 'Inyanga Ezayo',
                    'calendar-add-event': 'Engeza Umcimbi',
                    'calendar-event-title': 'Isihloko Somcimbi',
                    'calendar-event-date': 'Usuku Lomcimbi',
                    'calendar-event-time': 'Isikhathi Somcimbi',
                    'calendar-event-type': 'Uhlobo Lomcimbi',
                    'calendar-event-course': 'Isifundo',
                    'calendar-event-notes': 'Amanothi',
                    'calendar-add-event-btn': 'Engeza Umcimbi',
                    'calendar-clear-btn': 'Sula',
                    
                    // Event Types
                    'event-assignment': 'Umsebenzi',
                    'event-exam': 'Isivivinyo',
                    'event-lecture': 'Isifundo',
                    'event-tutorial': 'Isifundo Sokufundisa',
                    'event-personal': 'Okwakho',
                    
                    // Calendar Table
                    'calendar-table-date': 'Usuku',
                    'calendar-table-time': 'Isikhathi',
                    'calendar-table-title': 'Isihloko',
                    'calendar-table-type': 'Uhlobo',
                    'calendar-table-course': 'Isifundo',
                    'calendar-table-notes': 'Amanothi',
                    'calendar-table-actions': 'Izenzo',
                    'calendar-no-events': 'Awukho imicimbi etholakele.',
                    
                    // Common actions
                    'save': 'Gcina',
                    'cancel': 'Khansela',
                    'edit': 'Hlela',
                    'delete': 'Susa',
                    'confirm': 'Qinisekisa',
                    'yes': 'Yebo',
                    'no': 'Cha'
                }
            };

            function applyLanguage() {
                try {
                    const language = studentLanguageSelect?.value || 'en';
                    const currentTranslations = translations[language] || translations.en;
                    
                    // Update all elements with data-translate attribute
                    document.querySelectorAll('[data-translate]').forEach(element => {
                        const key = element.getAttribute('data-translate');
                        const translation = currentTranslations[key];
                        if (translation) {
                            if (element.tagName === 'INPUT' && element.type === 'text') {
                                element.placeholder = translation;
                            } else if (element.tagName === 'OPTION') {
                                // Handle option elements specially
                                element.textContent = translation;
                            } else {
                                element.textContent = translation;
                            }
                        }
                    });
                    
                    // Update all elements with data-translate-placeholder attribute
                    document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                        const key = element.getAttribute('data-translate-placeholder');
                        const translation = currentTranslations[key];
                        if (translation) {
                            element.placeholder = translation;
                        }
                    });
                    
                    // Update page title
                    document.title = currentTranslations['nav-profile'] || 'Student Dashboard';
                    
                    // Update specific elements by ID
                    const elementsToUpdate = {
                        'profile-title': 'profile-title',
                        'calendar-title': 'calendar-title',
                        'qr-scanner-title': 'qr-scanner-title',
                        'pin-entry-title': 'pin-entry-title',
                        'attendance-title': 'attendance-title',
                        'reports-title': 'reports-title',
                        'settings-title': 'settings-title'
                    };
                    
                    Object.entries(elementsToUpdate).forEach(([key, elementId]) => {
                        const element = document.getElementById(elementId);
                        if (element && currentTranslations[key]) {
                            element.textContent = currentTranslations[key];
                        }
                    });
                    
                    // Update select option values to match current language
                    updateSelectOptions(currentTranslations);
                    
                    // Update calendar month display
                    if (typeof currentMonth !== 'undefined' && typeof currentYear !== 'undefined') {
                        updateCalendarMonthDisplay(currentMonth, currentYear);
                    }
                    
                } catch (error) {
                    console.error('Error applying language:', error);
                }
            }

            function updateSelectOptions(translations) {
                // Update theme select options
                const themeSelect = document.getElementById('student-theme');
                if (themeSelect) {
                    Array.from(themeSelect.options).forEach(option => {
                        const key = option.getAttribute('data-translate');
                        if (key && translations[key]) {
                            option.textContent = translations[key];
                        }
                    });
                }
                
                // Update language select options
                const languageSelect = document.getElementById('student-language');
                if (languageSelect) {
                    Array.from(languageSelect.options).forEach(option => {
                        const key = option.getAttribute('data-translate');
                        if (key && translations[key]) {
                            option.textContent = translations[key];
                        }
                    });
                }
                
                // Update timezone select options
                const timezoneSelect = document.getElementById('student-timezone');
                if (timezoneSelect) {
                    Array.from(timezoneSelect.options).forEach(option => {
                        const key = option.getAttribute('data-translate');
                        if (key && translations[key]) {
                            option.textContent = translations[key];
                        }
                    });
                }
            }

            function loadSettings(){
                try {
                    const profile = JSON.parse(localStorage.getItem('studentProfile') || '{}');
                    studentThemeSelect.value = profile.theme || 'light';
                    studentLanguageSelect.value = profile.language || 'en';
                    studentTimezoneSelect.value = profile.timezone || 'Africa/Johannesburg';
                    notifyAttendanceCheckbox.checked = profile.notifyAttendance || true;
                    notifyCoursesCheckbox.checked = profile.notifyCourses || true;
                    notifyDeadlinesCheckbox.checked = profile.notifyDeadlines || true;
                    notifyGradesCheckbox.checked = profile.notifyGrades || false;
                    scannerCameraSelect.value = profile.scannerCamera || 'auto';
                    scannerQualitySelect.value = profile.scannerQuality || 'medium';
                    autoScanCheckbox.checked = profile.autoScan || true;
                    soundEffectsCheckbox.checked = profile.soundEffects || true;
                    vibrateOnScanCheckbox.checked = profile.vibrateOnScan || true;

                    // Apply theme and language immediately when loading settings
                    applyTheme();
                    applyLanguage();

                    // Add event listeners for settings checkboxes/selects
                    studentThemeSelect.addEventListener('change', () => {
                        applyTheme();
                        saveSettings();
                    });
                    studentLanguageSelect.addEventListener('change', () => {
                        applyLanguage();
                        saveSettings();
                    });
                    studentTimezoneSelect.addEventListener('change', saveSettings);
                    notifyAttendanceCheckbox.addEventListener('change', saveSettings);
                    notifyCoursesCheckbox.addEventListener('change', saveSettings);
                    notifyDeadlinesCheckbox.addEventListener('change', saveSettings);
                    notifyGradesCheckbox.addEventListener('change', saveSettings);
                    scannerCameraSelect.addEventListener('change', saveSettings);
                    scannerQualitySelect.addEventListener('change', saveSettings);
                    autoScanCheckbox.addEventListener('change', saveSettings);
                    soundEffectsCheckbox.addEventListener('change', saveSettings);
                    vibrateOnScanCheckbox.addEventListener('change', saveSettings);

                    // Add event listeners for password change
                    changePasswordBtn?.addEventListener('click', () => {
                        const current = currentPasswordInput.value.trim();
                        const newPass = newPasswordInput.value.trim();
                        const confirm = confirmPasswordInput.value.trim();

                        if (!current) {
                            alert('Please enter your current password.');
                            return;
                        }
                        if (!newPass) {
                            alert('New password cannot be empty.');
                            return;
                        }
                        if (newPass !== confirm) {
                            alert('New passwords do not match.');
                            return;
                        }

                        // Simulate password change
                        if (current === 'password123') { // Replace with actual password check
                            alert('Password changed successfully!');
                            // In a real app, you'd save the new password to localStorage
                            // localStorage.setItem('studentProfile', JSON.stringify({ ...profile, password: newPass }));
                        } else {
                            alert('Incorrect current password.');
                        }
                    });

                    // Add event listeners for file imports/exports
                    exportStudentDataBtn?.addEventListener('click', () => {
                        const data = JSON.stringify(JSON.parse(localStorage.getItem('studentProfile') || '{}'), null, 2);
                        const blob = new Blob([data], { type: 'application/json' });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = 'student_profile.json';
                        a.click();
                        URL.revokeObjectURL(a.href);
                    });

                    importStudentDataBtn?.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                try {
                                    const importedData = JSON.parse(event.target.result);
                                    if (importedData.name && importedData.email) {
                                        localStorage.setItem('studentProfile', JSON.stringify(importedData));
                                        loadStudentProfile();
                                        alert('Profile data imported successfully!');
                                    } else {
                                        alert('Imported file does not contain valid profile data.');
                                    }
                                } catch (error) {
                                    alert('Error importing data: ' + error.message);
                                }
                            };
                            reader.readAsText(file);
                        }
                    });

                    clearStudentDataBtn?.addEventListener('click', () => {
                        if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                            localStorage.clear();
                            alert('All data cleared successfully!');
                            location.reload(); // Reload to show default values
                        }
                    });
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }

            function saveSettings(){
                const profile = JSON.parse(localStorage.getItem('studentProfile') || '{}');
                profile.theme = studentThemeSelect.value;
                profile.language = studentLanguageSelect.value;
                profile.timezone = studentTimezoneSelect.value;
                profile.notifyAttendance = notifyAttendanceCheckbox.checked;
                profile.notifyCourses = notifyCoursesCheckbox.checked;
                profile.notifyDeadlines = notifyDeadlinesCheckbox.checked;
                profile.notifyGrades = notifyGradesCheckbox.checked;
                profile.scannerCamera = scannerCameraSelect.value;
                profile.scannerQuality = scannerQualitySelect.value;
                profile.autoScan = autoScanCheckbox.checked;
                profile.soundEffects = soundEffectsCheckbox.checked;
                profile.vibrateOnScan = vibrateOnScanCheckbox.checked;

                localStorage.setItem('studentProfile', JSON.stringify(profile));
                alert('Settings saved successfully!');
            }



            // Initialize
            loadStudentProfile();
            populateCourseOptions();
            renderCalendar();
            renderEvents();
            loadAttendanceStats();
            loadAttendanceRecords();
            loadReports();
            generateReportPreview();
            loadSettings();
            
            // Initialize theme and language on page load
            applyTheme();
            applyLanguage();
            
            // Set up periodic QR availability check (every 10 seconds)
            setInterval(updateQRCodeAvailabilityStatus, 10000);
            
            // Test button functionality after a short delay
            setTimeout(() => {
                console.log('Testing button functionality...');
                const testBtn = document.getElementById('start-scan-btn');
                if (testBtn) {
                    console.log('Button found, testing click...');
                    // Add a simple test click
                    testBtn.onclick = function() {
                        console.log('Button onclick handler triggered');
                    };
                } else {
                    console.error('Button not found in DOM');
                }
            }, 1000);
            
            // Set up periodic refresh of admin events (every 30 seconds)
            setTimeout(() => {
                setInterval(refreshAdminEvents, 30000);
            }, 5000); // Start after 5 seconds
        });

        // Enhanced QR Code and Course Management
        class EnhancedQRManager {
            constructor() {
                this.courseSessions = new Map();
                this.selectedCourse = null;
                this.init();
            }
            
            init() {
                this.loadCourseSessions();
                this.setupEventListeners();
                this.startStatusUpdates();
            }
            
            loadCourseSessions() {
                // Load course sessions from localStorage (shared with lecturer)
                const sessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                this.courseSessions.clear();
                
                sessions.forEach(session => {
                    if (!this.courseSessions.has(session.courseCode)) {
                        this.courseSessions.set(session.courseCode, []);
                    }
                    this.courseSessions.get(session.courseCode).push(session);
                });
                
                this.updateCourseDisplay();
            }
            
            setupEventListeners() {
                // Course selection change
                const courseSelect = document.getElementById('scanner-course-select');
                if (courseSelect) {
                    courseSelect.addEventListener('change', (e) => {
                        this.selectedCourse = e.target.value;
                        this.updateQRStatus();
                        this.updateCourseInfo();
                    });
                }
                
                // Enhanced course option selection
                document.addEventListener('click', (e) => {
                    if (e.target.closest('.course-option')) {
                        const courseOption = e.target.closest('.course-option');
                        const courseCode = courseOption.dataset.courseCode;
                        
                        // Update selection
                        document.querySelectorAll('.course-option').forEach(opt => 
                            opt.classList.remove('selected'));
                        courseOption.classList.add('selected');
                        
                        // Update course select
                        if (courseSelect) {
                            courseSelect.value = courseCode;
                            courseSelect.dispatchEvent(new Event('change'));
                        }
                    }
                });
                
                // Scan now buttons
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-scan-now')) {
                        const courseCode = e.target.dataset.courseCode;
                        this.startScanning(courseCode);
                    }
                });
            }
            
            updateCourseDisplay() {
                // Update course select options
                const courseSelect = document.getElementById('scanner-course-select');
                if (!courseSelect) return;
                
                // Clear existing options
                courseSelect.innerHTML = '<option value="">Select a course to scan QR code for</option>';
                
                // Add course options with QR status
                this.courseSessions.forEach((sessions, courseCode) => {
                    const option = document.createElement('option');
                    option.value = courseCode;
                    
                    const activeSessions = sessions.filter(s => 
                        new Date(s.expiryTime) > new Date() && s.status === 'active');
                    
                    if (activeSessions.length > 0) {
                        option.textContent = `${courseCode} - QR Available (${activeSessions.length} active)`;
                    } else {
                        option.textContent = `${courseCode} - No QR Available`;
                    }
                    
                    courseSelect.appendChild(option);
                });
                
                // Update enhanced course options display
                this.updateEnhancedCourseOptions();
            }
            
            updateEnhancedCourseOptions() {
                const container = document.querySelector('.course-options');
                if (!container) return;
                
                container.innerHTML = '';
                
                this.courseSessions.forEach((sessions, courseCode) => {
                    const activeSessions = sessions.filter(s => 
                        new Date(s.expiryTime) > new Date() && s.status === 'active');
                    
                    const option = document.createElement('div');
                    option.className = 'course-option';
                    option.dataset.courseCode = courseCode;
                    
                    const statusClass = activeSessions.length > 0 ? 'available' : 'none';
                    const statusText = activeSessions.length > 0 ? 
                        `${activeSessions.length} QR Available` : 'No QR Available';
                    
                    option.innerHTML = `
                        <h6>${courseCode}</h6>
                        <p>${this.getCourseName(courseCode)}</p>
                        <span class="qr-status ${statusClass}">${statusText}</span>
                    `;
                    
                    container.appendChild(option);
                });
            }
            
            updateQRStatus() {
                const container = document.getElementById('qr-status-container');
                if (!container || !this.selectedCourse) return;
                
                const sessions = this.courseSessions.get(this.selectedCourse) || [];
                const activeSessions = sessions.filter(s => 
                    new Date(s.expiryTime) > new Date() && s.status === 'active');
                
                if (activeSessions.length === 0) {
                    container.innerHTML = `
                        <div class="qr-placeholder">
                            <i class="fas fa-qrcode"></i>
                            <h5>No Active QR Codes</h5>
                            <p>There are no active QR codes for ${this.selectedCourse} at the moment.</p>
                            <small>Ask your lecturer to generate a new QR code for attendance.</small>
                        </div>
                    `;
                    return;
                }
                
                // Display active QR codes
                container.innerHTML = `
                    <div class="qr-status-grid">
                        ${activeSessions.map(session => this.createQRStatusCard(session)).join('')}
                    </div>
                `;
            }
            
            createQRStatusCard(session) {
                const expiryTime = new Date(session.expiryTime);
                const timeLeft = this.getTimeLeft(expiryTime);
                const isExpired = expiryTime <= new Date();
                
                let statusClass = 'active';
                let statusText = 'Active';
                
                if (isExpired) {
                    statusClass = 'expired';
                    statusText = 'Expired';
                } else if (session.status === 'closed') {
                    statusClass = 'closed';
                    statusText = 'Closed';
                }
                
                return `
                    <div class="qr-status-card ${statusClass}">
                        <div class="qr-status-header">
                            <h6>Session ${session.sessionId}</h6>
                            <span class="qr-status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="qr-status-content">
                            <div class="qr-status-item">
                                <span class="label">Course:</span>
                                <span class="value">${session.courseCode}</span>
                            </div>
                            <div class="qr-status-item">
                                <span class="label">Created:</span>
                                <span class="value">${new Date(session.createdTime).toLocaleTimeString()}</span>
                            </div>
                            <div class="qr-status-item">
                                <span class="label">Expires:</span>
                                <span class="value">${expiryTime.toLocaleTimeString()}</span>
                            </div>
                            <div class="qr-status-item">
                                <span class="label">Time Left:</span>
                                <span class="value">${timeLeft}</span>
                            </div>
                        </div>
                        <div class="qr-status-actions">
                            <button class="btn-scan-now" 
                                    data-course-code="${session.courseCode}"
                                    data-session-id="${session.sessionId}"
                                    ${isExpired ? 'disabled' : ''}>
                                ${isExpired ? 'Expired' : 'Scan Now'}
                            </button>
                        </div>
                    </div>
                `;
            }
            
            updateCourseInfo() {
                const container = document.querySelector('.course-info');
                if (!container || !this.selectedCourse) return;
                
                const sessions = this.courseSessions.get(this.selectedCourse) || [];
                const totalSessions = sessions.length;
                const activeSessions = sessions.filter(s => 
                    new Date(s.expiryTime) > new Date() && s.status === 'active');
                const completedSessions = sessions.filter(s => s.status === 'completed');
                
                container.innerHTML = `
                    <div class="info-card">
                        <h5>${this.selectedCourse} - ${this.getCourseName(this.selectedCourse)}</h5>
                        <p>Course information and QR code status</p>
                        <div class="course-stats">
                            <div class="stat">
                                <i class="fas fa-qrcode"></i>
                                <span>Total Sessions: ${totalSessions}</span>
                            </div>
                            <div class="stat">
                                <i class="fas fa-clock"></i>
                                <span>Active QR: ${activeSessions.length}</span>
                            </div>
                            <div class="stat">
                                <i class="fas fa-check-circle"></i>
                                <span>Completed: ${completedSessions.length}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getTimeLeft(expiryTime) {
                const now = new Date();
                const diff = expiryTime - now;
                
                if (diff <= 0) return 'Expired';
                
                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                
                if (minutes > 0) {
                    return `${minutes}m ${seconds}s`;
                }
                return `${seconds}s`;
            }
            
            getCourseName(courseCode) {
                // Map course codes to names (could be enhanced with a proper course database)
                const courseNames = {
                    'CS101': 'Introduction to Computer Science',
                    'CS201': 'Data Structures and Algorithms',
                    'CS301': 'Software Engineering',
                    'MATH101': 'Calculus I',
                    'PHYS101': 'Physics I'
                };
                
                return courseNames[courseCode] || courseCode;
            }
            
            startScanning(courseCode) {
                // Set the selected course and start the scanner
                if (courseCode) {
                    const courseSelect = document.getElementById('scanner-course-select');
                    if (courseSelect) {
                        courseSelect.value = courseCode;
                        courseSelect.dispatchEvent(new Event('change'));
                    }
                }
                
                // Start the QR scanner
                this.startScanner();
            }
            
            startScanner() {
                // Implementation for starting the QR scanner
                console.log('Starting QR scanner for course:', this.selectedCourse);
                
                // Show scanner interface
                const scannerSection = document.getElementById('qrcodescanner');
                if (scannerSection) {
                    scannerSection.style.display = 'block';
                }
                
                // Initialize camera and scanner (existing functionality)
                // This would integrate with your existing QR scanner code
            }
            
            selectCourse(courseCode) {
                // Select a course programmatically (e.g., from notifications)
                this.selectedCourse = courseCode;
                
                // Update course select dropdown
                const courseSelect = document.getElementById('scanner-course-select');
                if (courseSelect) {
                    courseSelect.value = courseCode;
                }
                
                // Update enhanced course options
                document.querySelectorAll('.course-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.courseCode === courseCode) {
                        opt.classList.add('selected');
                    }
                });
                
                // Update displays
                this.updateQRStatus();
                this.updateCourseInfo();
                
                // Show the QR scanner section
                const scannerSection = document.getElementById('qrcodescanner');
                if (scannerSection) {
                    scannerSection.style.display = 'block';
                }
                
                // Scroll to scanner section
                scannerSection?.scrollIntoView({ behavior: 'smooth' });
            }
            
            startStatusUpdates() {
                // Update status every 30 seconds
                setInterval(() => {
                    this.loadCourseSessions();
                    if (this.selectedCourse) {
                        this.updateQRStatus();
                    }
                }, 30000);
            }
        }
        
        // Initialize enhanced QR manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize existing functionality
            initializeStudentInterface();
            
            // Initialize enhanced QR manager
            window.enhancedQRManager = new EnhancedQRManager();
        });

        // Real-time notification system for new QR codes
        class SessionNotificationManager {
            constructor() {
                this.notifications = [];
                this.init();
            }
            
            init() {
                this.setupNotificationListener();
                this.createNotificationContainer();
                this.checkForNewSessions();
            }
            
            setupNotificationListener() {
                // Listen for storage changes (new sessions from lecturer)
                window.addEventListener('storage', (e) => {
                    if (e.key === 'courseSessions') {
                        this.handleSessionUpdate();
                    } else if (e.key === 'sessionNotification') {
                        this.handleNewSessionNotification();
                    }
                });
                
                // Also listen for local events
                window.addEventListener('storage', (e) => {
                    if (e.key === 'courseSessions') {
                        this.handleSessionUpdate();
                    }
                });
            }
            
            createNotificationContainer() {
                // Create notification container if it doesn't exist
                if (!document.getElementById('notification-container')) {
                    const container = document.createElement('div');
                    container.id = 'notification-container';
                    container.className = 'notification-container';
                    document.body.appendChild(container);
                }
            }
            
            handleSessionUpdate() {
                // Reload course sessions and check for new ones
                if (window.enhancedQRManager) {
                    window.enhancedQRManager.loadCourseSessions();
                }
            }
            
            handleNewSessionNotification() {
                try {
                    const notification = JSON.parse(localStorage.getItem('sessionNotification'));
                    if (notification && notification.type === 'newSession') {
                        this.showNewSessionNotification(notification);
                    }
                } catch (e) {
                    console.warn('Failed to parse session notification:', e);
                }
            }
            
            showNewSessionNotification(notification) {
                const container = document.getElementById('notification-container');
                if (!container) return;
                
                const notificationElement = document.createElement('div');
                notificationElement.className = 'session-notification new-session';
                notificationElement.innerHTML = `
                    <div class="notification-content">
                        <div class="notification-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <div class="notification-text">
                            <h6>New QR Code Available!</h6>
                            <p>A new attendance QR code is now available for ${notification.courseCode}</p>
                            <small>Session ID: ${notification.sessionId}</small>
                        </div>
                        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notification-actions">
                        <button class="btn-scan-now" onclick="window.enhancedQRManager.startScanning('${notification.courseCode}')">
                            Scan Now
                        </button>
                        <button class="btn-view-course" onclick="window.enhancedQRManager.selectCourse('${notification.courseCode}')">
                            View Course
                        </button>
                    </div>
                `;
                
                container.appendChild(notificationElement);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (notificationElement.parentElement) {
                        notificationElement.remove();
                    }
                }, 10000);
                
                // Play notification sound (optional)
                this.playNotificationSound();
            }
            
            checkForNewSessions() {
                // Check for new sessions every 30 seconds
                setInterval(() => {
                    this.checkForNewSessionsPeriodically();
                }, 30000);
            }
            
            checkForNewSessionsPeriodically() {
                try {
                    const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                    const activeSessions = courseSessions.filter(s => 
                        s.status === 'active' && 
                        new Date(s.createdTime) > new Date(Date.now() - 60000) // Created in last minute
                    );
                    
                    activeSessions.forEach(session => {
                        // Check if we've already notified about this session
                        if (!this.notifications.includes(session.sessionId)) {
                            this.notifications.push(session.sessionId);
                            this.showNewSessionNotification({
                                type: 'newSession',
                                courseCode: session.courseCode,
                                sessionId: session.sessionId,
                                timestamp: session.createdTime
                            });
                        }
                    });
                } catch (e) {
                    console.warn('Failed to check for new sessions:', e);
                }
            }
            
            playNotificationSound() {
                // Optional: Play a notification sound
                // This could be enhanced with actual audio files
                console.log('Notification sound played');
            }
        }
        
        // Initialize notification manager when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize existing functionality
            initializeStudentInterface();
            
            // Initialize enhanced QR manager
            window.enhancedQRManager = new EnhancedQRManager();
            
            // Initialize notification manager
            window.sessionNotificationManager = new SessionNotificationManager();
        });

        // Show notification message
        function showNotification(message, type = 'info') {
            // Remove existing notification if any
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                    <button class="notification-close">&times;</button>
                </div>
            `;
            
            // Add to body
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideNotification(notification);
            }, 5000);
            
            // Close button functionality
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                hideNotification(notification);
            });
        }

        // Hide notification
        function hideNotification(notification) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }

        // Mobile sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sidebar-toggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar2');
                sidebar.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            });
            
            document.getElementById('sidebar-close').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar2');
                sidebar.classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
            });
            
            // Close sidebar when clicking outside
            document.getElementById('sidebar2').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
            
            // Close sidebar when any nav item inside it is clicked (small screens)
            document.querySelectorAll('#sidebar2 .student-nav-item').forEach(function(navItem) {
                navItem.addEventListener('click', function() {
                    const sidebar = document.getElementById('sidebar2');
                    sidebar.classList.remove('active');
                    document.body.style.overflow = '';
                });
            });

            // Close sidebar on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const sidebar = document.getElementById('sidebar2');
                    if (sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
            });
        });

    </script>
</body>
</html>